<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <title>CRS Score</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- PWA / Manifest -->
  <link rel="manifest" href="manifest.json?v=4.120">
  <meta name="theme-color" content="#000000">

  <!-- iOS specifico (iPhone / iPad) -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <link rel="apple-touch-icon" href="crs-icon.png">
  <link rel="icon" href="crs-icon.png" type="image/png">

  <style>
  :root {
    --coyote-red:#CC0000;
    --coyote-yellow:#FDE000;
    --bg-dark:#000000;
    --bg-card:#ffffff;
    --text-main:#111827;
  }

  * { box-sizing:border-box; }

  /* iOS Safari fix: evita "barra bianca" causata da 100vh (viewport statico) */
  html, body {
    min-height: 100dvh;
  }
  @supports (-webkit-touch-callout: none) {
    html, body {
      height: -webkit-fill-available;
    }
  }

  /* ACCESSIBILITÀ: evidenziazione focus tastiera */
  :focus-visible {
    outline: 2px solid var(--coyote-yellow);
    outline-offset: 2px;
  }
  button:focus-visible,
  .home-btn:focus-visible,
  .btn:focus-visible,
  .participant-row:focus-visible,
  .test-tab:focus-visible {
    outline: 2px solid var(--coyote-yellow);
    outline-offset: 2px;
  }


  
@media (max-width: 360px) {
  body {
    padding: 12px;
  }
  /* ANIMAZIONI LEGGERE COERENTI */
  @keyframes fadeInUp {
    from { opacity: 0; transform: translateY(8px); }
    to   { opacity: 1; transform: translateY(0); }
  }

  @keyframes fadeInSoft {
    from { opacity: 0; }
    to   { opacity: 1; }
  }

  .fade-in-up {
    animation: fadeInUp 0.28s ease-out;
  }

  .fade-in-soft {
    animation: fadeInSoft 0.22s ease-out;
  }

  .container {
    padding: 12px;
    border-radius: 12px;
  }
  .home-box {
    margin-top: 24px;
    padding: 20px 16px;
    border-radius: 24px;
  }
  .home-btn {
    font-size: 18px;
    padding: 10px 14px;
  }
  #home-account-pill {
    font-size: 18px;
    padding: 6px 12px;
  }
  .btn {
    font-size: 18px;
    padding: 10px 12px;
  }
  #test-inputs input {
    padding: 14px;
    font-size: 14px;
  }
  #test-calc-btn,
  #test-reset-btn {
    padding: 18px;
    font-size: 18px;
  }
  .race-pill-value {
    font-size: 18px;
  }
  #test-scenario-display { color: var(--coyote-red); }

  li {
    font-size: 18px;
  }
}


@media (prefers-reduced-motion: reduce) {
  * {
    scroll-behavior:auto !important;
    animation-duration:0.01ms !important;
    animation-iteration-count:1 !important;
    transition:none !important;
  }
}

body {
    font-family: system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
    background:#000 url("bg-track.jpg") center / cover no-repeat;
    margin:0;
    padding:20px;
    -webkit-font-smoothing: antialiased;
  }

  /* LOADING SCREEN */
  #loading-screen {
    position:fixed;
    inset:0;
    display:flex;
    justify-content:center;
    align-items:center;
    background:#000;
    z-index:9999;
  }

  .bike-wheel{
    width:72px;
    height:72px;
    display:flex;
    align-items:center;
    justify-content:center;
    color:#fff;
  }
  .bike-wheel-svg{
    width:72px;
    height:72px;
    animation:bikeSpin 0.8s linear infinite;
  }
  @keyframes bikeSpin{
    from{ transform:rotate(0deg); }
    to{ transform:rotate(360deg); }
  }
  #loading-dots {
    display:inline-block;
    width:24px;
    text-align:left;
  }

  /* BIKERS LOADING POPUP */
  #bikers-loading-overlay {
    position:fixed;
    inset:0;
    display:none;
    align-items:center;
    justify-content:center;
    background:rgba(0,0,0,0.6);
    z-index:9998;
  }
  .bikers-loading-box {
    background:transparent;
    padding:0;
    border-radius:0;
    box-shadow:none;
  }
  #bikers-loading-dots {
    display:inline-block;
    width:24px;
    text-align:left;
  }

  /* AUTH OVERLAY */
  #auth-overlay {
    position:fixed;
    inset:0;
    background:rgba(0,0,0,0.9);
    display:none;
    align-items:center;
    justify-content:center;
    z-index:10000;
  }
  .auth-card {
    width:100%;
    max-width:380px;
    background:#111827;
    border-radius:20px;
    padding:24px 20px 20px;
    box-shadow:0 10px 25px rgba(0,0,0,0.4);
    color:#F9FAFB;
  }
  .auth-title {
    font-size:22px;
    font-weight:800;
    margin-bottom:4px;
    text-align:center;
  }
  .auth-subtitle {
    font-size:12px;
    color:#9CA3AF;
    text-align:center;
    margin-bottom:16px;
  }
  .auth-toggle-row {
    display:flex;
    gap:8px;
    margin-bottom:12px;
  }
  .auth-toggle-btn {
    flex:1;
    padding:12px;
    border-radius:999px;
    border:1px solid #4B5563;
    background:#111827;
    color:#E5E7EB;
    font-size:18px;
    font-weight:700;
    cursor:pointer;
    transition:background 0.15s ease, color 0.15s ease, border-color 0.15s ease, transform 0.08s ease, box-shadow 0.12s ease;
    box-shadow:0 4px 10px rgba(0,0,0,0.35);
  }
  .auth-toggle-btn.active {
    background:var(--coyote-yellow);
    color:#111827;
    border-color:var(--coyote-yellow);
  }
  .auth-toggle-btn:active { transform:scale(0.97); }
  .auth-field { margin-bottom:10px; }
  .auth-field label {
    display:block;
    font-size:12px;
    margin-bottom:4px;
    color:#E5E7EB;
  }
  .auth-field input {
    width:100%;
    padding:10px;
    border-radius:10px;
    border:1px solid #4B5563;
    background:#020617;
    color:#F9FAFB;
    font-size:20px;
  }
  .auth-field input::placeholder { color:#6B7280; }
  .auth-button {
    width:100%;
    margin-top:14px;
    padding:16px;
    border-radius:999px;
    border:none;
    background:var(--coyote-red);
    color:#fff;
    font-weight:700;
    font-size:20px;
    cursor:pointer;
    transition:transform 0.08s ease, opacity 0.12s ease, box-shadow 0.12s ease;
    box-shadow:0 4px 12px rgba(204,0,0,0.45);
  }
  .auth-button:active { transform:scale(0.97); box-shadow:none; }
  .auth-error {
    margin-top:8px;
    font-size:12px;
    color:#F97316;
    min-height:16px;
  }

  /* MAIN APP CONTAINER */
  .container {
    max-width:480px;
    margin:0 auto;
    background:var(--bg-card);
    padding:16px;
    border-radius:14px;
    box-shadow:0 4px 16px rgba(0,0,0,0.25);
    opacity:0;
    transition:opacity 0.25s ease;
  }

  /* TRANSIZIONI TRA LE VIEW PRINCIPALI */
  .view-section {
    opacity:0;
    transform:translateY(10px);
    transition:opacity 0.22s ease-out, transform 0.22s ease-out;
  }
  .view-section.active-view {
    opacity:1;
    transform:translateY(0);
  }


  /* CLASSIFICA – GRAFICA “RACING” */
  .ranking {
    background: radial-gradient(circle at top, #111 0, #111827 45%, #000 100%);
    padding:12px;
    border-radius:16px;
    margin-bottom:18px;
    border:1px solid var(--coyote-yellow);
    box-shadow:0 0 10px rgba(253,224,0,0.4);
    color:#F9FAFB;
    animation: fadeInSoft 0.28s ease-out;
  }

  .ranking-header { margin-bottom:8px; }

  .race-pills-row {
    display:flex;
    gap:8px;
    justify-content:space-between;
    margin-bottom:4px;
  }

  .race-pill {
    flex:1;
    max-width:160px;
    background:rgba(15,23,42,0.95);
    border-radius:999px;
    padding:6px 10px;
    border:1px solid rgba(253,224,0,0.5);
    box-shadow:0 0 6px rgba(253,224,0,0.3);
    display:flex;
    flex-direction:column;
    align-items:center;
    justify-content:space-between;
  }

  .race-pill-label {
    font-size:10px;
    text-transform:uppercase;
    letter-spacing:0.08em;
    opacity:0.85;
  }

  .race-pill-value {
    font-size:20px;
    font-weight:700;
    margin-top:2px;
  }

  .race-top-row {
  background: transparent !important;
  border: none !important;
  box-shadow: none !important;
}
  .race-date {
    width:100%;
    text-align:center;
    font-weight:700;
    white-space:normal;
  }

  ol { margin:0; padding-left:0; list-style:none; }

  li {
    margin:4px 0;
    padding:8px 10px;
    border-radius:10px;
    display:flex;
    justify-content:space-between;
    align-items:center;
    font-size:20px;
    position:relative;
    box-shadow:0 2px 4px rgba(0,0,0,0.25);
  }

  li:nth-child(1){ background:rgba(253,224,0,0.18); border:1px solid rgba(253,224,0,0.7);}
  li:nth-child(2){ background:rgba(248,113,113,0.16); border:1px solid rgba(248,113,113,0.5);}
  li:nth-child(3){ background:rgba(148,163,184,0.18); border:1px solid rgba(148,163,184,0.5);}
  li:nth-child(n+4){ background:rgba(15,23,42,0.6); border:1px solid rgba(30,64,175,0.4); }
  li::before {
    content:"";
    position:absolute;
    left:0;
    top:4px;
    bottom:4px;
    width:4px;
    border-radius:10px;
    background:#1d4ed8;
    opacity:0.9;
  }

  li:nth-child(1)::before {
    background:#facc15; /* oro */
  }
  li:nth-child(2)::before {
    background:#f97316; /* arancio */
  }
  li:nth-child(3)::before {
    background:#9ca3af; /* argento scuro */
  }


  .result-left {
    display:flex;
    flex-direction:column;
    gap:4px;
    flex:1;
    min-width:0;
  }

  .result-topline {
    display:flex;
    align-items:baseline;
    gap:6px;
    width:100%;
  }

  .position-number {
    font-size:24px;
    font-weight:900;
    line-height:1;
    min-width:28px;
  }

  .result-name {
    font-weight:700;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }

  .battery-row {
    display:flex;
    align-items:center;
    gap:8px;
  }

  .result-right {
    display:flex;
    flex-direction:column;
    align-items:flex-end;
    justify-content:space-between;
    gap:4px;
    margin-left:8px;
  }

  .right-topline {
    display:flex;
    align-items:center;
    gap:6px;
  }

  .medal { font-size:26px; line-height:1; }

  .result-score {
    font-weight:900;
    font-size:22px;
    white-space:nowrap;
    line-height:24px;
    margin-top: 3px;
    padding:4px 10px;
    border-radius:999px;
    background:rgba(15,23,42,0.9);
    border:1px solid rgba(248,250,252,0.3);
    box-shadow:0 0 6px rgba(0,0,0,0.5);
  }

  /* BATTERIA */
  .battery {
    width:130px;
    height:24px;
    border-radius:5px;
    border:2px solid #e5e7eb;
    position:relative;
    padding:3px;
    display:flex;
    align-items:center;
    background:rgba(15,23,42,0.9);
    overflow:hidden;
  }
  .battery::after {
    content:"";
    position:absolute;
    right:-7px;
    top:50%;
    transform:translateY(-50%);
    width:6px;
    height:12px;
    border-radius:2px;
    background:#e5e7eb;
  }
  .battery-level {
    height:100%;
    border-radius:3px;
    width:0%;
    background-color:#22c55e;
    transition:width 0.4s ease-out;
  }
  .battery-percent-label {
    position:absolute;
    left:50%;
    top:50%;
    transform:translate(-50%,-50%);
    font-size:11px;
    font-weight:700;
    color:#f9fafb;
    text-shadow:0 0 4px rgba(0,0,0,0.7);
    pointer-events:none;
  }

  .player-card {
    background:#f9fafb;
    padding:10px;
    border-radius:12px;
    margin-bottom:10px;
    border:1px solid #ddd;
    animation: fadeInUp 0.22s ease-out;
  }

  .player-title {
    font-weight:700;
    margin-bottom:8px;
    display:flex;
    justify-content:space-between;
    align-items:center;
  }

  .delete-biker {
    background:none;
    border:none;
    color:#dc2626;
    font-weight:bold;
    cursor:pointer;
    font-size:20px;
  }

  #db-container input,
  #players-container input,
  #race-info-container input {
    display:block;
    width:100%;
    max-width:100%;
    box-sizing:border-box;
    padding:8px;
    border-radius:6px;
    border:1px solid #ccc;
    font-size:20px;
    margin-bottom:4px;
  }

  /* LISTA BIKERS (vista database semplificata) */
  .biker-list {
    display:flex;
    flex-direction:column;
    gap:8px;
    margin-top:8px;
  }
  .biker-list-empty {
    font-size:14px;
    color:#6b7280;
    text-align:center;
    margin-top:8px;
  }
  .biker-list-item {
    width:100%;
    text-align:left;
    padding:10px 12px;
    border-radius:999px;
    border:1px solid #e5e7eb;
    background:#f9fafb;
    font-size:16px;
    font-weight:600;
    cursor:pointer;
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:8px;
    transition:background 0.12s ease, box-shadow 0.12s ease, transform 0.06s ease;
  }
  .biker-list-item span.biker-initial {
    width:26px;
    height:26px;
    border-radius:999px;
    background:#111827;
    color:#f9fafb;
    display:flex;
    align-items:center;
    justify-content:center;
    font-size:14px;
    font-weight:700;
  }
  .biker-list-item:hover {
    background:#e5e7eb;
    box-shadow:0 2px 8px rgba(0,0,0,0.08);
  }
  .biker-list-item:active {
    transform:scale(0.98);
    box-shadow:none;
  }

  .db-buttons-inline {
    display:flex;
    justify-content:center;
    gap:10px;
    margin-top:14px;
  }

  /* MODALE GESTIONE BIKER */
  #biker-modal-overlay {
    position:fixed;
    inset:0;
    background:rgba(0,0,0,0.7);
    display:none;
    align-items:center;
    justify-content:center;
    z-index:10001;
  }

  #account-overlay{
    position:fixed;
    inset:0;
    background:rgba(0,0,0,0.7);
    display:none;
    align-items:center;
    justify-content:center;
    z-index:10002;
  }
  .account-modal{
    width:100%;
    max-width:380px;
    background:#f9fafb;
    border-radius:20px;
    padding:18px 16px 14px;
    box-shadow:0 14px 30px rgba(0,0,0,0.45);
    position:relative;
  }
  .account-modal h2{
    margin:0 0 4px 0;
    font-size:20px;
    text-align:center;
  }
  .account-modal .sub{
    margin:0 0 12px 0;
    text-align:center;
    opacity:0.75;
    font-size:13px;
  }
  .account-modal .row{
    display:flex;
    gap:10px;
    justify-content:center;
    align-items:center;
    margin-top:10px;
  }
  .account-modal button{
    border:none;
    border-radius:999px;
    padding:10px 14px;
    font-weight:800;
    font-size:14px;
    cursor:pointer;
  }
  #account-logout-btn{
    background:#c00000;
    color:#fff;
  }
  #account-change-password-btn{
    background:#111;
    color:#fff;
  }
  #account-close-btn{
    position:absolute;
    top:10px;
    right:12px;
    width:34px;
    height:34px;
    border-radius:999px;
    background:rgba(0,0,0,0.08);
    color:#111;
    font-size:22px;
    line-height:34px;
    padding:0;
    font-weight:900;
  }
  #change-password-panel{
    margin-top:14px;
    padding-top:12px;
    border-top:1px solid rgba(0,0,0,0.12);
    display:none;
  }
  .cp-field{
    margin:10px 0;
  }
  .cp-field label{
    display:block;
    font-size:12px;
    font-weight:700;
    margin-bottom:6px;
    opacity:0.8;
  }
  .cp-field input{
    width:100%;
    padding:10px 12px;
    border-radius:12px;
    border:1px solid rgba(0,0,0,0.18);
    font-size:14px;
  }
  #account-save-password-btn{
    background:#1a7f37;
    color:#fff;
  }
  #account-future-btn{
    background:var(--coyote-red);
    font-size:18px;
    width:44px;
    height:44px;
    border-radius:12px;
    display:flex;
    align-items:center;
    justify-content:center;
    line-height:1;
    color:#fff;
    opacity:0.95;
    cursor:pointer;
  }
  #account-msg{
    margin-top:10px;
    text-align:center;
    font-size:13px;
    font-weight:700;
    min-height:18px;
  }
  .biker-modal {
    width:100%;
    max-width:360px;
    background:#f9fafb;
    border-radius:20px;
    padding:18px 16px 14px;
    box-shadow:0 14px 30px rgba(0,0,0,0.45);
  }
  .biker-modal-title {
    font-size:18px;
    font-weight:800;
    margin:0 0 4px;
    color:#111827;
    text-align:center;
  }
  .biker-modal-subtitle {
    font-size:12px;
    color:#6b7280;
    text-align:center;
    margin:0 0 10px;
  }
  .biker-modal-field {
    margin-bottom:8px;
  }
  .biker-modal-field label {
    display:block;
    font-size:12px;
    color:#374151;
    margin-bottom:2px;
  }
  .biker-modal-field input {
    width:100%;
    box-sizing:border-box;
    padding:8px;
    border-radius:10px;
    border:1px solid #d1d5db;
    font-size:16px;
  }
  .biker-modal-actions {
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap:8px;
    margin-top:10px;
  }
  .biker-modal-actions-left {
    display:flex;
    gap:8px;
  }
  .biker-modal-btn {
    flex:1;
    padding:9px 10px;
    border-radius:999px;
    border:none;
    font-size:14px;
    font-weight:700;
    cursor:pointer;
    transition:transform 0.06s ease, box-shadow 0.12s ease, background 0.12s ease;
  }
  .biker-modal-btn:active {
    transform:scale(0.97);
    box-shadow:none;
  }
  .biker-modal-btn-primary {
    background:var(--coyote-yellow);
    color:#111827;
    box-shadow:0 4px 10px rgba(253,224,71,0.4);
  }
  .biker-modal-btn-secondary {
    background:#e5e7eb;
    color:#111827;
  }
  .biker-modal-btn-danger {
    background:#fee2e2;
    color:#b91c1c;
  }

  /* STILE BARRA DATA NELLA PAGINA GARA */
  #race-date-input {
  -webkit-appearance: none;
  appearance: none;

  display: block;
  width: 100%;
  box-sizing: border-box;

  background: #e5e7eb;
  border-radius: 18px;
  border: 2px solid #ffffff;

  text-align: center;
  font-weight: 700;
  font-size: 16px;
  line-height: normal;

  padding: 14px 0;
  min-height: 50px;
}

  #race-date-input::-webkit-datetime-edit {
    text-align:center;
    padding:0;
  }
  #race-date-input::-webkit-datetime-edit-fields-wrapper {
    text-align:center;
  }


  /* SELEZIONE BIKERS – STILE RACING */
  .participant-row {
    display:flex;
    align-items:center;
    justify-content:space-between;
    padding:10px 12px;
    border-radius:14px;
    background:#f9fafb;
    margin-bottom:8px;
    border:1px solid #e5e7eb;
    cursor:pointer;
    position:relative;
    overflow:hidden;
    transition:background 0.15s ease, transform 0.08s ease, box-shadow 0.15s ease, border-color 0.15s ease;
  }

  .participant-row::before {
    content:"";
    position:absolute;
    left:0;
    top:0;
    bottom:0;
    width:4px;
    background:var(--coyote-red);
    opacity:0.7;
    transition:background 0.15s ease, opacity 0.15s ease;
  }

  .participant-row:active {
    transform:scale(0.98);
  }

  .participant-row.selected {
    background:#0f172a;
    border-color:#16a34a;
    box-shadow:0 6px 18px rgba(0,0,0,0.3);
    transform:translateY(-1px);
  }

  .participant-row.selected::before {
    background:var(--coyote-yellow);
    opacity:1;
  }

  .participant-main {
    display:flex;
    align-items:center;
    gap:10px;
  }

  .participant-avatar {
    width:32px;
    height:32px;
    border-radius:999px;
    background:#111827;
    display:flex;
    align-items:center;
    justify-content:center;
    font-weight:800;
    font-size:14px;
    color:var(--coyote-yellow);
    box-shadow:0 0 0 2px #111827, 0 0 8px rgba(0,0,0,0.4);
  }

  .participant-row.selected .participant-avatar {
    background:var(--coyote-red);
    color:#ffffff;
    box-shadow:0 0 0 2px #7f1d1d, 0 0 10px rgba(248,113,113,0.8);
  }

  .participant-text {
    display:flex;
    flex-direction:column;
    gap:2px;
  }

  .participant-name {
    font-weight:700;
    font-size:14px;
    color:#111827;
  }

  .participant-row.selected .participant-name {
    color:#f9fafb;
  }

  .participant-meta {
    font-size:11px;
    color:#6b7280;
  }

  .participant-row.selected .participant-meta {
    color:#e5e7eb;
  }


  /* BOTTONI */
  .buttons {
    display:flex;
    flex-direction:column;
    gap:8px;
    margin-top:12px;
  }
  .btn {
    display:block;
    width:100%;
    padding:16px;
    border-radius:999px;
    border:none;
    font-weight:700;
    font-size:20px;
    cursor:pointer;
    transition:transform 0.08s ease, opacity 0.12s ease, box-shadow 0.12s ease;
    box-shadow:0 4px 12px rgba(0,0,0,0.25);
    animation: fadeInUp 0.25s ease-out;
  }
  .btn:active { transform:scale(0.97); box-shadow:none; }

  #btn-db     { background:var(--coyote-yellow); color:#111; }
  #btn-select { background:var(--coyote-red); color:#fff; }
  #btn-gara   { background:var(--coyote-red); color:#fff; }
  #calc-btn   { background:var(--coyote-red); color:#fff; }
  #btn-reset  { background:#6b7280; color:#fff; }
  #save-race-button { background:var(--coyote-red); color:#fff; }

  .db-buttons-inline {
    display:flex;
    gap:8px;
    margin-top:4px;
  }
  .btn-small {
    flex:1;
    padding:14px;
    border-radius:999px;
    border:none;
    font-size:18px;
    font-weight:700;
    cursor:pointer;
    transition:transform 0.08s ease, opacity 0.12s ease, box-shadow 0.12s ease;
    box-shadow:0 3px 10px rgba(0,0,0,0.25);
  }
  .btn-small:active { transform:scale(0.97); box-shadow:none; }
  .btn-db-add   { background:var(--coyote-red); color:#ffffff; }
  .btn-db-save  { background:var(--coyote-yellow); color:#111; }

  /* MENU ICON & ACCOUNT BADGE */
  #header-right {
    display:flex;
    flex-direction:column;
    align-items:flex-end;
    gap:6px;
  }
  #menu-icon {
    width:32px;
    height:24px;
    cursor:pointer;
    display:flex;
    flex-direction:column;
    justify-content:space-between;
  }
  .menu-line { width:32px; height:4px; background:#CC0000;
    border-radius:3px;
  }
  #account-badge {
    font-size:10px;
    padding:4px 8px;
    border-radius:999px;
    background:#111827;
    color:#F9FAFB;
    border:1px solid #4B5563;
    cursor:pointer;
    max-width:120px;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }

  /* HOME VIEW */
  #home-view {
    display:flex;
    flex-direction:column;
    align-items:center;
    justify-content:flex-start;
    margin-top:8px;
    margin-bottom:16px;
  }

  #home-account-pill {
    background:var(--coyote-red);
    color:#ffffff;
    padding:8px 16px;
    border-radius:999px;
    font-weight:700;
    font-size:20px;
    margin-bottom:8px;
    max-width:80%;
    text-align:center;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }

  .home-box {
    margin-top: 40px;
    background:var(--coyote-yellow);
    border-radius:30px;
    padding:28px 22px;
    width:100%;
    max-width:420px;
    display:flex;
    flex-direction:column;
    gap:16px;
    animation: fadeInUp 0.3s ease-out;
  }

  .home-btn {
    display:block;
    width:100%;
    background:var(--coyote-red);
    color:#ffffff;
    padding:16px;
    font-size:20px;
    text-align:center;
    border-radius:999px;
    border:none;
    font-weight:700;
    cursor:pointer;
    transition:transform 0.08s ease, opacity 0.12s ease, box-shadow 0.12s ease;
    box-shadow:0 4px 12px rgba(0,0,0,0.25);
  }
  .home-btn:active { transform:scale(0.97); box-shadow:none; }

  /* COLORI SPECIFICI BOTTONI HOME */
  #home-btn-race {
    background: var(--coyote-red);
    border-color: var(--coyote-red);
    color:#ffffff;
  }
  #home-btn-performance {
    background:#16a34a;
    border-color:#16a34a;
    color:#ffffff;
  }
  #home-btn-test {
    background:#0284c7;
    border-color:#0284c7;
    color:#ffffff;
  }
  #home-btn-bikers {
    background:#111827;
    border-color:#111827;
    color:#ffffff;
  }
  #home-btn-account {
    background:#4f46e5;
    border-color:#4f46e5;
    color:#ffffff;
  }

  /* TEST VIEW: box nero più alto */
  #test-ranking-box {
    padding:24px;
  }


  /* Hide app container in home view */
  body.home-mode .container { display:none; }

  /* TEST VIEW */
  #test-inputs {
    margin-top:12px;
    background:#f9fafb;
    border-radius:12px;
    padding:10px;
    border:1px solid #e5e7eb;
    animation: fadeInUp 0.25s ease-out;
  }
  .test-tabs {
    display:flex;
    gap:6px;
    margin-bottom:8px;
  }
  .test-tab {
    flex:1;
    padding:10px;
    border-radius:999px;
    border:1px solid var(--coyote-yellow);
    background:#fef9c3;
    font-size:20px;
    font-weight:700;
    cursor:pointer;
    color:#111827;
    transition:background 0.15s ease, color 0.15s ease, transform 0.08s ease;
  }
  .test-tab:active { transform:scale(0.97); }
  .test-tab.active {
    background:var(--coyote-yellow);
    color:#111827;
    border-color:var(--coyote-yellow);
  }
  .test-tab-icon {
    display:block;
    font-size:24px;
    line-height:1;
  }
  .test-tab-contents { margin-top:4px; }
  .test-tab-content { display:none; }
  .test-tab-content.active { display:block; }
  #test-inputs input {
    width:100%;
    padding:20px;
    border-radius:8px;
    border:1px solid #d1d5db;
    font-size:16px;
    font-weight:700;
    box-sizing:border-box;
  }
  #test-calc-btn, #test-reset-btn {
    margin-top:10px;
    width:100%;
    padding:20px;
    border-radius:999px;
    border:none;
    font-weight:700;
    font-size:20px;
    cursor:pointer;
    transition:transform 0.08s ease, opacity 0.12s ease, box-shadow 0.12s ease;
    box-shadow:0 4px 12px rgba(0,0,0,0.25);
  }
  #test-calc-btn { background:#16a34a; color:#fff; }
  #test-reset-btn { background:#dc2626; color:#fff; }
  #test-calc-btn:active, #test-reset-btn:active { transform:scale(0.97); }

  #test-view .race-pills-row { justify-content:center; }
  #test-view .race-pill { max-width:none; min-width:200px; text-align:center; }
  #test-view .race-pill-value { font-size:24px; font-weight:800; }

  /* Pillole valori Test Algoritmo sotto la batteria */
  .test-data-pills {
    display:flex;
    gap:6px;
    margin-top:6px;
    flex-wrap:wrap;
  }
  .test-data-pill {
    flex:1;
    padding: 16px 8px;
    border-radius:999px;
    text-align:center;
    background:#020617;
    color:var(--coyote-red);
    font-size:14px;
    font-weight:700;
    border:1px solid rgba(248,113,113,0.7);
    box-shadow:0 0 4px rgba(0,0,0,0.5);
  }

  
/* ===== BUILD 4.120 – CALENDARIO GARE: giorni con gara in ROSSO ===== */
#race-calendar button.has-race{
  background: #cc0000 !important;
  color: #ffffff !important;
  border: 1px solid rgba(255,255,255,0.28) !important;
  box-shadow: 0 10px 22px rgba(0,0,0,0.30) !important;
}
#race-calendar button.has-race:active{
  transform: scale(0.98);
}

/* CALENDARIO PERFORMANCE COME POPUP GRANDE */
  #race-calendar {
    position:fixed;
    top:50%;
    left:50%;
    transform:translate(-50%, -50%);
    z-index:9998;
    width:calc(100% - 80px);
    max-width:480px;
  }

  /* HEADER GARA SPECIFICA (CHIARO) */
  #performance-race-header {
    background:#fefce8;
    color:#111827;
    box-shadow:0 0 8px rgba(253,224,0,0.4);
  }
  #performance-race-header .race-pill {
    background:#f3f4f6;
    color:#111827;
    border:1px solid #e5e7eb;
    box-shadow:none;
  }
  #performance-race-header .race-pill-label,
  #performance-race-header .race-pill-value { color:#111827; }
  #performance-race-header .race-top-row {
  background: transparent !important;
  border: none !important;
  box-shadow: none !important;
}
  
/* Fix stronger centering for date input */
#race-date-input {
  text-align-last:center;
}

#race-date-input::-webkit-date-and-time-value {
  text-align: center;
  min-height: 100%;
  display: flex;
  align-items: center;
  justify-content: center;
}


/* CORREZIONE BARRA DATA — COMPLETAMENTE CENTRATA + BORDO BIANCO */

#race-date-display {
  color: #CC0000 !important;
  font-weight: 800;
  font-size: 16px;
  text-align: center !important;
  display: block;
}



#perf-race-date-display {
  color: #CC0000 !important;
  font-weight: 800;
  font-size: 16px;
  text-align: center !important;
  display: block;
  margin-top: 10px;
}

  #home-footer {
    margin-top: 16px;
    width: 100%;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 4px;
  }
  #version-label {
    font-size: 11px;
    color: var(--coyote-red);
    text-align: center;
    letter-spacing: 0.04em;
  }



  
  /* HOME – toggle suoni (discreto) */
  #home-sound-toggle{
    display:flex;
    align-items:center;
    justify-content:center;
    gap:10px;
    margin-top:2px;
    font-size:11px;
    color:#94a3b8;
    letter-spacing:0.02em;
    opacity:0.92;
    user-select:none;
  }
  #home-sound-toggle .st-label{ line-height:1; }
  #home-sound-toggle input{ display:none; }
  #home-sound-toggle .st-switch{
    width:38px; height:20px;
    border-radius:999px;
    background:rgba(148,163,184,0.35);
    border:1px solid rgba(148,163,184,0.55);
    position:relative;
    box-shadow: inset 0 0 0 1px rgba(0,0,0,0.15);
  }
  #home-sound-toggle .st-knob{
    position:absolute;
    top:2px; left:2px;
    width:16px; height:16px;
    border-radius:999px;
    background:#e5e7eb;
    box-shadow:0 2px 6px rgba(0,0,0,0.35);
    transition: transform 0.16s ease, background 0.16s ease;
  }
  #sounds-toggle:checked + .st-switch{
    background: rgba(250,204,21,0.35);
    border-color: rgba(250,204,21,0.75);
  }
  #sounds-toggle:checked + .st-switch .st-knob{
    transform: translateX(18px);
    background:#fff;
  }
/* TEST ALGORITMO – pillole dati, header e card risultato in grigio chiaro */
  #test-view .test-data-pill {
    background: #e5e7eb;
    color: var(--coyote-red);
    border: 1px solid #d1d5db;
    box-shadow: 0 0 4px rgba(0, 0, 0, 0.15);
  }

  /* MINI STATUS BAR TECNICA (Home) */
  #home-footer{ margin-top: 0; gap: 0; }
  #tech-status-bar{
    position: fixed;
    left: 50%;
    transform: translateX(-50%);
    bottom: 60px; /* alzata */
    width: min(560px, calc(100% - 28px));
    display: grid;
    grid-template-columns: 1fr auto 1fr;
    align-items: center;
    padding: 10px 12px;
    border-radius: 999px;
    background: rgba(17,24,39,0.72);
    border: 1px solid rgba(148,163,184,0.22);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    box-shadow: 0 14px 40px rgba(0,0,0,0.35);
    z-index: 9997;
  }
  #tech-status-bar .tsb-left{ justify-self: start; display:flex; align-items:center; }
  #tech-status-bar .tsb-center{ justify-self: center; display:flex; align-items:center; gap:12px; flex-wrap:wrap; }
  #tech-status-bar .tsb-right{ justify-self: end; display:flex; align-items:center; }
  .tsb-icon-btn{
    height: 34px;
    min-width: 44px;
    padding: 0 12px;
    border-radius: 999px;
    border: 1px solid rgba(148,163,184,0.25);
    background: rgba( 0,0,0,0.38);
    color: #f8fafc;
    font-weight: 900;
    cursor: pointer;
    line-height: 1;
  }

  /* HOME – tasti suoni/vibrazione (icone, senza testo) */
  .tsb-toggle-buttons{
    display:flex;
    align-items:center;
    justify-content:center;
    gap:10px;
  }
  .tsb-toggle-btn{
    width:44px;
    height:36px;
    display:flex;
    align-items:center;
    justify-content:center;
    border-radius:12px;
    border:1px solid rgba(148,163,184,0.55);
    background:rgba(148,163,184,0.20);
    box-shadow: inset 0 0 0 1px rgba(0,0,0,0.12);
  }
  .tsb-toggle-btn:active{
    transform: translateY(1px);
  }
  .tsb-toggle-btn .tsb-toggle-ico{
    font-size:20px; /* icona più grande */
    line-height:1;
    filter: drop-shadow(0 2px 6px rgba(0,0,0,0.25));
  }
  .tsb-toggle-btn .tsb-toggle-ico{ opacity:1; }
  .tsb-toggle-btn.is-off{
    opacity:0.78;
  }

  .tsb-icon-btn:active{ transform: scale(0.98); }
  .tsb-toggle-wrap{ display:flex; align-items:center; gap:8px; cursor:pointer; }
  #tech-status-bar #home-sound-toggle{
    margin-top:0;
    opacity:1;
    color:#cbd5e1;
    font-size: 11px;
  }
  #tech-status-bar #version-label{
    font-size: 11px;
    color: #facc15;
    letter-spacing: 0.04em;
    text-align: right;
  }

  @media (max-width: 360px){
    #tech-status-bar{ bottom: 44px; padding: 9px 10px; }
    .tsb-icon-btn{ min-width: 40px; height: 32px; padding: 0 10px; }
  }

  /* CONFRONTO – pillole larghe (no overflow testo) */
  #bp-compare-controls{
    display:flex;
    gap:12px;
    justify-content:center;
    align-items:center;
    flex-wrap:wrap;
    margin-top: 14px;
  }
  .bp-compare-btn{
    min-width: 170px;
    padding: 12px 22px;
    border-radius: 999px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }


  #test-view .ranking {
    background: #e5e7eb;
    border: 1px solid #d1d5db;
    box-shadow: 0 0 10px rgba(0, 0, 0, 0.20);
    color: #111827;
  }

  #test-view .ranking-header .race-pill {
    background: #f3f4f6;
    border: 1px solid #d1d5db;
    box-shadow: 0 0 4px rgba(0, 0, 0, 0.12);
    color: #111827;
  }

  #test-view .race-pill-value {
    color: #111827;
  }

  #test-ranking-box ol {
    margin: 0;
    padding-left: 0;
    list-style: none;
  }

  #test-ranking-box li {
    background: #f3f4f6;
    border: 1px solid #d1d5db;
    box-shadow: 0 0 4px rgba(0, 0, 0, 0.15);
  }

  #test-ranking-box li::before {
    background: transparent;
  }

  #test-ranking-box li:nth-child(1),
  #test-ranking-box li:nth-child(2),
  #test-ranking-box li:nth-child(3),
  #test-ranking-box li:nth-child(n+4) {
    background: #f3f4f6;
    border: 1px solid #d1d5db;
  }

  #test-view .position-number,
  #test-view .result-name,
  #test-view .battery-percent-label,
  #test-view .scenario-badge,
  #test-view .medal {
    color: #111827;
    text-shadow: none;
  }

  #test-view .result-score {
    background: #e5e7eb;
    color: #111827;
    border: 1px solid #d1d5db;
    box-shadow: 0 0 4px rgba(0, 0, 0, 0.15);
  }


  /* TEST ALGORITMO – percentuale batteria in bianco */
  #test-view .battery-percent-label {
    color: #ffffff !important;
    text-shadow: 0 0 4px rgba(0,0,0,0.7) !important;
  }


  /* POPUP LOADING PERFORMANCE */
  #loading-popup-overlay {
    position:fixed;
    inset:0;
    background:rgba(0,0,0,0.65);
    display:none;
    align-items:center;
    justify-content:center;
    z-index:10002;
  }
  .loading-popup {
    background:transparent;
    padding:0;
    border-radius:0;
    box-shadow:none;
    text-align:center;
  }
  .loading-popup-dots span {
    display:inline-block;
    animation:loadingDots 1s infinite;
  }
  .loading-popup-dots span:nth-child(2) {
    animation-delay:0.2s;
  }
  .loading-popup-dots span:nth-child(3) {
    animation-delay:0.4s;
  }
  @keyframes loadingDots {
    0%, 20% { opacity:0; }
    50%     { opacity:1; }
    100%    { opacity:0; }
  }

  #main-buttons { margin-top:100px; }
  #home-account-pill { margin-top:100px; }
  #app-version { margin-top:100px; }

  /* BIKERS PERFORMANCE VIEW */
  #bikers-performance-view {
    display:none;
    margin-top:16px;
  }
  .bp-header {
    text-align:center;
    font-weight:900;
    color:var(--coyote-red);
    margin:8px 0 10px;
    font-size:16px;
  }
  .bp-subtitle {
    text-align:center;
    font-size:12px;
    color:#374151;
    margin:0 0 10px;
  }
  .bp-list {
    display:flex;
    flex-direction:column;
    gap:8px;
    margin-top:10px;
  }
  .bp-item {
    width:100%;
    text-align:left;
    padding:12px 14px;
    border-radius:14px;
    border:1px solid #e5e7eb;
    background:#f9fafb;
    cursor:pointer;
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap:10px;
    box-shadow:0 2px 8px rgba(0,0,0,0.06);
    transition:transform 0.06s ease, box-shadow 0.12s ease, background 0.12s ease;
  }
  .bp-item:active { transform:scale(0.99); box-shadow:none; }
  .bp-name {
    font-weight:800;
    color:#111827;
    font-size:16px;
    overflow:hidden;
    white-space:nowrap;
    text-overflow:ellipsis;
  }
  .bp-score {
    font-weight:900;
    color:#111827;
    font-size:16px;
    background:#e5e7eb;
    border:1px solid #d1d5db;
    padding:6px 10px;
    border-radius:999px;
    white-space:nowrap;
  }
  .bp-back-row {
    display:flex;
    gap:10px;
    justify-content:center;
    margin-top:12px;
  }
  .bp-back-btn {
    width:100%;
    max-width:320px;
    padding:16px;
    border-radius:999px;
    border:none;
    font-weight:800;
    font-size:20px;
    cursor:pointer;
    background:#CC0000;
    color:#fff;
    box-shadow:0 4px 12px rgba(0,0,0,0.25);
  }
  .bp-back-btn:active { transform:scale(0.97); box-shadow:none; }

  .bp-history {
    margin-top:14px;
    background:#f3f4f6;
    border-radius:12px;
    padding:10px;
    border:1px solid #d1d5db;
  }
  .bp-history-title {
    font-weight:900;
    color:#111827;
    text-align:center;
    margin:4px 0 10px;
  }
  .bp-history-list {
    display:flex;
    flex-direction:column;
    gap:8px;
  }
  .bp-race-card {
    background:#ffffff;
    border:1px solid #e5e7eb;
    border-radius:12px;
    padding:10px;
    display:flex;
    justify-content:space-between;
    align-items:flex-start;
    gap:10px;
  }
  .bp-race-left {
    display:flex;
    flex-direction:column;
    gap:2px;
    min-width:0;
  }
  .bp-race-date {
    font-weight:900;
    color:var(--coyote-red);
    font-size:12px;
  }
  .bp-race-circuit {
    font-weight:800;
    color:#111827;
    font-size:14px;
    overflow:hidden;
    white-space:nowrap;
    text-overflow:ellipsis;
    max-width:220px;
  }
  .bp-race-meta {
    font-size:11px;
    color:#6b7280;
  }
  .bp-race-score {
    font-weight:900;
    font-size:16px;
    white-space:nowrap;
    padding:6px 10px;
    border-radius:999px;
    background:#e5e7eb;
    border:1px solid #d1d5db;
    color:#111827;
  }
  .bp-empty {
    text-align:center;
    color:#6b7280;
    font-size:12px;
    margin-top:10px;
  }


/* BP PROFILE ICONS – uniform, large, centered, single row */
.bp-icon-grid {
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 16px;
  margin: 24px auto;
  flex-wrap: nowrap;
}

.bp-icon-btn {
  width: 96px;
  height: 96px;
  border-radius: 24px;
  border: none;
  background: #111827;
  color: #ffffff;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 42px;
  box-shadow: 0 6px 16px rgba(0,0,0,0.35);
  cursor: pointer;
}

.bp-icon-btn:active {
  transform: scale(0.96);
  box-shadow: none;
}

.bp-icon {
  font-size: 42px;
  line-height: 1;
}


/* BP PROFILE TITLE */
.bp-profile-title {
  text-align: center;
  font-weight: 900;
  color: #CC0000;
  font-size: 18px;
  margin: 8px 0 16px;
}


/* FORCE BIKER NAME VISIBILITY */
.bp-profile-title {
  display: block;
  width: 100%;
  text-align: center;
  font-weight: 900;
  color: #CC0000;
  font-size: 20px;
  margin: 6px 0 18px;
}


/* Dynamic biker name title in personal performance pages */
#bp-dynamic-title {
  display: block;
  text-align: center;
  font-weight: 900;
  color: #CC0000;
  font-size: 18px;
  margin: 8px 0 16px;
}






#home-btn-bike-performance {
  background:#4f46e5;
  border-color:#4f46e5;
  color:#ffffff;
}


/* Biker name in personal performance view */
#bp-profile-title,
.bp-profile-title,
#bp-profile-name {
  text-align: center;
  font-weight: 900;
}


/* Biker name (personal performance card) */
#bp-profile-name,
#bp-profile-title,
.bp-profile-title {
  text-align: center;
  font-weight: 900;
  color: #cc0000;
  font-size: 20px;
  margin: 10px 0 16px;
}


/* Biker name as main title in personal performance card */
#bp-profile .bp-profile-name,
#bp-profile-name {
  text-align: center;
  font-weight: 900;
  color: #cc0000;
  font-size: 20px;
  margin: 10px 0 16px;
}


/* Biker name as ONLY title in profile */
#bp-profile-name,
.bp-profile-name {
  text-align: center;
  font-weight: 900;
  color: #cc0000;
  font-size: 20px;
  margin: 12px 0 18px;
}


.bp-return-row {
  display: flex;
  justify-content: center;
  margin: 20px 0 10px;
}
.bp-return-btn {
  width: 100%;
  max-width: 340px;
  padding: 18px;
  border-radius: 999px;
  border: none;
  background: #CC0000;
  color: #ffffff;
  font-weight: 900;
  font-size: 20px;
  cursor: pointer;
  box-shadow: 0 6px 16px rgba(0,0,0,0.3);
}
.bp-return-btn:active {
  transform: scale(0.97);
  box-shadow: none;
}


/* FORCE ACCOUNT PILL (HOME) */
#home-account-pill {
  background: var(--coyote-red) !important;
  color: #ffffff !important;
  border: none !important;
}


/* Icon popup overlay */
.icon-popup-overlay{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.62);
  display:flex;
  align-items:center;
  justify-content:center;
  z-index:20000;
  padding:18px;
}
.icon-popup{
  width:100%;
  max-width:420px;
  background:#FFF8C8; /* giallino */
  border-radius:18px;
  box-shadow:0 18px 50px rgba(0,0,0,0.45);
  overflow:hidden;
  border:1px solid rgba(17,24,39,0.12);
}
.icon-popup-header{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  padding:12px 12px;
  background:rgba(17,24,39,0.92);
  color:#fff;
}
#icon-popup-title{
  margin:0;
  font-size:14px;
  font-weight:900;
  line-height:1.1;
}
.icon-popup-close{
  width:36px;
  height:36px;
  border-radius:999px;
  border:none;
  background:rgba(255,255,255,0.14);
  color:#fff;
  font-weight:900;
  font-size:16px;
  cursor:pointer;
}
.icon-popup-close:active{ transform:scale(0.97); }
.icon-popup-content{
  padding:12px;
  color:#111827;
}
.hidden{ display:none !important; }


/* FIX: nasconde la pill account se vuota (evita "pillola bianca" in home) */
#home-account-pill:empty { display: none !important; }


/* HOME – forza pill account invisibile (nera su nero) */
#home-view #home-account-pill {
  background: #000000 !important;
  color: #000000 !important;
  box-shadow: none !important;
}


/* HOME – regola strutturale: se HOME è visibile, nascondi SEMPRE la container (evita "pillola/card" bianca) */
#home-view:not([style*="display: none"]) + .container,
#home-view:not([style*="display:none"]) + .container {
  display: none !important;
}

/* Quando HOME viene nascosta via JS (style display:none), riabilita la container */
#home-view[style*="display: none"] + .container,
#home-view[style*="display:none"] + .container {
  display: block !important;
}


/* Spazio tra numero classifica e icone */
.bp-rank-block,
.bp-rank-pos {
  margin-bottom: 30px !important;
}


/* ===== BUILD 4.120 – Account pill reposition ===== */
#account-pill, .account-pill {
  position: fixed !important;
  bottom: 84px !important;
  left: 50% !important;
  transform: translateX(-50%) !important;
  z-index: 9999 !important;
}



/* ===== BUILD 4.120 – HOME account pill inside yellow card ===== */
#home-account-pill{
  position: relative !important;
  left: auto !important;
  top: auto !important;
  bottom: auto !important;
  transform: none !important;

  margin: 12px auto 0 auto !important;
  display: inline-flex !important;
  align-items: center !important;
  gap: 10px !important;

  padding: 8px 14px !important;
  border-radius: 999px !important;
  background: var(--coyote-red, #e00) !important;
  color: #fff !important;
  box-shadow: 0 6px 14px rgba(0,0,0,0.25) !important;
}

/* wrapper inside yellow home card */
.home-yellow-card .home-account-pill-wrapper{
  display: flex;
  justify-content: center;
  width: 100%;
}


/* ===== BUILD 4.120 – HOME account pill sotto Bikers nel riquadro giallo ===== */
.home-account-pill-wrapper{
  width: 100%;
  display: flex;
  justify-content: center;
  margin-top: 12px;
}

#home-account-pill{
  position: relative !important;
  inset: auto !important;
  left: auto !important;
  top: auto !important;
  bottom: auto !important;
  transform: none !important;
  z-index: 10 !important;

  display: inline-flex !important;
  align-items: center !important;
  gap: 10px !important;

  padding: 10px 14px !important;
  border-radius: 999px !important;
  background: var(--coyote-red, #e00) !important;
  color: #fff !important;
  box-shadow: 0 8px 18px rgba(0,0,0,0.28) !important;
  user-select: none !important;
  cursor: pointer !important;
}

/* Override definitivo contro vecchie regole "nero su nero" */
#home-view #home-account-pill{
  background: var(--coyote-red, #e00) !important;
  color: #fff !important;
  box-shadow: 0 8px 18px rgba(0,0,0,0.28) !important;
}

#home-account-pill:empty{ display:none !important; }



/* ===== BUILD 4.120 – HOME account button same size as others (white bg, red text) ===== */
#home-account-pill{
  /* eredita tutto da button{} e .home-btn (width:100%, padding, radius, ecc.) */
  background: #ffffff !important;
  color: var(--coyote-red, #e00) !important;
  box-shadow: 0 4px 12px rgba(0,0,0,0.18) !important;
}

/* se vuoi un bordo leggero per staccare dal giallo */
#home-account-pill{
  border: 2px solid rgba(0,0,0,0.08) !important;
}

#home-account-pill:empty{ display:none !important; }


/* ===== BUILD 4.120 – HOME account button IDENTICO agli altri ===== */
#home-account-pill{
  width: 100% !important;          /* identico agli altri */
  height: auto !important;
  padding: 14px 16px !important;   /* uguale agli home-btn */
  border-radius: 999px !important;

  display: flex !important;
  align-items: center !important;
  justify-content: center !important; /* TESTO PERFETTAMENTE CENTRATO */

  background: #ffffff !important;  /* BIANCO */
  color: #d40000 !important;       /* ROSSO */
  font-size: 20px !important;
  font-weight: 700 !important;

  box-shadow: 0 8px 18px rgba(0,0,0,0.25) !important;
  border: none !important;
}


/* ===== BUILD 4.120 – HOME account buttons under yellow card ===== */
.home-account-pill-wrapper{
  position:relative;
  margin-top:16px;
  display:flex;
  justify-content:center;
}


.home-account-pill-wrapper{
  margin-top:20px;
  display:flex;
  justify-content:center;
}

/* ===== BUILD 4.120 – HOME login/logout pill under yellow card (like reference) ===== */
#home-view{
  display:flex;
  flex-direction:column;
  align-items:center;
  min-height:100vh;
}

.home-bottom-area{
  width: 100%;
  max-width: 420px;
  display:flex;
  flex-direction:column;
  align-items:center;
  gap: 10px;
  margin-top: 18px;
}

.home-account-pill{
  width: min(340px, 86vw);
  border: none;
  border-radius: 999px;
  padding: 12px 18px;
  font-weight: 800;
  letter-spacing: 0.5px;
  background: var(--coyote-red, #e00);
  color:#fff;
  box-shadow: 0 10px 20px rgba(0,0,0,0.28);
}

.home-version-label{
  font-size: 14px;
  opacity: 0.55;
}

.home-footer-hidden{ display:none !important; }


/* ===== BUILD 4.120 – HOME audio toggle under account pill ===== */
.home-audio-pill{
  width: min(340px, 86vw);
  border: none;
  border-radius: 999px;
  padding: 12px 18px;
  font-weight: 800;
  letter-spacing: 0.5px;
  background: rgba(255,255,255,0.10);
  color:#fff;
  box-shadow: 0 10px 20px rgba(0,0,0,0.22);
  backdrop-filter: blur(6px);
  -webkit-backdrop-filter: blur(6px);
}


/* ===== BUILD 4.120 – Audio icon button + red build label ===== */
.home-audio-pill{
  width: 44px;
  height: 44px;
  border-radius: 50%;
  border: none;
  background: rgba(255,255,255,0.12);
  display:flex;
  align-items:center;
  justify-content:center;
  font-size: 20px;
  box-shadow: 0 6px 14px rgba(0,0,0,0.25);
}

.home-version-label{
  margin-top: 6px;
  font-size: 14px;
  font-weight: 700;
  color: #e00;
  opacity: 0.9;
}


/* ===== BUILD 4.120 – Grouped home controls, lowered by 50px ===== */
.home-controls-group{
  display:flex;
  flex-direction:column;
  align-items:center;
  gap: 10px;
  margin-top: 50px; /* move group down */
}


/* ===== BUILD 4.120 – GLOBAL banner FIX ===== */
#global-banner{
  position: sticky;
  top: 0;
  z-index: 10050;
  width: 100%;
  background: transparent;
  display: flex;
  justify-content: center;
  margin-bottom: 18px; /* distacco dal tasto home */
}

#global-banner img{
  width: 100%;
  max-width: 420px;
  height: auto;
  border-radius: 14px;
  box-shadow: 0 8px 24px rgba(0,0,0,0.45);
  display: block;
}

/* spazio layout sotto banner */
body{
  padding-top: calc(20px + 72px);
}


/* ===== BUILD 4.120 – FIX grafici Bikers Performance ===== */
.bp-performance-chart,
.bp-performance-chart canvas{
  max-height: 220px !important;
  height: 220px !important;
}

.bp-performance-chart{
  padding: 12px 16px 20px 36px !important;
}


/* ===== BUILD 4.120 – FIX BP SVG charts (no taglio numeri iOS) ===== */
#bp-popup-content .bp-glass-svg,
#icon-popup-content .bp-glass-svg{
  overflow: visible !important;
}
#bp-popup-content .bp-glass-svg text,
#icon-popup-content .bp-glass-svg text{
  paint-order: stroke;
  stroke: rgba(0,0,0,0.45);
  stroke-width: 1px;
}


  /* ===== LIQUID GLASS – RACE SELECT (Bikers) ===== */
  /* Target: pagina di selezione bikers nella sezione Race */
  #select-container {
    display:flex;
    flex-direction:column;
    gap:12px;
    padding: 10px 6px 4px 6px;
    margin-top: 6px;
  }

  /* Card glass */
  #select-container .participant-row {
    background: rgba(255,255,255,0.08);
    border: 1px solid rgba(255,255,255,0.18);
    border-top-color: rgba(255,255,255,0.28);
    border-left-color: rgba(255,255,255,0.22);
    border-radius: 22px;
    padding: 14px 14px;
    margin-bottom: 0;
    color: #fff;
    box-shadow: 0 16px 38px rgba(0,0,0,0.35);
    backdrop-filter: blur(18px) saturate(160%);
    -webkit-backdrop-filter: blur(18px) saturate(160%);
    position: relative;
    overflow: hidden;
    transform: translateZ(0);
  }

  /* Shine + vignette */
  #select-container .participant-row::before {
    content:"";
    position:absolute;
    inset:-1px;
    background:
      radial-gradient(1200px 220px at 18% 0%,
        rgba(255,255,255,0.22),
        rgba(255,255,255,0.08) 45%,
        rgba(255,255,255,0.02) 70%,
        rgba(0,0,0,0.0) 100%),
      linear-gradient(135deg,
        rgba(255,255,255,0.10),
        rgba(255,255,255,0.00) 45%,
        rgba(0,0,0,0.00));
    pointer-events:none;
    opacity: 0.95;
  }

  /* Subtle grain (cheap but effective) */
  #select-container .participant-row::after {
    content:"";
    position:absolute;
    inset:0;
    background-image:
      radial-gradient(rgba(255,255,255,0.06) 1px, rgba(0,0,0,0) 1px);
    background-size: 22px 22px;
    opacity: 0.08;
    mix-blend-mode: overlay;
    pointer-events:none;
  }

  /* Press */
  #select-container .participant-row:active {
    transform: translateY(1px) scale(0.99);
    box-shadow: 0 10px 24px rgba(0,0,0,0.30);
  }

  /* Selected: rim glow + accent bar */
  #select-container .participant-row.selected {
    border-color: rgba(250, 204, 21, 0.55);
    box-shadow:
      0 18px 46px rgba(0,0,0,0.40),
      0 0 0 1px rgba(250,204,21,0.22),
      0 0 22px rgba(250,204,21,0.18);
  }
  #select-container .participant-row.selected .participant-meta {
    color: rgba(255,255,255,0.82);
  }
  #select-container .participant-row.selected::before {
    opacity: 1;
  }
  #select-container .participant-row.selected .participant-main {
    position: relative;
    z-index: 1;
  }
  #select-container .participant-row.selected .participant-main::before {
    content:"";
    position:absolute;
    left:-14px;
    top:-10px;
    bottom:-10px;
    width: 6px;
    border-radius: 12px;
    background: linear-gradient(180deg,
      rgba(248,113,113,0.92),
      rgba(250,204,21,0.90));
    box-shadow: 0 0 14px rgba(248,113,113,0.25);
    opacity: 0.95;
  }

  /* Text */
  #select-container .participant-name {
    font-size: 16px;
    font-weight: 900;
    letter-spacing: 0.01em;
    color: rgba(255,255,255,0.96);
    text-shadow: 0 2px 10px rgba(0,0,0,0.35);
  }
  #select-container .participant-meta {
    font-size: 12px;
    color: rgba(255,255,255,0.72);
  }

  /* Avatar glass badge */
  #select-container .participant-avatar {
    width: 42px;
    height: 42px;
    border-radius: 999px;
    background: rgba(255,255,255,0.10);
    border: 1px solid rgba(255,255,255,0.22);
    border-top-color: rgba(255,255,255,0.34);
    box-shadow:
      0 10px 18px rgba(0,0,0,0.30),
      inset 0 1px 0 rgba(255,255,255,0.18);
    backdrop-filter: blur(14px) saturate(160%);
    -webkit-backdrop-filter: blur(14px) saturate(160%);
    color: rgba(255,255,255,0.95);
    font-weight: 900;
    font-size: 16px;
    text-shadow: 0 2px 10px rgba(0,0,0,0.35);
  }
  #select-container .participant-row.selected .participant-avatar {
    background: rgba(248,113,113,0.20);
    border-color: rgba(248,113,113,0.38);
    box-shadow:
      0 10px 18px rgba(0,0,0,0.30),
      0 0 18px rgba(248,113,113,0.22),
      inset 0 1px 0 rgba(255,255,255,0.18);
  }

</style>


<style>
#home-logout-btn{
  width:100%;
  max-width:320px;
  background:var(--coyote-red);
  color:#fff;
  padding:16px;
  border:none;
  border-radius:999px;
  font-weight:800;
  font-size:20px;
  cursor:pointer;
  box-shadow:0 4px 12px rgba(0,0,0,0.25);
}
#home-logout-btn:active{ transform:scale(0.97); box-shadow:none; }

/* Spazio tra numero classifica e icone */
.bp-rank-block,
.bp-rank-pos {
  margin-bottom: 30px !important;
}


/* ===== BUILD 4.120 – Account pill reposition ===== */
#account-pill, .account-pill {
  position: fixed !important;
  bottom: 84px !important;
  left: 50% !important;
  transform: translateX(-50%) !important;
  z-index: 9999 !important;
}



/* ===== BUILD 4.120 – HOME account pill inside yellow card ===== */
#home-account-pill{
  position: relative !important;
  left: auto !important;
  top: auto !important;
  bottom: auto !important;
  transform: none !important;

  margin: 12px auto 0 auto !important;
  display: inline-flex !important;
  align-items: center !important;
  gap: 10px !important;

  padding: 8px 14px !important;
  border-radius: 999px !important;
  background: var(--coyote-red, #e00) !important;
  color: #fff !important;
  box-shadow: 0 6px 14px rgba(0,0,0,0.25) !important;
}

/* wrapper inside yellow home card */
.home-yellow-card .home-account-pill-wrapper{
  display: flex;
  justify-content: center;
  width: 100%;
}


/* ===== BUILD 4.120 – HOME account pill sotto Bikers nel riquadro giallo ===== */
.home-account-pill-wrapper{
  width: 100%;
  display: flex;
  justify-content: center;
  margin-top: 12px;
}

#home-account-pill{
  position: relative !important;
  inset: auto !important;
  left: auto !important;
  top: auto !important;
  bottom: auto !important;
  transform: none !important;
  z-index: 10 !important;

  display: inline-flex !important;
  align-items: center !important;
  gap: 10px !important;

  padding: 10px 14px !important;
  border-radius: 999px !important;
  background: var(--coyote-red, #e00) !important;
  color: #fff !important;
  box-shadow: 0 8px 18px rgba(0,0,0,0.28) !important;
  user-select: none !important;
  cursor: pointer !important;
}

/* Override definitivo contro vecchie regole "nero su nero" */
#home-view #home-account-pill{
  background: var(--coyote-red, #e00) !important;
  color: #fff !important;
  box-shadow: 0 8px 18px rgba(0,0,0,0.28) !important;
}

#home-account-pill:empty{ display:none !important; }



/* ===== BUILD 4.120 – HOME account button same size as others (white bg, red text) ===== */
#home-account-pill{
  /* eredita tutto da button{} e .home-btn (width:100%, padding, radius, ecc.) */
  background: #ffffff !important;
  color: var(--coyote-red, #e00) !important;
  box-shadow: 0 4px 12px rgba(0,0,0,0.18) !important;
}

/* se vuoi un bordo leggero per staccare dal giallo */
#home-account-pill{
  border: 2px solid rgba(0,0,0,0.08) !important;
}

#home-account-pill:empty{ display:none !important; }


/* ===== BUILD 4.120 – HOME account button IDENTICO agli altri ===== */
#home-account-pill{
  width: 100% !important;          /* identico agli altri */
  height: auto !important;
  padding: 14px 16px !important;   /* uguale agli home-btn */
  border-radius: 999px !important;

  display: flex !important;
  align-items: center !important;
  justify-content: center !important; /* TESTO PERFETTAMENTE CENTRATO */

  background: #ffffff !important;  /* BIANCO */
  color: #d40000 !important;       /* ROSSO */
  font-size: 20px !important;
  font-weight: 700 !important;

  box-shadow: 0 8px 18px rgba(0,0,0,0.25) !important;
  border: none !important;
}


/* ===== BUILD 4.120 – HOME account buttons under yellow card ===== */
.home-account-pill-wrapper{
  position:relative;
  margin-top:16px;
  display:flex;
  justify-content:center;
}


.home-account-pill-wrapper{
  margin-top:20px;
  display:flex;
  justify-content:center;
}
</style>



<style id="logout-override-compact">
/* Override ultra-compact logout button (forced) */
#home-logout-btn{
  min-width: 90px !important;
  width: auto !important;
  padding: 4px 10px !important;
  font-size: 11px !important;
  font-weight: 600 !important;
  box-shadow: 0 2px 5px rgba(204,0,0,0.30) !important;
  max-width: none !important;
}

/* Spazio tra numero classifica e icone */
.bp-rank-block,
.bp-rank-pos {
  margin-bottom: 30px !important;
}


/* ===== BUILD 4.120 – Account pill reposition ===== */
#account-pill, .account-pill {
  position: fixed !important;
  bottom: 84px !important;
  left: 50% !important;
  transform: translateX(-50%) !important;
  z-index: 9999 !important;
}



/* ===== BUILD 4.120 – HOME account pill inside yellow card ===== */
#home-account-pill{
  position: relative !important;
  left: auto !important;
  top: auto !important;
  bottom: auto !important;
  transform: none !important;

  margin: 12px auto 0 auto !important;
  display: inline-flex !important;
  align-items: center !important;
  gap: 10px !important;

  padding: 8px 14px !important;
  border-radius: 999px !important;
  background: var(--coyote-red, #e00) !important;
  color: #fff !important;
  box-shadow: 0 6px 14px rgba(0,0,0,0.25) !important;
}

/* wrapper inside yellow home card */
.home-yellow-card .home-account-pill-wrapper{
  display: flex;
  justify-content: center;
  width: 100%;
}


/* ===== BUILD 4.120 – HOME account pill sotto Bikers nel riquadro giallo ===== */
.home-account-pill-wrapper{
  width: 100%;
  display: flex;
  justify-content: center;
  margin-top: 12px;
}

#home-account-pill{
  position: relative !important;
  inset: auto !important;
  left: auto !important;
  top: auto !important;
  bottom: auto !important;
  transform: none !important;
  z-index: 10 !important;

  display: inline-flex !important;
  align-items: center !important;
  gap: 10px !important;

  padding: 10px 14px !important;
  border-radius: 999px !important;
  background: var(--coyote-red, #e00) !important;
  color: #fff !important;
  box-shadow: 0 8px 18px rgba(0,0,0,0.28) !important;
  user-select: none !important;
  cursor: pointer !important;
}

/* Override definitivo contro vecchie regole "nero su nero" */
#home-view #home-account-pill{
  background: var(--coyote-red, #e00) !important;
  color: #fff !important;
  box-shadow: 0 8px 18px rgba(0,0,0,0.28) !important;
}

#home-account-pill:empty{ display:none !important; }



/* ===== BUILD 4.120 – HOME account button same size as others (white bg, red text) ===== */
#home-account-pill{
  /* eredita tutto da button{} e .home-btn (width:100%, padding, radius, ecc.) */
  background: #ffffff !important;
  color: var(--coyote-red, #e00) !important;
  box-shadow: 0 4px 12px rgba(0,0,0,0.18) !important;
}

/* se vuoi un bordo leggero per staccare dal giallo */
#home-account-pill{
  border: 2px solid rgba(0,0,0,0.08) !important;
}

#home-account-pill:empty{ display:none !important; }


/* ===== BUILD 4.120 – HOME account button IDENTICO agli altri ===== */
#home-account-pill{
  width: 100% !important;          /* identico agli altri */
  height: auto !important;
  padding: 14px 16px !important;   /* uguale agli home-btn */
  border-radius: 999px !important;

  display: flex !important;
  align-items: center !important;
  justify-content: center !important; /* TESTO PERFETTAMENTE CENTRATO */

  background: #ffffff !important;  /* BIANCO */
  color: #d40000 !important;       /* ROSSO */
  font-size: 20px !important;
  font-weight: 700 !important;

  box-shadow: 0 8px 18px rgba(0,0,0,0.25) !important;
  border: none !important;
}


/* ===== BUILD 4.120 – HOME account buttons under yellow card ===== */
.home-account-pill-wrapper{
  position:relative;
  margin-top:16px;
  display:flex;
  justify-content:center;
}


.home-account-pill-wrapper{
  margin-top:20px;
  display:flex;
  justify-content:center;
}
</style>



<style id="logout-override-compact-v2">
#home-footer {
  gap: 14px !important;
}

#home-logout-btn{
  padding: 8px 12px !important;   /* roughly double height */
  font-size: 12px !important;
  min-width: 90px !important;
  margin-bottom: 10px !important; /* 10px above build */
}

/* Spazio tra numero classifica e icone */
.bp-rank-block,
.bp-rank-pos {
  margin-bottom: 30px !important;
}


/* ===== BUILD 4.120 – Account pill reposition ===== */
#account-pill, .account-pill {
  position: fixed !important;
  bottom: 84px !important;
  left: 50% !important;
  transform: translateX(-50%) !important;
  z-index: 9999 !important;
}



/* ===== BUILD 4.120 – HOME account pill inside yellow card ===== */
#home-account-pill{
  position: relative !important;
  left: auto !important;
  top: auto !important;
  bottom: auto !important;
  transform: none !important;

  margin: 12px auto 0 auto !important;
  display: inline-flex !important;
  align-items: center !important;
  gap: 10px !important;

  padding: 8px 14px !important;
  border-radius: 999px !important;
  background: var(--coyote-red, #e00) !important;
  color: #fff !important;
  box-shadow: 0 6px 14px rgba(0,0,0,0.25) !important;
}

/* wrapper inside yellow home card */
.home-yellow-card .home-account-pill-wrapper{
  display: flex;
  justify-content: center;
  width: 100%;
}


/* ===== BUILD 4.120 – HOME account pill sotto Bikers nel riquadro giallo ===== */
.home-account-pill-wrapper{
  width: 100%;
  display: flex;
  justify-content: center;
  margin-top: 12px;
}

#home-account-pill{
  position: relative !important;
  inset: auto !important;
  left: auto !important;
  top: auto !important;
  bottom: auto !important;
  transform: none !important;
  z-index: 10 !important;

  display: inline-flex !important;
  align-items: center !important;
  gap: 10px !important;

  padding: 10px 14px !important;
  border-radius: 999px !important;
  background: var(--coyote-red, #e00) !important;
  color: #fff !important;
  box-shadow: 0 8px 18px rgba(0,0,0,0.28) !important;
  user-select: none !important;
  cursor: pointer !important;
}

/* Override definitivo contro vecchie regole "nero su nero" */
#home-view #home-account-pill{
  background: var(--coyote-red, #e00) !important;
  color: #fff !important;
  box-shadow: 0 8px 18px rgba(0,0,0,0.28) !important;
}

#home-account-pill:empty{ display:none !important; }



/* ===== BUILD 4.120 – HOME account button same size as others (white bg, red text) ===== */
#home-account-pill{
  /* eredita tutto da button{} e .home-btn (width:100%, padding, radius, ecc.) */
  background: #ffffff !important;
  color: var(--coyote-red, #e00) !important;
  box-shadow: 0 4px 12px rgba(0,0,0,0.18) !important;
}

/* se vuoi un bordo leggero per staccare dal giallo */
#home-account-pill{
  border: 2px solid rgba(0,0,0,0.08) !important;
}

#home-account-pill:empty{ display:none !important; }


/* ===== BUILD 4.120 – HOME account button IDENTICO agli altri ===== */
#home-account-pill{
  width: 100% !important;          /* identico agli altri */
  height: auto !important;
  padding: 14px 16px !important;   /* uguale agli home-btn */
  border-radius: 999px !important;

  display: flex !important;
  align-items: center !important;
  justify-content: center !important; /* TESTO PERFETTAMENTE CENTRATO */

  background: #ffffff !important;  /* BIANCO */
  color: #d40000 !important;       /* ROSSO */
  font-size: 20px !important;
  font-weight: 700 !important;

  box-shadow: 0 8px 18px rgba(0,0,0,0.25) !important;
  border: none !important;
}


/* ===== BUILD 4.120 – HOME account buttons under yellow card ===== */
.home-account-pill-wrapper{
  position:relative;
  margin-top:16px;
  display:flex;
  justify-content:center;
}


.home-account-pill-wrapper{
  margin-top:20px;
  display:flex;
  justify-content:center;
}
</style>



<style id="piazzamenti-icon-pill-css">
/* Piazzamenti: pillole rosse con icone (senza scritte) */
.piazzamenti-pillole{
  display:flex;
  gap:10px;
  margin: 0 0 14px 0;
  justify-content:flex-start;
}
.piazzamenti-pillola{
  background: var(--coyote-red);
  color: #ffffff;
  border-radius: 999px;
  padding: 8px 14px;
  display:flex;
  align-items:center;
  gap:8px;
  font-weight: 900;
  box-shadow: 0 3px 8px rgba(204,0,0,0.30);
}
.piazzamenti-pillola .pill-icon{
  font-size:16px;
  line-height:1;
}
.piazzamenti-pillola .pill-value{
  font-size:14px;
  line-height:1;
}

/* Spazio tra numero classifica e icone */
.bp-rank-block,
.bp-rank-pos {
  margin-bottom: 30px !important;
}


/* ===== BUILD 4.120 – Account pill reposition ===== */
#account-pill, .account-pill {
  position: fixed !important;
  bottom: 84px !important;
  left: 50% !important;
  transform: translateX(-50%) !important;
  z-index: 9999 !important;
}



/* ===== BUILD 4.120 – HOME account pill inside yellow card ===== */
#home-account-pill{
  position: relative !important;
  left: auto !important;
  top: auto !important;
  bottom: auto !important;
  transform: none !important;

  margin: 12px auto 0 auto !important;
  display: inline-flex !important;
  align-items: center !important;
  gap: 10px !important;

  padding: 8px 14px !important;
  border-radius: 999px !important;
  background: var(--coyote-red, #e00) !important;
  color: #fff !important;
  box-shadow: 0 6px 14px rgba(0,0,0,0.25) !important;
}

/* wrapper inside yellow home card */
.home-yellow-card .home-account-pill-wrapper{
  display: flex;
  justify-content: center;
  width: 100%;
}


/* ===== BUILD 4.120 – HOME account pill sotto Bikers nel riquadro giallo ===== */
.home-account-pill-wrapper{
  width: 100%;
  display: flex;
  justify-content: center;
  margin-top: 12px;
}

#home-account-pill{
  position: relative !important;
  inset: auto !important;
  left: auto !important;
  top: auto !important;
  bottom: auto !important;
  transform: none !important;
  z-index: 10 !important;

  display: inline-flex !important;
  align-items: center !important;
  gap: 10px !important;

  padding: 10px 14px !important;
  border-radius: 999px !important;
  background: var(--coyote-red, #e00) !important;
  color: #fff !important;
  box-shadow: 0 8px 18px rgba(0,0,0,0.28) !important;
  user-select: none !important;
  cursor: pointer !important;
}

/* Override definitivo contro vecchie regole "nero su nero" */
#home-view #home-account-pill{
  background: var(--coyote-red, #e00) !important;
  color: #fff !important;
  box-shadow: 0 8px 18px rgba(0,0,0,0.28) !important;
}

#home-account-pill:empty{ display:none !important; }



/* ===== BUILD 4.120 – HOME account button same size as others (white bg, red text) ===== */
#home-account-pill{
  /* eredita tutto da button{} e .home-btn (width:100%, padding, radius, ecc.) */
  background: #ffffff !important;
  color: var(--coyote-red, #e00) !important;
  box-shadow: 0 4px 12px rgba(0,0,0,0.18) !important;
}

/* se vuoi un bordo leggero per staccare dal giallo */
#home-account-pill{
  border: 2px solid rgba(0,0,0,0.08) !important;
}

#home-account-pill:empty{ display:none !important; }


/* ===== BUILD 4.120 – HOME account button IDENTICO agli altri ===== */
#home-account-pill{
  width: 100% !important;          /* identico agli altri */
  height: auto !important;
  padding: 14px 16px !important;   /* uguale agli home-btn */
  border-radius: 999px !important;

  display: flex !important;
  align-items: center !important;
  justify-content: center !important; /* TESTO PERFETTAMENTE CENTRATO */

  background: #ffffff !important;  /* BIANCO */
  color: #d40000 !important;       /* ROSSO */
  font-size: 20px !important;
  font-weight: 700 !important;

  box-shadow: 0 8px 18px rgba(0,0,0,0.25) !important;
  border: none !important;
}


/* ===== BUILD 4.120 – HOME account buttons under yellow card ===== */
.home-account-pill-wrapper{
  position:relative;
  margin-top:16px;
  display:flex;
  justify-content:center;
}


.home-account-pill-wrapper{
  margin-top:20px;
  display:flex;
  justify-content:center;
}
</style>



<style id="piazzamenti-icon-pill-css-v2">
/* Piazzamenti: pillole grandi, centrate, SOLO icona + numero */
.piazzamenti-pillole{
  display:flex !important;
  justify-content:center !important;
  gap:14px !important;
  margin: 6px 0 18px 0 !important;
}

.piazzamenti-pillola{
  background: var(--coyote-red) !important;
  color: #ffffff !important;
  border-radius: 999px !important;
  padding: 12px 20px !important; /* più grandi */
  display:flex !important;
  align-items:center !important;
  gap:10px !important;
  font-weight: 900 !important;
  box-shadow: 0 4px 12px rgba(204,0,0,0.35) !important;
}

.piazzamenti-pillola .pill-icon{
  font-size:20px !important;
  line-height:1 !important;
}

.piazzamenti-pillola .pill-value{
  font-size:18px !important;
  line-height:1 !important;
}

/* sicurezza: nasconde eventuali label testuali residue */
.piazzamenti-pillola .pill-label,
.piazzamenti-text,
.piazzamenti-label{
  display:none !important;
}

/* Spazio tra numero classifica e icone */
.bp-rank-block,
.bp-rank-pos {
  margin-bottom: 30px !important;
}


/* ===== BUILD 4.120 – Account pill reposition ===== */
#account-pill, .account-pill {
  position: fixed !important;
  bottom: 84px !important;
  left: 50% !important;
  transform: translateX(-50%) !important;
  z-index: 9999 !important;
}



/* ===== BUILD 4.120 – HOME account pill inside yellow card ===== */
#home-account-pill{
  position: relative !important;
  left: auto !important;
  top: auto !important;
  bottom: auto !important;
  transform: none !important;

  margin: 12px auto 0 auto !important;
  display: inline-flex !important;
  align-items: center !important;
  gap: 10px !important;

  padding: 8px 14px !important;
  border-radius: 999px !important;
  background: var(--coyote-red, #e00) !important;
  color: #fff !important;
  box-shadow: 0 6px 14px rgba(0,0,0,0.25) !important;
}

/* wrapper inside yellow home card */
.home-yellow-card .home-account-pill-wrapper{
  display: flex;
  justify-content: center;
  width: 100%;
}


/* ===== BUILD 4.120 – HOME account pill sotto Bikers nel riquadro giallo ===== */
.home-account-pill-wrapper{
  width: 100%;
  display: flex;
  justify-content: center;
  margin-top: 12px;
}

#home-account-pill{
  position: relative !important;
  inset: auto !important;
  left: auto !important;
  top: auto !important;
  bottom: auto !important;
  transform: none !important;
  z-index: 10 !important;

  display: inline-flex !important;
  align-items: center !important;
  gap: 10px !important;

  padding: 10px 14px !important;
  border-radius: 999px !important;
  background: var(--coyote-red, #e00) !important;
  color: #fff !important;
  box-shadow: 0 8px 18px rgba(0,0,0,0.28) !important;
  user-select: none !important;
  cursor: pointer !important;
}

/* Override definitivo contro vecchie regole "nero su nero" */
#home-view #home-account-pill{
  background: var(--coyote-red, #e00) !important;
  color: #fff !important;
  box-shadow: 0 8px 18px rgba(0,0,0,0.28) !important;
}

#home-account-pill:empty{ display:none !important; }



/* ===== BUILD 4.120 – HOME account button same size as others (white bg, red text) ===== */
#home-account-pill{
  /* eredita tutto da button{} e .home-btn (width:100%, padding, radius, ecc.) */
  background: #ffffff !important;
  color: var(--coyote-red, #e00) !important;
  box-shadow: 0 4px 12px rgba(0,0,0,0.18) !important;
}

/* se vuoi un bordo leggero per staccare dal giallo */
#home-account-pill{
  border: 2px solid rgba(0,0,0,0.08) !important;
}

#home-account-pill:empty{ display:none !important; }


/* ===== BUILD 4.120 – HOME account button IDENTICO agli altri ===== */
#home-account-pill{
  width: 100% !important;          /* identico agli altri */
  height: auto !important;
  padding: 14px 16px !important;   /* uguale agli home-btn */
  border-radius: 999px !important;

  display: flex !important;
  align-items: center !important;
  justify-content: center !important; /* TESTO PERFETTAMENTE CENTRATO */

  background: #ffffff !important;  /* BIANCO */
  color: #d40000 !important;       /* ROSSO */
  font-size: 20px !important;
  font-weight: 700 !important;

  box-shadow: 0 8px 18px rgba(0,0,0,0.25) !important;
  border: none !important;
}


/* ===== BUILD 4.120 – HOME account buttons under yellow card ===== */
.home-account-pill-wrapper{
  position:relative;
  margin-top:16px;
  display:flex;
  justify-content:center;
}


.home-account-pill-wrapper{
  margin-top:20px;
  display:flex;
  justify-content:center;
}
</style>



<style id="piazzamenti-remove-legacy-text">
/* Safety: remove any legacy text stack under the pills in Piazzamenti popup */
#bp-popup-content .piazzamenti-legacy,
#bp-popup-content .bp-kpi-row,
#bp-popup-content .bp-placements-legacy,
#bp-popup-content .placements-legacy {
  display:none !important;
}

/* Spazio tra numero classifica e icone */
.bp-rank-block,
.bp-rank-pos {
  margin-bottom: 30px !important;
}


/* ===== BUILD 4.120 – Account pill reposition ===== */
#account-pill, .account-pill {
  position: fixed !important;
  bottom: 84px !important;
  left: 50% !important;
  transform: translateX(-50%) !important;
  z-index: 9999 !important;
}



/* ===== BUILD 4.120 – HOME account pill inside yellow card ===== */
#home-account-pill{
  position: relative !important;
  left: auto !important;
  top: auto !important;
  bottom: auto !important;
  transform: none !important;

  margin: 12px auto 0 auto !important;
  display: inline-flex !important;
  align-items: center !important;
  gap: 10px !important;

  padding: 8px 14px !important;
  border-radius: 999px !important;
  background: var(--coyote-red, #e00) !important;
  color: #fff !important;
  box-shadow: 0 6px 14px rgba(0,0,0,0.25) !important;
}

/* wrapper inside yellow home card */
.home-yellow-card .home-account-pill-wrapper{
  display: flex;
  justify-content: center;
  width: 100%;
}


/* ===== BUILD 4.120 – HOME account pill sotto Bikers nel riquadro giallo ===== */
.home-account-pill-wrapper{
  width: 100%;
  display: flex;
  justify-content: center;
  margin-top: 12px;
}

#home-account-pill{
  position: relative !important;
  inset: auto !important;
  left: auto !important;
  top: auto !important;
  bottom: auto !important;
  transform: none !important;
  z-index: 10 !important;

  display: inline-flex !important;
  align-items: center !important;
  gap: 10px !important;

  padding: 10px 14px !important;
  border-radius: 999px !important;
  background: var(--coyote-red, #e00) !important;
  color: #fff !important;
  box-shadow: 0 8px 18px rgba(0,0,0,0.28) !important;
  user-select: none !important;
  cursor: pointer !important;
}

/* Override definitivo contro vecchie regole "nero su nero" */
#home-view #home-account-pill{
  background: var(--coyote-red, #e00) !important;
  color: #fff !important;
  box-shadow: 0 8px 18px rgba(0,0,0,0.28) !important;
}

#home-account-pill:empty{ display:none !important; }



/* ===== BUILD 4.120 – HOME account button same size as others (white bg, red text) ===== */
#home-account-pill{
  /* eredita tutto da button{} e .home-btn (width:100%, padding, radius, ecc.) */
  background: #ffffff !important;
  color: var(--coyote-red, #e00) !important;
  box-shadow: 0 4px 12px rgba(0,0,0,0.18) !important;
}

/* se vuoi un bordo leggero per staccare dal giallo */
#home-account-pill{
  border: 2px solid rgba(0,0,0,0.08) !important;
}

#home-account-pill:empty{ display:none !important; }


/* ===== BUILD 4.120 – HOME account button IDENTICO agli altri ===== */
#home-account-pill{
  width: 100% !important;          /* identico agli altri */
  height: auto !important;
  padding: 14px 16px !important;   /* uguale agli home-btn */
  border-radius: 999px !important;

  display: flex !important;
  align-items: center !important;
  justify-content: center !important; /* TESTO PERFETTAMENTE CENTRATO */

  background: #ffffff !important;  /* BIANCO */
  color: #d40000 !important;       /* ROSSO */
  font-size: 20px !important;
  font-weight: 700 !important;

  box-shadow: 0 8px 18px rgba(0,0,0,0.25) !important;
  border: none !important;
}


/* ===== BUILD 4.120 – HOME account buttons under yellow card ===== */
.home-account-pill-wrapper{
  position:relative;
  margin-top:16px;
  display:flex;
  justify-content:center;
}


.home-account-pill-wrapper{
  margin-top:20px;
  display:flex;
  justify-content:center;
}
</style>



<style id="bp-return-arrow-only">
#bp-return-bike-performance,
.bp-return-btn{
  display:flex !important;
  align-items:center !important;
  justify-content:center !important;
  font-size:26px !important;
  font-weight:900 !important;
}

/* Spazio tra numero classifica e icone */
.bp-rank-block,
.bp-rank-pos {
  margin-bottom: 30px !important;
}


/* ===== BUILD 4.120 – Account pill reposition ===== */
#account-pill, .account-pill {
  position: fixed !important;
  bottom: 84px !important;
  left: 50% !important;
  transform: translateX(-50%) !important;
  z-index: 9999 !important;
}



/* ===== BUILD 4.120 – HOME account pill inside yellow card ===== */
#home-account-pill{
  position: relative !important;
  left: auto !important;
  top: auto !important;
  bottom: auto !important;
  transform: none !important;

  margin: 12px auto 0 auto !important;
  display: inline-flex !important;
  align-items: center !important;
  gap: 10px !important;

  padding: 8px 14px !important;
  border-radius: 999px !important;
  background: var(--coyote-red, #e00) !important;
  color: #fff !important;
  box-shadow: 0 6px 14px rgba(0,0,0,0.25) !important;
}

/* wrapper inside yellow home card */
.home-yellow-card .home-account-pill-wrapper{
  display: flex;
  justify-content: center;
  width: 100%;
}


/* ===== BUILD 4.120 – HOME account pill sotto Bikers nel riquadro giallo ===== */
.home-account-pill-wrapper{
  width: 100%;
  display: flex;
  justify-content: center;
  margin-top: 12px;
}

#home-account-pill{
  position: relative !important;
  inset: auto !important;
  left: auto !important;
  top: auto !important;
  bottom: auto !important;
  transform: none !important;
  z-index: 10 !important;

  display: inline-flex !important;
  align-items: center !important;
  gap: 10px !important;

  padding: 10px 14px !important;
  border-radius: 999px !important;
  background: var(--coyote-red, #e00) !important;
  color: #fff !important;
  box-shadow: 0 8px 18px rgba(0,0,0,0.28) !important;
  user-select: none !important;
  cursor: pointer !important;
}

/* Override definitivo contro vecchie regole "nero su nero" */
#home-view #home-account-pill{
  background: var(--coyote-red, #e00) !important;
  color: #fff !important;
  box-shadow: 0 8px 18px rgba(0,0,0,0.28) !important;
}

#home-account-pill:empty{ display:none !important; }



/* ===== BUILD 4.120 – HOME account button same size as others (white bg, red text) ===== */
#home-account-pill{
  /* eredita tutto da button{} e .home-btn (width:100%, padding, radius, ecc.) */
  background: #ffffff !important;
  color: var(--coyote-red, #e00) !important;
  box-shadow: 0 4px 12px rgba(0,0,0,0.18) !important;
}

/* se vuoi un bordo leggero per staccare dal giallo */
#home-account-pill{
  border: 2px solid rgba(0,0,0,0.08) !important;
}

#home-account-pill:empty{ display:none !important; }


/* ===== BUILD 4.120 – HOME account button IDENTICO agli altri ===== */
#home-account-pill{
  width: 100% !important;          /* identico agli altri */
  height: auto !important;
  padding: 14px 16px !important;   /* uguale agli home-btn */
  border-radius: 999px !important;

  display: flex !important;
  align-items: center !important;
  justify-content: center !important; /* TESTO PERFETTAMENTE CENTRATO */

  background: #ffffff !important;  /* BIANCO */
  color: #d40000 !important;       /* ROSSO */
  font-size: 20px !important;
  font-weight: 700 !important;

  box-shadow: 0 8px 18px rgba(0,0,0,0.25) !important;
  border: none !important;
}


/* ===== BUILD 4.120 – HOME account buttons under yellow card ===== */
.home-account-pill-wrapper{
  position:relative;
  margin-top:16px;
  display:flex;
  justify-content:center;
}


.home-account-pill-wrapper{
  margin-top:20px;
  display:flex;
  justify-content:center;
}
</style>



<style id="bp-compare-css">
/* Bike performance – Compare mode controls (FIX vivid buttons on iOS) */
#bp-compare-controls{
  display:flex;
  gap:12px;
  justify-content:center;
  align-items:center;
  margin: 6px 0 10px;
  flex-wrap:wrap;
}

.bp-compare-btn{
  border:none;
  border-radius:999px;
  padding:12px 18px;
  font-weight:900;
  font-size:14px;
  cursor:pointer;
  box-shadow:0 6px 16px rgba(0,0,0,0.22);
  opacity:1 !important;
  filter:none !important;

  /* IMPORTANT: keep buttons solid (no glass wash) */
  background: #111827 !important;
  color:#fff !important;
  border: 1px solid rgba(255,255,255,0.18) !important;
  backdrop-filter:none !important;
  -webkit-backdrop-filter:none !important;
}

/* RED (toggle) */
#bp-compare-toggle{
  background: rgba(204,0,0,0.92) !important;
  color:#fff !important;
  border-color: rgba(255,255,255,0.16) !important;
}
#bp-compare-toggle.active{
  background: rgba(204,0,0,1) !important;
  box-shadow:0 8px 18px rgba(0,0,0,0.26);
}

/* YELLOW (go) */
#bp-compare-go{
  background: rgba(253,224,0,0.92) !important;
  color:#111827 !important;
  border-color: rgba(0,0,0,0.10) !important;
  opacity:0.65 !important; /* disabled but still vivid */
}
#bp-compare-go.enabled{
  opacity:1 !important;
}

/* Selected biker row when compareMode ON */
.bp-item.bp-selected{
  background:#0f172a !important;
  border-color:#16a34a !important;
  box-shadow:0 10px 22px rgba(0,0,0,0.25) !important;
}
.bp-item.bp-selected .bp-name,
.bp-item.bp-selected .bp-score{
  color:#f9fafb !important;
}

/* Spazio tra numero classifica e icone */
.bp-rank-block,
.bp-rank-pos {
  margin-bottom: 30px !important;
}
</style>



<style id="bp-compare-on-black">
/* Compare controls: place outside the white card, on the black background */
#bp-compare-controls{
  position: fixed !important;
  left: 0 !important;
  right: 0 !important;
  bottom: 24px !important;
  margin: 0 !important;
  padding: 0 16px !important;
  justify-content: center !important;
  z-index: 12000 !important;
}

/* Add breathing room so controls don't overlap content inside the white card */
#bikers-performance-view{
  padding-bottom: 120px !important;
}

/* Spazio tra numero classifica e icone */
.bp-rank-block,
.bp-rank-pos {
  margin-bottom: 30px !important;
}


/* ===== BUILD 4.120 – Account pill reposition ===== */
#account-pill, .account-pill {
  position: fixed !important;
  bottom: 84px !important;
  left: 50% !important;
  transform: translateX(-50%) !important;
  z-index: 9999 !important;
}



/* ===== BUILD 4.120 – HOME account pill inside yellow card ===== */
#home-account-pill{
  position: relative !important;
  left: auto !important;
  top: auto !important;
  bottom: auto !important;
  transform: none !important;

  margin: 12px auto 0 auto !important;
  display: inline-flex !important;
  align-items: center !important;
  gap: 10px !important;

  padding: 8px 14px !important;
  border-radius: 999px !important;
  background: var(--coyote-red, #e00) !important;
  color: #fff !important;
  box-shadow: 0 6px 14px rgba(0,0,0,0.25) !important;
}

/* wrapper inside yellow home card */
.home-yellow-card .home-account-pill-wrapper{
  display: flex;
  justify-content: center;
  width: 100%;
}


/* ===== BUILD 4.120 – HOME account pill sotto Bikers nel riquadro giallo ===== */
.home-account-pill-wrapper{
  width: 100%;
  display: flex;
  justify-content: center;
  margin-top: 12px;
}

#home-account-pill{
  position: relative !important;
  inset: auto !important;
  left: auto !important;
  top: auto !important;
  bottom: auto !important;
  transform: none !important;
  z-index: 10 !important;

  display: inline-flex !important;
  align-items: center !important;
  gap: 10px !important;

  padding: 10px 14px !important;
  border-radius: 999px !important;
  background: var(--coyote-red, #e00) !important;
  color: #fff !important;
  box-shadow: 0 8px 18px rgba(0,0,0,0.28) !important;
  user-select: none !important;
  cursor: pointer !important;
}

/* Override definitivo contro vecchie regole "nero su nero" */
#home-view #home-account-pill{
  background: var(--coyote-red, #e00) !important;
  color: #fff !important;
  box-shadow: 0 8px 18px rgba(0,0,0,0.28) !important;
}

#home-account-pill:empty{ display:none !important; }



/* ===== BUILD 4.120 – HOME account button same size as others (white bg, red text) ===== */
#home-account-pill{
  /* eredita tutto da button{} e .home-btn (width:100%, padding, radius, ecc.) */
  background: #ffffff !important;
  color: var(--coyote-red, #e00) !important;
  box-shadow: 0 4px 12px rgba(0,0,0,0.18) !important;
}

/* se vuoi un bordo leggero per staccare dal giallo */
#home-account-pill{
  border: 2px solid rgba(0,0,0,0.08) !important;
}

#home-account-pill:empty{ display:none !important; }


/* ===== BUILD 4.120 – HOME account button IDENTICO agli altri ===== */
#home-account-pill{
  width: 100% !important;          /* identico agli altri */
  height: auto !important;
  padding: 14px 16px !important;   /* uguale agli home-btn */
  border-radius: 999px !important;

  display: flex !important;
  align-items: center !important;
  justify-content: center !important; /* TESTO PERFETTAMENTE CENTRATO */

  background: #ffffff !important;  /* BIANCO */
  color: #d40000 !important;       /* ROSSO */
  font-size: 20px !important;
  font-weight: 700 !important;

  box-shadow: 0 8px 18px rgba(0,0,0,0.25) !important;
  border: none !important;
}


/* ===== BUILD 4.120 – HOME account buttons under yellow card ===== */
.home-account-pill-wrapper{
  position:relative;
  margin-top:16px;
  display:flex;
  justify-content:center;
}


.home-account-pill-wrapper{
  margin-top:20px;
  display:flex;
  justify-content:center;
}
</style>



<style id="bp-compare-bigger">
#bp-compare-controls .bp-compare-btn{
  padding: 16px 28px !important;
  font-size: 18px !important;
  border-radius: 999px !important;
  min-width: 150px !important;
}

/* Spazio tra numero classifica e icone */
.bp-rank-block,
.bp-rank-pos {
  margin-bottom: 30px !important;
}


/* ===== BUILD 4.120 – Account pill reposition ===== */
#account-pill, .account-pill {
  position: fixed !important;
  bottom: 84px !important;
  left: 50% !important;
  transform: translateX(-50%) !important;
  z-index: 9999 !important;
}



/* ===== BUILD 4.120 – HOME account pill inside yellow card ===== */
#home-account-pill{
  position: relative !important;
  left: auto !important;
  top: auto !important;
  bottom: auto !important;
  transform: none !important;

  margin: 12px auto 0 auto !important;
  display: inline-flex !important;
  align-items: center !important;
  gap: 10px !important;

  padding: 8px 14px !important;
  border-radius: 999px !important;
  background: var(--coyote-red, #e00) !important;
  color: #fff !important;
  box-shadow: 0 6px 14px rgba(0,0,0,0.25) !important;
}

/* wrapper inside yellow home card */
.home-yellow-card .home-account-pill-wrapper{
  display: flex;
  justify-content: center;
  width: 100%;
}


/* ===== BUILD 4.120 – HOME account pill sotto Bikers nel riquadro giallo ===== */
.home-account-pill-wrapper{
  width: 100%;
  display: flex;
  justify-content: center;
  margin-top: 12px;
}

#home-account-pill{
  position: relative !important;
  inset: auto !important;
  left: auto !important;
  top: auto !important;
  bottom: auto !important;
  transform: none !important;
  z-index: 10 !important;

  display: inline-flex !important;
  align-items: center !important;
  gap: 10px !important;

  padding: 10px 14px !important;
  border-radius: 999px !important;
  background: var(--coyote-red, #e00) !important;
  color: #fff !important;
  box-shadow: 0 8px 18px rgba(0,0,0,0.28) !important;
  user-select: none !important;
  cursor: pointer !important;
}

/* Override definitivo contro vecchie regole "nero su nero" */
#home-view #home-account-pill{
  background: var(--coyote-red, #e00) !important;
  color: #fff !important;
  box-shadow: 0 8px 18px rgba(0,0,0,0.28) !important;
}

#home-account-pill:empty{ display:none !important; }



/* ===== BUILD 4.120 – HOME account button same size as others (white bg, red text) ===== */
#home-account-pill{
  /* eredita tutto da button{} e .home-btn (width:100%, padding, radius, ecc.) */
  background: #ffffff !important;
  color: var(--coyote-red, #e00) !important;
  box-shadow: 0 4px 12px rgba(0,0,0,0.18) !important;
}

/* se vuoi un bordo leggero per staccare dal giallo */
#home-account-pill{
  border: 2px solid rgba(0,0,0,0.08) !important;
}

#home-account-pill:empty{ display:none !important; }


/* ===== BUILD 4.120 – HOME account button IDENTICO agli altri ===== */
#home-account-pill{
  width: 100% !important;          /* identico agli altri */
  height: auto !important;
  padding: 14px 16px !important;   /* uguale agli home-btn */
  border-radius: 999px !important;

  display: flex !important;
  align-items: center !important;
  justify-content: center !important; /* TESTO PERFETTAMENTE CENTRATO */

  background: #ffffff !important;  /* BIANCO */
  color: #d40000 !important;       /* ROSSO */
  font-size: 20px !important;
  font-weight: 700 !important;

  box-shadow: 0 8px 18px rgba(0,0,0,0.25) !important;
  border: none !important;
}


/* ===== BUILD 4.120 – HOME account buttons under yellow card ===== */
.home-account-pill-wrapper{
  position:relative;
  margin-top:16px;
  display:flex;
  justify-content:center;
}


.home-account-pill-wrapper{
  margin-top:20px;
  display:flex;
  justify-content:center;
}
</style>



<style id="bp-back-btn-offset">
#bp-return-bike-performance,
.bp-return-btn{
  margin-top: 40px !important;
}

/* Spazio tra numero classifica e icone */
.bp-rank-block,
.bp-rank-pos {
  margin-bottom: 30px !important;
}


/* ===== BUILD 4.120 – Account pill reposition ===== */
#account-pill, .account-pill {
  position: fixed !important;
  bottom: 84px !important;
  left: 50% !important;
  transform: translateX(-50%) !important;
  z-index: 9999 !important;
}



/* ===== BUILD 4.120 – HOME account pill inside yellow card ===== */
#home-account-pill{
  position: relative !important;
  left: auto !important;
  top: auto !important;
  bottom: auto !important;
  transform: none !important;

  margin: 12px auto 0 auto !important;
  display: inline-flex !important;
  align-items: center !important;
  gap: 10px !important;

  padding: 8px 14px !important;
  border-radius: 999px !important;
  background: var(--coyote-red, #e00) !important;
  color: #fff !important;
  box-shadow: 0 6px 14px rgba(0,0,0,0.25) !important;
}

/* wrapper inside yellow home card */
.home-yellow-card .home-account-pill-wrapper{
  display: flex;
  justify-content: center;
  width: 100%;
}


/* ===== BUILD 4.120 – HOME account pill sotto Bikers nel riquadro giallo ===== */
.home-account-pill-wrapper{
  width: 100%;
  display: flex;
  justify-content: center;
  margin-top: 12px;
}

#home-account-pill{
  position: relative !important;
  inset: auto !important;
  left: auto !important;
  top: auto !important;
  bottom: auto !important;
  transform: none !important;
  z-index: 10 !important;

  display: inline-flex !important;
  align-items: center !important;
  gap: 10px !important;

  padding: 10px 14px !important;
  border-radius: 999px !important;
  background: var(--coyote-red, #e00) !important;
  color: #fff !important;
  box-shadow: 0 8px 18px rgba(0,0,0,0.28) !important;
  user-select: none !important;
  cursor: pointer !important;
}

/* Override definitivo contro vecchie regole "nero su nero" */
#home-view #home-account-pill{
  background: var(--coyote-red, #e00) !important;
  color: #fff !important;
  box-shadow: 0 8px 18px rgba(0,0,0,0.28) !important;
}

#home-account-pill:empty{ display:none !important; }



/* ===== BUILD 4.120 – HOME account button same size as others (white bg, red text) ===== */
#home-account-pill{
  /* eredita tutto da button{} e .home-btn (width:100%, padding, radius, ecc.) */
  background: #ffffff !important;
  color: var(--coyote-red, #e00) !important;
  box-shadow: 0 4px 12px rgba(0,0,0,0.18) !important;
}

/* se vuoi un bordo leggero per staccare dal giallo */
#home-account-pill{
  border: 2px solid rgba(0,0,0,0.08) !important;
}

#home-account-pill:empty{ display:none !important; }


/* ===== BUILD 4.120 – HOME account button IDENTICO agli altri ===== */
#home-account-pill{
  width: 100% !important;          /* identico agli altri */
  height: auto !important;
  padding: 14px 16px !important;   /* uguale agli home-btn */
  border-radius: 999px !important;

  display: flex !important;
  align-items: center !important;
  justify-content: center !important; /* TESTO PERFETTAMENTE CENTRATO */

  background: #ffffff !important;  /* BIANCO */
  color: #d40000 !important;       /* ROSSO */
  font-size: 20px !important;
  font-weight: 700 !important;

  box-shadow: 0 8px 18px rgba(0,0,0,0.25) !important;
  border: none !important;
}


/* ===== BUILD 4.120 – HOME account buttons under yellow card ===== */
.home-account-pill-wrapper{
  position:relative;
  margin-top:16px;
  display:flex;
  justify-content:center;
}


.home-account-pill-wrapper{
  margin-top:20px;
  display:flex;
  justify-content:center;
}
</style>



<style id="bp-placements-numbers">
/* Numbers on placement bars */
.bp-placement-row{
  position: relative;
}
.bp-placement-value{
  position: absolute;
  right: 10px;
  top: 50%;
  transform: translateY(-50%);
  font-weight: 900;
  color: #111827;
}

/* Spazio tra numero classifica e icone */
.bp-rank-block,
.bp-rank-pos {
  margin-bottom: 30px !important;
}


/* ===== BUILD 4.120 – Account pill reposition ===== */
#account-pill, .account-pill {
  position: fixed !important;
  bottom: 84px !important;
  left: 50% !important;
  transform: translateX(-50%) !important;
  z-index: 9999 !important;
}



/* ===== BUILD 4.120 – HOME account pill inside yellow card ===== */
#home-account-pill{
  position: relative !important;
  left: auto !important;
  top: auto !important;
  bottom: auto !important;
  transform: none !important;

  margin: 12px auto 0 auto !important;
  display: inline-flex !important;
  align-items: center !important;
  gap: 10px !important;

  padding: 8px 14px !important;
  border-radius: 999px !important;
  background: var(--coyote-red, #e00) !important;
  color: #fff !important;
  box-shadow: 0 6px 14px rgba(0,0,0,0.25) !important;
}

/* wrapper inside yellow home card */
.home-yellow-card .home-account-pill-wrapper{
  display: flex;
  justify-content: center;
  width: 100%;
}


/* ===== BUILD 4.120 – HOME account pill sotto Bikers nel riquadro giallo ===== */
.home-account-pill-wrapper{
  width: 100%;
  display: flex;
  justify-content: center;
  margin-top: 12px;
}

#home-account-pill{
  position: relative !important;
  inset: auto !important;
  left: auto !important;
  top: auto !important;
  bottom: auto !important;
  transform: none !important;
  z-index: 10 !important;

  display: inline-flex !important;
  align-items: center !important;
  gap: 10px !important;

  padding: 10px 14px !important;
  border-radius: 999px !important;
  background: var(--coyote-red, #e00) !important;
  color: #fff !important;
  box-shadow: 0 8px 18px rgba(0,0,0,0.28) !important;
  user-select: none !important;
  cursor: pointer !important;
}

/* Override definitivo contro vecchie regole "nero su nero" */
#home-view #home-account-pill{
  background: var(--coyote-red, #e00) !important;
  color: #fff !important;
  box-shadow: 0 8px 18px rgba(0,0,0,0.28) !important;
}

#home-account-pill:empty{ display:none !important; }



/* ===== BUILD 4.120 – HOME account button same size as others (white bg, red text) ===== */
#home-account-pill{
  /* eredita tutto da button{} e .home-btn (width:100%, padding, radius, ecc.) */
  background: #ffffff !important;
  color: var(--coyote-red, #e00) !important;
  box-shadow: 0 4px 12px rgba(0,0,0,0.18) !important;
}

/* se vuoi un bordo leggero per staccare dal giallo */
#home-account-pill{
  border: 2px solid rgba(0,0,0,0.08) !important;
}

#home-account-pill:empty{ display:none !important; }


/* ===== BUILD 4.120 – HOME account button IDENTICO agli altri ===== */
#home-account-pill{
  width: 100% !important;          /* identico agli altri */
  height: auto !important;
  padding: 14px 16px !important;   /* uguale agli home-btn */
  border-radius: 999px !important;

  display: flex !important;
  align-items: center !important;
  justify-content: center !important; /* TESTO PERFETTAMENTE CENTRATO */

  background: #ffffff !important;  /* BIANCO */
  color: #d40000 !important;       /* ROSSO */
  font-size: 20px !important;
  font-weight: 700 !important;

  box-shadow: 0 8px 18px rgba(0,0,0,0.25) !important;
  border: none !important;
}


/* ===== BUILD 4.120 – HOME account buttons under yellow card ===== */
.home-account-pill-wrapper{
  position:relative;
  margin-top:16px;
  display:flex;
  justify-content:center;
}


.home-account-pill-wrapper{
  margin-top:20px;
  display:flex;
  justify-content:center;
}
</style>



<style id="bp-placements-bars-inside">
/* Piazzamenti: barre più alte */
.bp-placement-bar,
.bp-placement-track{
  height: 28px !important; /* circa il doppio */
  border-radius: 14px !important;
}

/* Numero dentro la barra */
.bp-placement-value{
  position: absolute;
  right: 12px;
  top: 50%;
  transform: translateY(-50%);
  font-weight: 900;
  color: #ffffff;
  text-shadow: 0 1px 2px rgba(0,0,0,0.5);
  pointer-events: none;
}

/* Spazio tra numero classifica e icone */
.bp-rank-block,
.bp-rank-pos {
  margin-bottom: 30px !important;
}


/* ===== BUILD 4.120 – Account pill reposition ===== */
#account-pill, .account-pill {
  position: fixed !important;
  bottom: 84px !important;
  left: 50% !important;
  transform: translateX(-50%) !important;
  z-index: 9999 !important;
}



/* ===== BUILD 4.120 – HOME account pill inside yellow card ===== */
#home-account-pill{
  position: relative !important;
  left: auto !important;
  top: auto !important;
  bottom: auto !important;
  transform: none !important;

  margin: 12px auto 0 auto !important;
  display: inline-flex !important;
  align-items: center !important;
  gap: 10px !important;

  padding: 8px 14px !important;
  border-radius: 999px !important;
  background: var(--coyote-red, #e00) !important;
  color: #fff !important;
  box-shadow: 0 6px 14px rgba(0,0,0,0.25) !important;
}

/* wrapper inside yellow home card */
.home-yellow-card .home-account-pill-wrapper{
  display: flex;
  justify-content: center;
  width: 100%;
}


/* ===== BUILD 4.120 – HOME account pill sotto Bikers nel riquadro giallo ===== */
.home-account-pill-wrapper{
  width: 100%;
  display: flex;
  justify-content: center;
  margin-top: 12px;
}

#home-account-pill{
  position: relative !important;
  inset: auto !important;
  left: auto !important;
  top: auto !important;
  bottom: auto !important;
  transform: none !important;
  z-index: 10 !important;

  display: inline-flex !important;
  align-items: center !important;
  gap: 10px !important;

  padding: 10px 14px !important;
  border-radius: 999px !important;
  background: var(--coyote-red, #e00) !important;
  color: #fff !important;
  box-shadow: 0 8px 18px rgba(0,0,0,0.28) !important;
  user-select: none !important;
  cursor: pointer !important;
}

/* Override definitivo contro vecchie regole "nero su nero" */
#home-view #home-account-pill{
  background: var(--coyote-red, #e00) !important;
  color: #fff !important;
  box-shadow: 0 8px 18px rgba(0,0,0,0.28) !important;
}

#home-account-pill:empty{ display:none !important; }



/* ===== BUILD 4.120 – HOME account button same size as others (white bg, red text) ===== */
#home-account-pill{
  /* eredita tutto da button{} e .home-btn (width:100%, padding, radius, ecc.) */
  background: #ffffff !important;
  color: var(--coyote-red, #e00) !important;
  box-shadow: 0 4px 12px rgba(0,0,0,0.18) !important;
}

/* se vuoi un bordo leggero per staccare dal giallo */
#home-account-pill{
  border: 2px solid rgba(0,0,0,0.08) !important;
}

#home-account-pill:empty{ display:none !important; }


/* ===== BUILD 4.120 – HOME account button IDENTICO agli altri ===== */
#home-account-pill{
  width: 100% !important;          /* identico agli altri */
  height: auto !important;
  padding: 14px 16px !important;   /* uguale agli home-btn */
  border-radius: 999px !important;

  display: flex !important;
  align-items: center !important;
  justify-content: center !important; /* TESTO PERFETTAMENTE CENTRATO */

  background: #ffffff !important;  /* BIANCO */
  color: #d40000 !important;       /* ROSSO */
  font-size: 20px !important;
  font-weight: 700 !important;

  box-shadow: 0 8px 18px rgba(0,0,0,0.25) !important;
  border: none !important;
}


/* ===== BUILD 4.120 – HOME account buttons under yellow card ===== */
.home-account-pill-wrapper{
  position:relative;
  margin-top:16px;
  display:flex;
  justify-content:center;
}


.home-account-pill-wrapper{
  margin-top:20px;
  display:flex;
  justify-content:center;
}
</style>



<style id="bp-gap-red-btn">
/* 30px gap between white card and red back button */
#bp-card,
.white-card,
.main-card {
  margin-bottom: 30px !important;
}

/* Spazio tra numero classifica e icone */
.bp-rank-block,
.bp-rank-pos {
  margin-bottom: 30px !important;
}


/* ===== BUILD 4.120 – Account pill reposition ===== */
#account-pill, .account-pill {
  position: fixed !important;
  bottom: 84px !important;
  left: 50% !important;
  transform: translateX(-50%) !important;
  z-index: 9999 !important;
}



/* ===== BUILD 4.120 – HOME account pill inside yellow card ===== */
#home-account-pill{
  position: relative !important;
  left: auto !important;
  top: auto !important;
  bottom: auto !important;
  transform: none !important;

  margin: 12px auto 0 auto !important;
  display: inline-flex !important;
  align-items: center !important;
  gap: 10px !important;

  padding: 8px 14px !important;
  border-radius: 999px !important;
  background: var(--coyote-red, #e00) !important;
  color: #fff !important;
  box-shadow: 0 6px 14px rgba(0,0,0,0.25) !important;
}

/* wrapper inside yellow home card */
.home-yellow-card .home-account-pill-wrapper{
  display: flex;
  justify-content: center;
  width: 100%;
}


/* ===== BUILD 4.120 – HOME account pill sotto Bikers nel riquadro giallo ===== */
.home-account-pill-wrapper{
  width: 100%;
  display: flex;
  justify-content: center;
  margin-top: 12px;
}

#home-account-pill{
  position: relative !important;
  inset: auto !important;
  left: auto !important;
  top: auto !important;
  bottom: auto !important;
  transform: none !important;
  z-index: 10 !important;

  display: inline-flex !important;
  align-items: center !important;
  gap: 10px !important;

  padding: 10px 14px !important;
  border-radius: 999px !important;
  background: var(--coyote-red, #e00) !important;
  color: #fff !important;
  box-shadow: 0 8px 18px rgba(0,0,0,0.28) !important;
  user-select: none !important;
  cursor: pointer !important;
}

/* Override definitivo contro vecchie regole "nero su nero" */
#home-view #home-account-pill{
  background: var(--coyote-red, #e00) !important;
  color: #fff !important;
  box-shadow: 0 8px 18px rgba(0,0,0,0.28) !important;
}

#home-account-pill:empty{ display:none !important; }



/* ===== BUILD 4.120 – HOME account button same size as others (white bg, red text) ===== */
#home-account-pill{
  /* eredita tutto da button{} e .home-btn (width:100%, padding, radius, ecc.) */
  background: #ffffff !important;
  color: var(--coyote-red, #e00) !important;
  box-shadow: 0 4px 12px rgba(0,0,0,0.18) !important;
}

/* se vuoi un bordo leggero per staccare dal giallo */
#home-account-pill{
  border: 2px solid rgba(0,0,0,0.08) !important;
}

#home-account-pill:empty{ display:none !important; }


/* ===== BUILD 4.120 – HOME account button IDENTICO agli altri ===== */
#home-account-pill{
  width: 100% !important;          /* identico agli altri */
  height: auto !important;
  padding: 14px 16px !important;   /* uguale agli home-btn */
  border-radius: 999px !important;

  display: flex !important;
  align-items: center !important;
  justify-content: center !important; /* TESTO PERFETTAMENTE CENTRATO */

  background: #ffffff !important;  /* BIANCO */
  color: #d40000 !important;       /* ROSSO */
  font-size: 20px !important;
  font-weight: 700 !important;

  box-shadow: 0 8px 18px rgba(0,0,0,0.25) !important;
  border: none !important;
}


/* ===== BUILD 4.120 – HOME account buttons under yellow card ===== */
.home-account-pill-wrapper{
  position:relative;
  margin-top:16px;
  display:flex;
  justify-content:center;
}


.home-account-pill-wrapper{
  margin-top:20px;
  display:flex;
  justify-content:center;
}
</style>



<style id="bp-return-bottom-gap">
/* Gap under the red button inside the white card */
.bp-return-row{
  margin-bottom: 30px !important; /* was ~10px */
}

/* Spazio tra numero classifica e icone */
.bp-rank-block,
.bp-rank-pos {
  margin-bottom: 30px !important;
}


/* ===== BUILD 4.120 – Account pill reposition ===== */
#account-pill, .account-pill {
  position: fixed !important;
  bottom: 84px !important;
  left: 50% !important;
  transform: translateX(-50%) !important;
  z-index: 9999 !important;
}



/* ===== BUILD 4.120 – HOME account pill inside yellow card ===== */
#home-account-pill{
  position: relative !important;
  left: auto !important;
  top: auto !important;
  bottom: auto !important;
  transform: none !important;

  margin: 12px auto 0 auto !important;
  display: inline-flex !important;
  align-items: center !important;
  gap: 10px !important;

  padding: 8px 14px !important;
  border-radius: 999px !important;
  background: var(--coyote-red, #e00) !important;
  color: #fff !important;
  box-shadow: 0 6px 14px rgba(0,0,0,0.25) !important;
}

/* wrapper inside yellow home card */
.home-yellow-card .home-account-pill-wrapper{
  display: flex;
  justify-content: center;
  width: 100%;
}


/* ===== BUILD 4.120 – HOME account pill sotto Bikers nel riquadro giallo ===== */
.home-account-pill-wrapper{
  width: 100%;
  display: flex;
  justify-content: center;
  margin-top: 12px;
}

#home-account-pill{
  position: relative !important;
  inset: auto !important;
  left: auto !important;
  top: auto !important;
  bottom: auto !important;
  transform: none !important;
  z-index: 10 !important;

  display: inline-flex !important;
  align-items: center !important;
  gap: 10px !important;

  padding: 10px 14px !important;
  border-radius: 999px !important;
  background: var(--coyote-red, #e00) !important;
  color: #fff !important;
  box-shadow: 0 8px 18px rgba(0,0,0,0.28) !important;
  user-select: none !important;
  cursor: pointer !important;
}

/* Override definitivo contro vecchie regole "nero su nero" */
#home-view #home-account-pill{
  background: var(--coyote-red, #e00) !important;
  color: #fff !important;
  box-shadow: 0 8px 18px rgba(0,0,0,0.28) !important;
}

#home-account-pill:empty{ display:none !important; }



/* ===== BUILD 4.120 – HOME account button same size as others (white bg, red text) ===== */
#home-account-pill{
  /* eredita tutto da button{} e .home-btn (width:100%, padding, radius, ecc.) */
  background: #ffffff !important;
  color: var(--coyote-red, #e00) !important;
  box-shadow: 0 4px 12px rgba(0,0,0,0.18) !important;
}

/* se vuoi un bordo leggero per staccare dal giallo */
#home-account-pill{
  border: 2px solid rgba(0,0,0,0.08) !important;
}

#home-account-pill:empty{ display:none !important; }


/* ===== BUILD 4.120 – HOME account button IDENTICO agli altri ===== */
#home-account-pill{
  width: 100% !important;          /* identico agli altri */
  height: auto !important;
  padding: 14px 16px !important;   /* uguale agli home-btn */
  border-radius: 999px !important;

  display: flex !important;
  align-items: center !important;
  justify-content: center !important; /* TESTO PERFETTAMENTE CENTRATO */

  background: #ffffff !important;  /* BIANCO */
  color: #d40000 !important;       /* ROSSO */
  font-size: 20px !important;
  font-weight: 700 !important;

  box-shadow: 0 8px 18px rgba(0,0,0,0.25) !important;
  border: none !important;
}


/* ===== BUILD 4.120 – HOME account buttons under yellow card ===== */
.home-account-pill-wrapper{
  position:relative;
  margin-top:16px;
  display:flex;
  justify-content:center;
}


.home-account-pill-wrapper{
  margin-top:20px;
  display:flex;
  justify-content:center;
}
</style>



<style id="bp-rank-pos-css">
.bp-rank-pos{
  margin-top: 10px;
  text-align: center;
  font-weight: 900;
  font-size: 18px;
  color: #111827;
}

/* Spazio tra numero classifica e icone */
.bp-rank-block,
.bp-rank-pos {
  margin-bottom: 30px !important;
}


/* ===== BUILD 4.120 – Account pill reposition ===== */
#account-pill, .account-pill {
  position: fixed !important;
  bottom: 84px !important;
  left: 50% !important;
  transform: translateX(-50%) !important;
  z-index: 9999 !important;
}



/* ===== BUILD 4.120 – HOME account pill inside yellow card ===== */
#home-account-pill{
  position: relative !important;
  left: auto !important;
  top: auto !important;
  bottom: auto !important;
  transform: none !important;

  margin: 12px auto 0 auto !important;
  display: inline-flex !important;
  align-items: center !important;
  gap: 10px !important;

  padding: 8px 14px !important;
  border-radius: 999px !important;
  background: var(--coyote-red, #e00) !important;
  color: #fff !important;
  box-shadow: 0 6px 14px rgba(0,0,0,0.25) !important;
}

/* wrapper inside yellow home card */
.home-yellow-card .home-account-pill-wrapper{
  display: flex;
  justify-content: center;
  width: 100%;
}


/* ===== BUILD 4.120 – HOME account pill sotto Bikers nel riquadro giallo ===== */
.home-account-pill-wrapper{
  width: 100%;
  display: flex;
  justify-content: center;
  margin-top: 12px;
}

#home-account-pill{
  position: relative !important;
  inset: auto !important;
  left: auto !important;
  top: auto !important;
  bottom: auto !important;
  transform: none !important;
  z-index: 10 !important;

  display: inline-flex !important;
  align-items: center !important;
  gap: 10px !important;

  padding: 10px 14px !important;
  border-radius: 999px !important;
  background: var(--coyote-red, #e00) !important;
  color: #fff !important;
  box-shadow: 0 8px 18px rgba(0,0,0,0.28) !important;
  user-select: none !important;
  cursor: pointer !important;
}

/* Override definitivo contro vecchie regole "nero su nero" */
#home-view #home-account-pill{
  background: var(--coyote-red, #e00) !important;
  color: #fff !important;
  box-shadow: 0 8px 18px rgba(0,0,0,0.28) !important;
}

#home-account-pill:empty{ display:none !important; }



/* ===== BUILD 4.120 – HOME account button same size as others (white bg, red text) ===== */
#home-account-pill{
  /* eredita tutto da button{} e .home-btn (width:100%, padding, radius, ecc.) */
  background: #ffffff !important;
  color: var(--coyote-red, #e00) !important;
  box-shadow: 0 4px 12px rgba(0,0,0,0.18) !important;
}

/* se vuoi un bordo leggero per staccare dal giallo */
#home-account-pill{
  border: 2px solid rgba(0,0,0,0.08) !important;
}

#home-account-pill:empty{ display:none !important; }


/* ===== BUILD 4.120 – HOME account button IDENTICO agli altri ===== */
#home-account-pill{
  width: 100% !important;          /* identico agli altri */
  height: auto !important;
  padding: 14px 16px !important;   /* uguale agli home-btn */
  border-radius: 999px !important;

  display: flex !important;
  align-items: center !important;
  justify-content: center !important; /* TESTO PERFETTAMENTE CENTRATO */

  background: #ffffff !important;  /* BIANCO */
  color: #d40000 !important;       /* ROSSO */
  font-size: 20px !important;
  font-weight: 700 !important;

  box-shadow: 0 8px 18px rgba(0,0,0,0.25) !important;
  border: none !important;
}


/* ===== BUILD 4.120 – HOME account buttons under yellow card ===== */
.home-account-pill-wrapper{
  position:relative;
  margin-top:16px;
  display:flex;
  justify-content:center;
}


.home-account-pill-wrapper{
  margin-top:20px;
  display:flex;
  justify-content:center;
}
</style>





<style id="bp-rank-pill">
.bp-return-row{
  display:flex !important;
  flex-direction:column !important;
  align-items:center !important;
  gap:18px !important;
}

.bp-rank-pos{
  order:-1 !important;
  margin-top:10px !important; /* lower by 10px */
  background:#fde047; /* yellow pill */
  color:#111827 !important;
  font-size:64px !important;
  font-weight:900 !important;
  line-height:1 !important;
  padding:18px 34px !important;
  border-radius:999px !important;
  box-shadow:0 6px 14px rgba(0,0,0,.15);
}

/* Spazio tra numero classifica e icone */
.bp-rank-block,
.bp-rank-pos {
  margin-bottom: 30px !important;
}


/* ===== BUILD 4.120 – Account pill reposition ===== */
#account-pill, .account-pill {
  position: fixed !important;
  bottom: 84px !important;
  left: 50% !important;
  transform: translateX(-50%) !important;
  z-index: 9999 !important;
}



/* ===== BUILD 4.120 – HOME account pill inside yellow card ===== */
#home-account-pill{
  position: relative !important;
  left: auto !important;
  top: auto !important;
  bottom: auto !important;
  transform: none !important;

  margin: 12px auto 0 auto !important;
  display: inline-flex !important;
  align-items: center !important;
  gap: 10px !important;

  padding: 8px 14px !important;
  border-radius: 999px !important;
  background: var(--coyote-red, #e00) !important;
  color: #fff !important;
  box-shadow: 0 6px 14px rgba(0,0,0,0.25) !important;
}

/* wrapper inside yellow home card */
.home-yellow-card .home-account-pill-wrapper{
  display: flex;
  justify-content: center;
  width: 100%;
}


/* ===== BUILD 4.120 – HOME account pill sotto Bikers nel riquadro giallo ===== */
.home-account-pill-wrapper{
  width: 100%;
  display: flex;
  justify-content: center;
  margin-top: 12px;
}

#home-account-pill{
  position: relative !important;
  inset: auto !important;
  left: auto !important;
  top: auto !important;
  bottom: auto !important;
  transform: none !important;
  z-index: 10 !important;

  display: inline-flex !important;
  align-items: center !important;
  gap: 10px !important;

  padding: 10px 14px !important;
  border-radius: 999px !important;
  background: var(--coyote-red, #e00) !important;
  color: #fff !important;
  box-shadow: 0 8px 18px rgba(0,0,0,0.28) !important;
  user-select: none !important;
  cursor: pointer !important;
}

/* Override definitivo contro vecchie regole "nero su nero" */
#home-view #home-account-pill{
  background: var(--coyote-red, #e00) !important;
  color: #fff !important;
  box-shadow: 0 8px 18px rgba(0,0,0,0.28) !important;
}

#home-account-pill:empty{ display:none !important; }



/* ===== BUILD 4.120 – HOME account button same size as others (white bg, red text) ===== */
#home-account-pill{
  /* eredita tutto da button{} e .home-btn (width:100%, padding, radius, ecc.) */
  background: #ffffff !important;
  color: var(--coyote-red, #e00) !important;
  box-shadow: 0 4px 12px rgba(0,0,0,0.18) !important;
}

/* se vuoi un bordo leggero per staccare dal giallo */
#home-account-pill{
  border: 2px solid rgba(0,0,0,0.08) !important;
}

#home-account-pill:empty{ display:none !important; }


/* ===== BUILD 4.120 – HOME account button IDENTICO agli altri ===== */
#home-account-pill{
  width: 100% !important;          /* identico agli altri */
  height: auto !important;
  padding: 14px 16px !important;   /* uguale agli home-btn */
  border-radius: 999px !important;

  display: flex !important;
  align-items: center !important;
  justify-content: center !important; /* TESTO PERFETTAMENTE CENTRATO */

  background: #ffffff !important;  /* BIANCO */
  color: #d40000 !important;       /* ROSSO */
  font-size: 20px !important;
  font-weight: 700 !important;

  box-shadow: 0 8px 18px rgba(0,0,0,0.25) !important;
  border: none !important;
}


/* ===== BUILD 4.120 – HOME account buttons under yellow card ===== */
.home-account-pill-wrapper{
  position:relative;
  margin-top:16px;
  display:flex;
  justify-content:center;
}


.home-account-pill-wrapper{
  margin-top:20px;
  display:flex;
  justify-content:center;
}
</style>





<style id="bp-rank-label-css">
.bp-rank-label{
  font-size:12px;
  font-weight:800;
  letter-spacing:1.5px;
  color:#6b7280;
  margin-top:6px;
  text-align:center;
}

/* Spazio tra numero classifica e icone */
.bp-rank-block,
.bp-rank-pos {
  margin-bottom: 30px !important;
}


/* ===== BUILD 4.120 – Account pill reposition ===== */
#account-pill, .account-pill {
  position: fixed !important;
  bottom: 84px !important;
  left: 50% !important;
  transform: translateX(-50%) !important;
  z-index: 9999 !important;
}



/* ===== BUILD 4.120 – HOME account pill inside yellow card ===== */
#home-account-pill{
  position: relative !important;
  left: auto !important;
  top: auto !important;
  bottom: auto !important;
  transform: none !important;

  margin: 12px auto 0 auto !important;
  display: inline-flex !important;
  align-items: center !important;
  gap: 10px !important;

  padding: 8px 14px !important;
  border-radius: 999px !important;
  background: var(--coyote-red, #e00) !important;
  color: #fff !important;
  box-shadow: 0 6px 14px rgba(0,0,0,0.25) !important;
}

/* wrapper inside yellow home card */
.home-yellow-card .home-account-pill-wrapper{
  display: flex;
  justify-content: center;
  width: 100%;
}


/* ===== BUILD 4.120 – HOME account pill sotto Bikers nel riquadro giallo ===== */
.home-account-pill-wrapper{
  width: 100%;
  display: flex;
  justify-content: center;
  margin-top: 12px;
}

#home-account-pill{
  position: relative !important;
  inset: auto !important;
  left: auto !important;
  top: auto !important;
  bottom: auto !important;
  transform: none !important;
  z-index: 10 !important;

  display: inline-flex !important;
  align-items: center !important;
  gap: 10px !important;

  padding: 10px 14px !important;
  border-radius: 999px !important;
  background: var(--coyote-red, #e00) !important;
  color: #fff !important;
  box-shadow: 0 8px 18px rgba(0,0,0,0.28) !important;
  user-select: none !important;
  cursor: pointer !important;
}

/* Override definitivo contro vecchie regole "nero su nero" */
#home-view #home-account-pill{
  background: var(--coyote-red, #e00) !important;
  color: #fff !important;
  box-shadow: 0 8px 18px rgba(0,0,0,0.28) !important;
}

#home-account-pill:empty{ display:none !important; }



/* ===== BUILD 4.120 – HOME account button same size as others (white bg, red text) ===== */
#home-account-pill{
  /* eredita tutto da button{} e .home-btn (width:100%, padding, radius, ecc.) */
  background: #ffffff !important;
  color: var(--coyote-red, #e00) !important;
  box-shadow: 0 4px 12px rgba(0,0,0,0.18) !important;
}

/* se vuoi un bordo leggero per staccare dal giallo */
#home-account-pill{
  border: 2px solid rgba(0,0,0,0.08) !important;
}

#home-account-pill:empty{ display:none !important; }


/* ===== BUILD 4.120 – HOME account button IDENTICO agli altri ===== */
#home-account-pill{
  width: 100% !important;          /* identico agli altri */
  height: auto !important;
  padding: 14px 16px !important;   /* uguale agli home-btn */
  border-radius: 999px !important;

  display: flex !important;
  align-items: center !important;
  justify-content: center !important; /* TESTO PERFETTAMENTE CENTRATO */

  background: #ffffff !important;  /* BIANCO */
  color: #d40000 !important;       /* ROSSO */
  font-size: 20px !important;
  font-weight: 700 !important;

  box-shadow: 0 8px 18px rgba(0,0,0,0.25) !important;
  border: none !important;
}


/* ===== BUILD 4.120 – HOME account buttons under yellow card ===== */
.home-account-pill-wrapper{
  position:relative;
  margin-top:16px;
  display:flex;
  justify-content:center;
}


.home-account-pill-wrapper{
  margin-top:20px;
  display:flex;
  justify-content:center;
}
</style>



<style id="bp-rank-order-fix">
.bp-return-row{
  display:flex !important;
  flex-direction:column !important;
  align-items:center !important;
}

.bp-rank-label{
  order:-2 !important;
  margin-bottom:6px !important;
}

.bp-rank-pos{
  order:-1 !important;
}

#bp-return-bike-performance{
  order:0 !important;
}

/* Spazio tra numero classifica e icone */
.bp-rank-block,
.bp-rank-pos {
  margin-bottom: 30px !important;
}


/* ===== BUILD 4.120 – Account pill reposition ===== */
#account-pill, .account-pill {
  position: fixed !important;
  bottom: 84px !important;
  left: 50% !important;
  transform: translateX(-50%) !important;
  z-index: 9999 !important;
}



/* ===== BUILD 4.120 – HOME account pill inside yellow card ===== */
#home-account-pill{
  position: relative !important;
  left: auto !important;
  top: auto !important;
  bottom: auto !important;
  transform: none !important;

  margin: 12px auto 0 auto !important;
  display: inline-flex !important;
  align-items: center !important;
  gap: 10px !important;

  padding: 8px 14px !important;
  border-radius: 999px !important;
  background: var(--coyote-red, #e00) !important;
  color: #fff !important;
  box-shadow: 0 6px 14px rgba(0,0,0,0.25) !important;
}

/* wrapper inside yellow home card */
.home-yellow-card .home-account-pill-wrapper{
  display: flex;
  justify-content: center;
  width: 100%;
}


/* ===== BUILD 4.120 – HOME account pill sotto Bikers nel riquadro giallo ===== */
.home-account-pill-wrapper{
  width: 100%;
  display: flex;
  justify-content: center;
  margin-top: 12px;
}

#home-account-pill{
  position: relative !important;
  inset: auto !important;
  left: auto !important;
  top: auto !important;
  bottom: auto !important;
  transform: none !important;
  z-index: 10 !important;

  display: inline-flex !important;
  align-items: center !important;
  gap: 10px !important;

  padding: 10px 14px !important;
  border-radius: 999px !important;
  background: var(--coyote-red, #e00) !important;
  color: #fff !important;
  box-shadow: 0 8px 18px rgba(0,0,0,0.28) !important;
  user-select: none !important;
  cursor: pointer !important;
}

/* Override definitivo contro vecchie regole "nero su nero" */
#home-view #home-account-pill{
  background: var(--coyote-red, #e00) !important;
  color: #fff !important;
  box-shadow: 0 8px 18px rgba(0,0,0,0.28) !important;
}

#home-account-pill:empty{ display:none !important; }



/* ===== BUILD 4.120 – HOME account button same size as others (white bg, red text) ===== */
#home-account-pill{
  /* eredita tutto da button{} e .home-btn (width:100%, padding, radius, ecc.) */
  background: #ffffff !important;
  color: var(--coyote-red, #e00) !important;
  box-shadow: 0 4px 12px rgba(0,0,0,0.18) !important;
}

/* se vuoi un bordo leggero per staccare dal giallo */
#home-account-pill{
  border: 2px solid rgba(0,0,0,0.08) !important;
}

#home-account-pill:empty{ display:none !important; }


/* ===== BUILD 4.120 – HOME account button IDENTICO agli altri ===== */
#home-account-pill{
  width: 100% !important;          /* identico agli altri */
  height: auto !important;
  padding: 14px 16px !important;   /* uguale agli home-btn */
  border-radius: 999px !important;

  display: flex !important;
  align-items: center !important;
  justify-content: center !important; /* TESTO PERFETTAMENTE CENTRATO */

  background: #ffffff !important;  /* BIANCO */
  color: #d40000 !important;       /* ROSSO */
  font-size: 20px !important;
  font-weight: 700 !important;

  box-shadow: 0 8px 18px rgba(0,0,0,0.25) !important;
  border: none !important;
}


/* ===== BUILD 4.120 – HOME account buttons under yellow card ===== */
.home-account-pill-wrapper{
  position:relative;
  margin-top:16px;
  display:flex;
  justify-content:center;
}


.home-account-pill-wrapper{
  margin-top:20px;
  display:flex;
  justify-content:center;
}
</style>



<style id="bp-rank-block-offset">
/* Move rank label, rank number and red button down together */
.bp-return-row{
  margin-top: 10px !important;
}

/* Spazio tra numero classifica e icone */
.bp-rank-block,
.bp-rank-pos {
  margin-bottom: 30px !important;
}


/* ===== BUILD 4.120 – Account pill reposition ===== */
#account-pill, .account-pill {
  position: fixed !important;
  bottom: 84px !important;
  left: 50% !important;
  transform: translateX(-50%) !important;
  z-index: 9999 !important;
}



/* ===== BUILD 4.120 – HOME account pill inside yellow card ===== */
#home-account-pill{
  position: relative !important;
  left: auto !important;
  top: auto !important;
  bottom: auto !important;
  transform: none !important;

  margin: 12px auto 0 auto !important;
  display: inline-flex !important;
  align-items: center !important;
  gap: 10px !important;

  padding: 8px 14px !important;
  border-radius: 999px !important;
  background: var(--coyote-red, #e00) !important;
  color: #fff !important;
  box-shadow: 0 6px 14px rgba(0,0,0,0.25) !important;
}

/* wrapper inside yellow home card */
.home-yellow-card .home-account-pill-wrapper{
  display: flex;
  justify-content: center;
  width: 100%;
}


/* ===== BUILD 4.120 – HOME account pill sotto Bikers nel riquadro giallo ===== */
.home-account-pill-wrapper{
  width: 100%;
  display: flex;
  justify-content: center;
  margin-top: 12px;
}

#home-account-pill{
  position: relative !important;
  inset: auto !important;
  left: auto !important;
  top: auto !important;
  bottom: auto !important;
  transform: none !important;
  z-index: 10 !important;

  display: inline-flex !important;
  align-items: center !important;
  gap: 10px !important;

  padding: 10px 14px !important;
  border-radius: 999px !important;
  background: var(--coyote-red, #e00) !important;
  color: #fff !important;
  box-shadow: 0 8px 18px rgba(0,0,0,0.28) !important;
  user-select: none !important;
  cursor: pointer !important;
}

/* Override definitivo contro vecchie regole "nero su nero" */
#home-view #home-account-pill{
  background: var(--coyote-red, #e00) !important;
  color: #fff !important;
  box-shadow: 0 8px 18px rgba(0,0,0,0.28) !important;
}

#home-account-pill:empty{ display:none !important; }



/* ===== BUILD 4.120 – HOME account button same size as others (white bg, red text) ===== */
#home-account-pill{
  /* eredita tutto da button{} e .home-btn (width:100%, padding, radius, ecc.) */
  background: #ffffff !important;
  color: var(--coyote-red, #e00) !important;
  box-shadow: 0 4px 12px rgba(0,0,0,0.18) !important;
}

/* se vuoi un bordo leggero per staccare dal giallo */
#home-account-pill{
  border: 2px solid rgba(0,0,0,0.08) !important;
}

#home-account-pill:empty{ display:none !important; }


/* ===== BUILD 4.120 – HOME account button IDENTICO agli altri ===== */
#home-account-pill{
  width: 100% !important;          /* identico agli altri */
  height: auto !important;
  padding: 14px 16px !important;   /* uguale agli home-btn */
  border-radius: 999px !important;

  display: flex !important;
  align-items: center !important;
  justify-content: center !important; /* TESTO PERFETTAMENTE CENTRATO */

  background: #ffffff !important;  /* BIANCO */
  color: #d40000 !important;       /* ROSSO */
  font-size: 20px !important;
  font-weight: 700 !important;

  box-shadow: 0 8px 18px rgba(0,0,0,0.25) !important;
  border: none !important;
}


/* ===== BUILD 4.120 – HOME account buttons under yellow card ===== */
.home-account-pill-wrapper{
  position:relative;
  margin-top:16px;
  display:flex;
  justify-content:center;
}


.home-account-pill-wrapper{
  margin-top:20px;
  display:flex;
  justify-content:center;
}
</style>



<style id="bp-biker-name-big">
/* Enlarge biker name (title) */
#bp-profile h2,
#bp-profile h3,
.bp-biker-name{
  font-size: 36px !important;
  font-weight: 900 !important;
  letter-spacing: 1px;
}

/* Spazio tra numero classifica e icone */
.bp-rank-block,
.bp-rank-pos {
  margin-bottom: 30px !important;
}


/* ===== BUILD 4.120 – Account pill reposition ===== */
#account-pill, .account-pill {
  position: fixed !important;
  bottom: 84px !important;
  left: 50% !important;
  transform: translateX(-50%) !important;
  z-index: 9999 !important;
}



/* ===== BUILD 4.120 – HOME account pill inside yellow card ===== */
#home-account-pill{
  position: relative !important;
  left: auto !important;
  top: auto !important;
  bottom: auto !important;
  transform: none !important;

  margin: 12px auto 0 auto !important;
  display: inline-flex !important;
  align-items: center !important;
  gap: 10px !important;

  padding: 8px 14px !important;
  border-radius: 999px !important;
  background: var(--coyote-red, #e00) !important;
  color: #fff !important;
  box-shadow: 0 6px 14px rgba(0,0,0,0.25) !important;
}

/* wrapper inside yellow home card */
.home-yellow-card .home-account-pill-wrapper{
  display: flex;
  justify-content: center;
  width: 100%;
}


/* ===== BUILD 4.120 – HOME account pill sotto Bikers nel riquadro giallo ===== */
.home-account-pill-wrapper{
  width: 100%;
  display: flex;
  justify-content: center;
  margin-top: 12px;
}

#home-account-pill{
  position: relative !important;
  inset: auto !important;
  left: auto !important;
  top: auto !important;
  bottom: auto !important;
  transform: none !important;
  z-index: 10 !important;

  display: inline-flex !important;
  align-items: center !important;
  gap: 10px !important;

  padding: 10px 14px !important;
  border-radius: 999px !important;
  background: var(--coyote-red, #e00) !important;
  color: #fff !important;
  box-shadow: 0 8px 18px rgba(0,0,0,0.28) !important;
  user-select: none !important;
  cursor: pointer !important;
}

/* Override definitivo contro vecchie regole "nero su nero" */
#home-view #home-account-pill{
  background: var(--coyote-red, #e00) !important;
  color: #fff !important;
  box-shadow: 0 8px 18px rgba(0,0,0,0.28) !important;
}

#home-account-pill:empty{ display:none !important; }



/* ===== BUILD 4.120 – HOME account button same size as others (white bg, red text) ===== */
#home-account-pill{
  /* eredita tutto da button{} e .home-btn (width:100%, padding, radius, ecc.) */
  background: #ffffff !important;
  color: var(--coyote-red, #e00) !important;
  box-shadow: 0 4px 12px rgba(0,0,0,0.18) !important;
}

/* se vuoi un bordo leggero per staccare dal giallo */
#home-account-pill{
  border: 2px solid rgba(0,0,0,0.08) !important;
}

#home-account-pill:empty{ display:none !important; }


/* ===== BUILD 4.120 – HOME account button IDENTICO agli altri ===== */
#home-account-pill{
  width: 100% !important;          /* identico agli altri */
  height: auto !important;
  padding: 14px 16px !important;   /* uguale agli home-btn */
  border-radius: 999px !important;

  display: flex !important;
  align-items: center !important;
  justify-content: center !important; /* TESTO PERFETTAMENTE CENTRATO */

  background: #ffffff !important;  /* BIANCO */
  color: #d40000 !important;       /* ROSSO */
  font-size: 20px !important;
  font-weight: 700 !important;

  box-shadow: 0 8px 18px rgba(0,0,0,0.25) !important;
  border: none !important;
}


/* ===== BUILD 4.120 – HOME account buttons under yellow card ===== */
.home-account-pill-wrapper{
  position:relative;
  margin-top:16px;
  display:flex;
  justify-content:center;
}


.home-account-pill-wrapper{
  margin-top:20px;
  display:flex;
  justify-content:center;
}
</style>



<style id="bp-biker-name-force">
/* Force enlarge biker name even if inline styles exist */
#bp-profile .bp-title,
#bp-profile .biker-name,
#bp-profile [data-biker-name]{
  font-size: 36px !important;
  font-weight: 900 !important;
  transform: scale(1.15);
  display: block;
}

/* Spazio tra numero classifica e icone */
.bp-rank-block,
.bp-rank-pos {
  margin-bottom: 30px !important;
}


/* ===== BUILD 4.120 – Account pill reposition ===== */
#account-pill, .account-pill {
  position: fixed !important;
  bottom: 84px !important;
  left: 50% !important;
  transform: translateX(-50%) !important;
  z-index: 9999 !important;
}



/* ===== BUILD 4.120 – HOME account pill inside yellow card ===== */
#home-account-pill{
  position: relative !important;
  left: auto !important;
  top: auto !important;
  bottom: auto !important;
  transform: none !important;

  margin: 12px auto 0 auto !important;
  display: inline-flex !important;
  align-items: center !important;
  gap: 10px !important;

  padding: 8px 14px !important;
  border-radius: 999px !important;
  background: var(--coyote-red, #e00) !important;
  color: #fff !important;
  box-shadow: 0 6px 14px rgba(0,0,0,0.25) !important;
}

/* wrapper inside yellow home card */
.home-yellow-card .home-account-pill-wrapper{
  display: flex;
  justify-content: center;
  width: 100%;
}


/* ===== BUILD 4.120 – HOME account pill sotto Bikers nel riquadro giallo ===== */
.home-account-pill-wrapper{
  width: 100%;
  display: flex;
  justify-content: center;
  margin-top: 12px;
}

#home-account-pill{
  position: relative !important;
  inset: auto !important;
  left: auto !important;
  top: auto !important;
  bottom: auto !important;
  transform: none !important;
  z-index: 10 !important;

  display: inline-flex !important;
  align-items: center !important;
  gap: 10px !important;

  padding: 10px 14px !important;
  border-radius: 999px !important;
  background: var(--coyote-red, #e00) !important;
  color: #fff !important;
  box-shadow: 0 8px 18px rgba(0,0,0,0.28) !important;
  user-select: none !important;
  cursor: pointer !important;
}

/* Override definitivo contro vecchie regole "nero su nero" */
#home-view #home-account-pill{
  background: var(--coyote-red, #e00) !important;
  color: #fff !important;
  box-shadow: 0 8px 18px rgba(0,0,0,0.28) !important;
}

#home-account-pill:empty{ display:none !important; }



/* ===== BUILD 4.120 – HOME account button same size as others (white bg, red text) ===== */
#home-account-pill{
  /* eredita tutto da button{} e .home-btn (width:100%, padding, radius, ecc.) */
  background: #ffffff !important;
  color: var(--coyote-red, #e00) !important;
  box-shadow: 0 4px 12px rgba(0,0,0,0.18) !important;
}

/* se vuoi un bordo leggero per staccare dal giallo */
#home-account-pill{
  border: 2px solid rgba(0,0,0,0.08) !important;
}

#home-account-pill:empty{ display:none !important; }


/* ===== BUILD 4.120 – HOME account button IDENTICO agli altri ===== */
#home-account-pill{
  width: 100% !important;          /* identico agli altri */
  height: auto !important;
  padding: 14px 16px !important;   /* uguale agli home-btn */
  border-radius: 999px !important;

  display: flex !important;
  align-items: center !important;
  justify-content: center !important; /* TESTO PERFETTAMENTE CENTRATO */

  background: #ffffff !important;  /* BIANCO */
  color: #d40000 !important;       /* ROSSO */
  font-size: 20px !important;
  font-weight: 700 !important;

  box-shadow: 0 8px 18px rgba(0,0,0,0.25) !important;
  border: none !important;
}


/* ===== BUILD 4.120 – HOME account buttons under yellow card ===== */
.home-account-pill-wrapper{
  position:relative;
  margin-top:16px;
  display:flex;
  justify-content:center;
}


.home-account-pill-wrapper{
  margin-top:20px;
  display:flex;
  justify-content:center;
}
</style>



<style id="bp-icons-lower">
.bp-campaign-icons,
#bp-profile .icons-row,
#bp-profile .icon-row{
  margin-top: 30px !important;
}

/* Spazio tra numero classifica e icone */
.bp-rank-block,
.bp-rank-pos {
  margin-bottom: 30px !important;
}


/* ===== BUILD 4.120 – Account pill reposition ===== */
#account-pill, .account-pill {
  position: fixed !important;
  bottom: 84px !important;
  left: 50% !important;
  transform: translateX(-50%) !important;
  z-index: 9999 !important;
}



/* ===== BUILD 4.120 – HOME account pill inside yellow card ===== */
#home-account-pill{
  position: relative !important;
  left: auto !important;
  top: auto !important;
  bottom: auto !important;
  transform: none !important;

  margin: 12px auto 0 auto !important;
  display: inline-flex !important;
  align-items: center !important;
  gap: 10px !important;

  padding: 8px 14px !important;
  border-radius: 999px !important;
  background: var(--coyote-red, #e00) !important;
  color: #fff !important;
  box-shadow: 0 6px 14px rgba(0,0,0,0.25) !important;
}

/* wrapper inside yellow home card */
.home-yellow-card .home-account-pill-wrapper{
  display: flex;
  justify-content: center;
  width: 100%;
}


/* ===== BUILD 4.120 – HOME account pill sotto Bikers nel riquadro giallo ===== */
.home-account-pill-wrapper{
  width: 100%;
  display: flex;
  justify-content: center;
  margin-top: 12px;
}

#home-account-pill{
  position: relative !important;
  inset: auto !important;
  left: auto !important;
  top: auto !important;
  bottom: auto !important;
  transform: none !important;
  z-index: 10 !important;

  display: inline-flex !important;
  align-items: center !important;
  gap: 10px !important;

  padding: 10px 14px !important;
  border-radius: 999px !important;
  background: var(--coyote-red, #e00) !important;
  color: #fff !important;
  box-shadow: 0 8px 18px rgba(0,0,0,0.28) !important;
  user-select: none !important;
  cursor: pointer !important;
}

/* Override definitivo contro vecchie regole "nero su nero" */
#home-view #home-account-pill{
  background: var(--coyote-red, #e00) !important;
  color: #fff !important;
  box-shadow: 0 8px 18px rgba(0,0,0,0.28) !important;
}

#home-account-pill:empty{ display:none !important; }



/* ===== BUILD 4.120 – HOME account button same size as others (white bg, red text) ===== */
#home-account-pill{
  /* eredita tutto da button{} e .home-btn (width:100%, padding, radius, ecc.) */
  background: #ffffff !important;
  color: var(--coyote-red, #e00) !important;
  box-shadow: 0 4px 12px rgba(0,0,0,0.18) !important;
}

/* se vuoi un bordo leggero per staccare dal giallo */
#home-account-pill{
  border: 2px solid rgba(0,0,0,0.08) !important;
}

#home-account-pill:empty{ display:none !important; }


/* ===== BUILD 4.120 – HOME account button IDENTICO agli altri ===== */
#home-account-pill{
  width: 100% !important;          /* identico agli altri */
  height: auto !important;
  padding: 14px 16px !important;   /* uguale agli home-btn */
  border-radius: 999px !important;

  display: flex !important;
  align-items: center !important;
  justify-content: center !important; /* TESTO PERFETTAMENTE CENTRATO */

  background: #ffffff !important;  /* BIANCO */
  color: #d40000 !important;       /* ROSSO */
  font-size: 20px !important;
  font-weight: 700 !important;

  box-shadow: 0 8px 18px rgba(0,0,0,0.25) !important;
  border: none !important;
}


/* ===== BUILD 4.120 – HOME account buttons under yellow card ===== */
.home-account-pill-wrapper{
  position:relative;
  margin-top:16px;
  display:flex;
  justify-content:center;
}


.home-account-pill-wrapper{
  margin-top:20px;
  display:flex;
  justify-content:center;
}
</style>



<style id="bp-profile-layout-unbind">
/* Profile layout: separate blocks (name, icons, rank, button) */
#bp-profile{
  display:flex;
  flex-direction:column;
  align-items:center;
  gap: 18px;
}

/* BIG biker name (real node) */
#bp-profile-name{
  font-size: 38px !important;
  font-weight: 900 !important;
  letter-spacing: 1px;
  text-align:center;
  color: var(--coyote-red);
  margin: 8px 0 0 !important;
}

/* Icons block */
.bp-icon-grid{
  margin-top: 8px !important;
}

/* Rank block */
.bp-rank-block{
  display:flex;
  flex-direction:column;
  align-items:center;
  gap: 10px;
  margin-top: 4px;
}

.bp-rank-label{
  font-size: 12px;
  font-weight: 800;
  letter-spacing: 1.5px;
  color:#6b7280;
  text-align:center;
  margin: 0 !important;
}

/* Button row (only button) */
.bp-return-row{
  width:100%;
  display:flex;
  justify-content:center;
  margin-top: 6px !important;
}

/* Spazio tra numero classifica e icone */
.bp-rank-block,
.bp-rank-pos {
  margin-bottom: 30px !important;
}


/* ===== BUILD 4.120 – Account pill reposition ===== */
#account-pill, .account-pill {
  position: fixed !important;
  bottom: 84px !important;
  left: 50% !important;
  transform: translateX(-50%) !important;
  z-index: 9999 !important;
}



/* ===== BUILD 4.120 – HOME account pill inside yellow card ===== */
#home-account-pill{
  position: relative !important;
  left: auto !important;
  top: auto !important;
  bottom: auto !important;
  transform: none !important;

  margin: 12px auto 0 auto !important;
  display: inline-flex !important;
  align-items: center !important;
  gap: 10px !important;

  padding: 8px 14px !important;
  border-radius: 999px !important;
  background: var(--coyote-red, #e00) !important;
  color: #fff !important;
  box-shadow: 0 6px 14px rgba(0,0,0,0.25) !important;
}

/* wrapper inside yellow home card */
.home-yellow-card .home-account-pill-wrapper{
  display: flex;
  justify-content: center;
  width: 100%;
}


/* ===== BUILD 4.120 – HOME account pill sotto Bikers nel riquadro giallo ===== */
.home-account-pill-wrapper{
  width: 100%;
  display: flex;
  justify-content: center;
  margin-top: 12px;
}

#home-account-pill{
  position: relative !important;
  inset: auto !important;
  left: auto !important;
  top: auto !important;
  bottom: auto !important;
  transform: none !important;
  z-index: 10 !important;

  display: inline-flex !important;
  align-items: center !important;
  gap: 10px !important;

  padding: 10px 14px !important;
  border-radius: 999px !important;
  background: var(--coyote-red, #e00) !important;
  color: #fff !important;
  box-shadow: 0 8px 18px rgba(0,0,0,0.28) !important;
  user-select: none !important;
  cursor: pointer !important;
}

/* Override definitivo contro vecchie regole "nero su nero" */
#home-view #home-account-pill{
  background: var(--coyote-red, #e00) !important;
  color: #fff !important;
  box-shadow: 0 8px 18px rgba(0,0,0,0.28) !important;
}

#home-account-pill:empty{ display:none !important; }



/* ===== BUILD 4.120 – HOME account button same size as others (white bg, red text) ===== */
#home-account-pill{
  /* eredita tutto da button{} e .home-btn (width:100%, padding, radius, ecc.) */
  background: #ffffff !important;
  color: var(--coyote-red, #e00) !important;
  box-shadow: 0 4px 12px rgba(0,0,0,0.18) !important;
}

/* se vuoi un bordo leggero per staccare dal giallo */
#home-account-pill{
  border: 2px solid rgba(0,0,0,0.08) !important;
}

#home-account-pill:empty{ display:none !important; }


/* ===== BUILD 4.120 – HOME account button IDENTICO agli altri ===== */
#home-account-pill{
  width: 100% !important;          /* identico agli altri */
  height: auto !important;
  padding: 14px 16px !important;   /* uguale agli home-btn */
  border-radius: 999px !important;

  display: flex !important;
  align-items: center !important;
  justify-content: center !important; /* TESTO PERFETTAMENTE CENTRATO */

  background: #ffffff !important;  /* BIANCO */
  color: #d40000 !important;       /* ROSSO */
  font-size: 20px !important;
  font-weight: 700 !important;

  box-shadow: 0 8px 18px rgba(0,0,0,0.25) !important;
  border: none !important;
}


/* ===== BUILD 4.120 – HOME account buttons under yellow card ===== */
.home-account-pill-wrapper{
  position:relative;
  margin-top:16px;
  display:flex;
  justify-content:center;
}


.home-account-pill-wrapper{
  margin-top:20px;
  display:flex;
  justify-content:center;
}
</style>



<style id="bp-icon-group-css">
/* Group the 5 icons in a single centered row */
.bp-icon-group{
  width: min(92vw, 560px);
  display:flex;
  justify-content:center;
  margin-top: 10px;
  margin-bottom: 10px;
}
.bp-icon-grid{
  width: 100%;
  display:flex;
  justify-content:space-between;
  gap: 14px;
  flex-wrap: nowrap;
}
.bp-icon-btn{
  flex: 0 0 auto;
}

/* Spazio tra numero classifica e icone */
.bp-rank-block,
.bp-rank-pos {
  margin-bottom: 30px !important;
}


/* ===== BUILD 4.120 – Account pill reposition ===== */
#account-pill, .account-pill {
  position: fixed !important;
  bottom: 84px !important;
  left: 50% !important;
  transform: translateX(-50%) !important;
  z-index: 9999 !important;
}



/* ===== BUILD 4.120 – HOME account pill inside yellow card ===== */
#home-account-pill{
  position: relative !important;
  left: auto !important;
  top: auto !important;
  bottom: auto !important;
  transform: none !important;

  margin: 12px auto 0 auto !important;
  display: inline-flex !important;
  align-items: center !important;
  gap: 10px !important;

  padding: 8px 14px !important;
  border-radius: 999px !important;
  background: var(--coyote-red, #e00) !important;
  color: #fff !important;
  box-shadow: 0 6px 14px rgba(0,0,0,0.25) !important;
}

/* wrapper inside yellow home card */
.home-yellow-card .home-account-pill-wrapper{
  display: flex;
  justify-content: center;
  width: 100%;
}


/* ===== BUILD 4.120 – HOME account pill sotto Bikers nel riquadro giallo ===== */
.home-account-pill-wrapper{
  width: 100%;
  display: flex;
  justify-content: center;
  margin-top: 12px;
}

#home-account-pill{
  position: relative !important;
  inset: auto !important;
  left: auto !important;
  top: auto !important;
  bottom: auto !important;
  transform: none !important;
  z-index: 10 !important;

  display: inline-flex !important;
  align-items: center !important;
  gap: 10px !important;

  padding: 10px 14px !important;
  border-radius: 999px !important;
  background: var(--coyote-red, #e00) !important;
  color: #fff !important;
  box-shadow: 0 8px 18px rgba(0,0,0,0.28) !important;
  user-select: none !important;
  cursor: pointer !important;
}

/* Override definitivo contro vecchie regole "nero su nero" */
#home-view #home-account-pill{
  background: var(--coyote-red, #e00) !important;
  color: #fff !important;
  box-shadow: 0 8px 18px rgba(0,0,0,0.28) !important;
}

#home-account-pill:empty{ display:none !important; }



/* ===== BUILD 4.120 – HOME account button same size as others (white bg, red text) ===== */
#home-account-pill{
  /* eredita tutto da button{} e .home-btn (width:100%, padding, radius, ecc.) */
  background: #ffffff !important;
  color: var(--coyote-red, #e00) !important;
  box-shadow: 0 4px 12px rgba(0,0,0,0.18) !important;
}

/* se vuoi un bordo leggero per staccare dal giallo */
#home-account-pill{
  border: 2px solid rgba(0,0,0,0.08) !important;
}

#home-account-pill:empty{ display:none !important; }


/* ===== BUILD 4.120 – HOME account button IDENTICO agli altri ===== */
#home-account-pill{
  width: 100% !important;          /* identico agli altri */
  height: auto !important;
  padding: 14px 16px !important;   /* uguale agli home-btn */
  border-radius: 999px !important;

  display: flex !important;
  align-items: center !important;
  justify-content: center !important; /* TESTO PERFETTAMENTE CENTRATO */

  background: #ffffff !important;  /* BIANCO */
  color: #d40000 !important;       /* ROSSO */
  font-size: 20px !important;
  font-weight: 700 !important;

  box-shadow: 0 8px 18px rgba(0,0,0,0.25) !important;
  border: none !important;
}


/* ===== BUILD 4.120 – HOME account buttons under yellow card ===== */
.home-account-pill-wrapper{
  position:relative;
  margin-top:16px;
  display:flex;
  justify-content:center;
}


.home-account-pill-wrapper{
  margin-top:20px;
  display:flex;
  justify-content:center;
}
</style>



<style id="bp-icon-group-fix-width">
/* Fix: keep the 5 icons fully INSIDE the white card on mobile */
.bp-icon-group{
  width: 100% !important;
  padding: 0 18px !important;
  box-sizing: border-box !important;
  overflow: hidden !important;
}
.bp-icon-grid{
  width: 100% !important;
  max-width: 100% !important;
  justify-content: space-between !important;
  gap: 10px !important;
}

/* allow icons to shrink to fit */
.bp-icon-grid > *{
  flex: 1 1 0 !important;
  min-width: 0 !important;
}

/* cap each icon size so 5 fit */
.bp-icon-grid .bp-icon-btn,
.bp-icon-grid button,
.bp-icon-grid .bp-icon{
  max-width: 72px !important;
}

/* Spazio tra numero classifica e icone */
.bp-rank-block,
.bp-rank-pos {
  margin-bottom: 30px !important;
}


/* ===== BUILD 4.120 – Account pill reposition ===== */
#account-pill, .account-pill {
  position: fixed !important;
  bottom: 84px !important;
  left: 50% !important;
  transform: translateX(-50%) !important;
  z-index: 9999 !important;
}



/* ===== BUILD 4.120 – HOME account pill inside yellow card ===== */
#home-account-pill{
  position: relative !important;
  left: auto !important;
  top: auto !important;
  bottom: auto !important;
  transform: none !important;

  margin: 12px auto 0 auto !important;
  display: inline-flex !important;
  align-items: center !important;
  gap: 10px !important;

  padding: 8px 14px !important;
  border-radius: 999px !important;
  background: var(--coyote-red, #e00) !important;
  color: #fff !important;
  box-shadow: 0 6px 14px rgba(0,0,0,0.25) !important;
}

/* wrapper inside yellow home card */
.home-yellow-card .home-account-pill-wrapper{
  display: flex;
  justify-content: center;
  width: 100%;
}


/* ===== BUILD 4.120 – HOME account pill sotto Bikers nel riquadro giallo ===== */
.home-account-pill-wrapper{
  width: 100%;
  display: flex;
  justify-content: center;
  margin-top: 12px;
}

#home-account-pill{
  position: relative !important;
  inset: auto !important;
  left: auto !important;
  top: auto !important;
  bottom: auto !important;
  transform: none !important;
  z-index: 10 !important;

  display: inline-flex !important;
  align-items: center !important;
  gap: 10px !important;

  padding: 10px 14px !important;
  border-radius: 999px !important;
  background: var(--coyote-red, #e00) !important;
  color: #fff !important;
  box-shadow: 0 8px 18px rgba(0,0,0,0.28) !important;
  user-select: none !important;
  cursor: pointer !important;
}

/* Override definitivo contro vecchie regole "nero su nero" */
#home-view #home-account-pill{
  background: var(--coyote-red, #e00) !important;
  color: #fff !important;
  box-shadow: 0 8px 18px rgba(0,0,0,0.28) !important;
}

#home-account-pill:empty{ display:none !important; }



/* ===== BUILD 4.120 – HOME account button same size as others (white bg, red text) ===== */
#home-account-pill{
  /* eredita tutto da button{} e .home-btn (width:100%, padding, radius, ecc.) */
  background: #ffffff !important;
  color: var(--coyote-red, #e00) !important;
  box-shadow: 0 4px 12px rgba(0,0,0,0.18) !important;
}

/* se vuoi un bordo leggero per staccare dal giallo */
#home-account-pill{
  border: 2px solid rgba(0,0,0,0.08) !important;
}

#home-account-pill:empty{ display:none !important; }


/* ===== BUILD 4.120 – HOME account button IDENTICO agli altri ===== */
#home-account-pill{
  width: 100% !important;          /* identico agli altri */
  height: auto !important;
  padding: 14px 16px !important;   /* uguale agli home-btn */
  border-radius: 999px !important;

  display: flex !important;
  align-items: center !important;
  justify-content: center !important; /* TESTO PERFETTAMENTE CENTRATO */

  background: #ffffff !important;  /* BIANCO */
  color: #d40000 !important;       /* ROSSO */
  font-size: 20px !important;
  font-weight: 700 !important;

  box-shadow: 0 8px 18px rgba(0,0,0,0.25) !important;
  border: none !important;
}


/* ===== BUILD 4.120 – HOME account buttons under yellow card ===== */
.home-account-pill-wrapper{
  position:relative;
  margin-top:16px;
  display:flex;
  justify-content:center;
}


.home-account-pill-wrapper{
  margin-top:20px;
  display:flex;
  justify-content:center;
}
</style>



<style id="crs-banner-style">

/* ===== BUILD 4.120 – GLOBAL banner ===== */
#global-banner{
  position: sticky;
  top: 0;
  z-index: 10050;
  width: 100%;
  background: transparent;
  display: flex;
  justify-content: center;
  padding: 12px 12px 22px 12px; /* più spazio dal tasto home */
}
#global-banner img{
  width: 100%;
  max-width: 420px;
  height: auto;
  border-radius: 14px;
  box-shadow: 0 8px 24px rgba(0,0,0,0.45);
  display: block;
}

</style>
<style id="crs-liquid-glass-style">
/* ===============================
   LIQUID GLASS THEME – BUILD 4.120
   (injected as separate <style>)
   =============================== */
:root{
  --lg-surface: rgba(255,255,255,0.10);
  --lg-surface-2: rgba(255,255,255,0.16);
  --lg-border: rgba(255,255,255,0.26);
  --lg-border-strong: rgba(255,255,255,0.42);
  --lg-shadow: 0 16px 50px rgba(0,0,0,0.45);
  --lg-shadow-soft: 0 10px 28px rgba(0,0,0,0.30);
  --lg-blur: 22px;
  --lg-radius: 22px;
  --lg-radius-pill: 999px;
}

/* Glass base surfaces */
.container,
.home-box,
.ranking,
.player-card,
#test-inputs,
.bp-history,
.bp-item,
.biker-modal,
.account-modal,
.auth-card{
  background: linear-gradient(180deg, rgba(255,255,255,0.18), rgba(255,255,255,0.08)) !important;
  border: 1px solid var(--lg-border) !important;
  border-top-color: rgba(255,255,255,0.42) !important;
  border-left-color: rgba(255,255,255,0.28) !important;
  border-radius: var(--lg-radius) !important;
  box-shadow: var(--lg-shadow-soft) !important;
  backdrop-filter: blur(var(--lg-blur)) saturate(185%) contrast(115%) !important;
  -webkit-backdrop-filter: blur(var(--lg-blur)) saturate(185%) contrast(115%) !important;
}

/* Buttons -> glass pill */
.btn,
.home-btn,
.btn-small,
.auth-button,
.bp-back-btn,
.bp-return-btn,
.biker-modal-btn,
.tsb-icon-btn,
#home-logout-btn,
#home-account-pill{
  border: 2px solid var(--lg-border-strong) !important;
  border-top-color: rgba(255,255,255,0.55) !important;
  border-left-color: rgba(255,255,255,0.35) !important;
  background: linear-gradient(180deg, rgba(255,255,255,0.22), rgba(255,255,255,0.10)) !important;
  color: #ffffff !important;
  border-radius: var(--lg-radius-pill) !important;
  box-shadow: 0 10px 26px rgba(0,0,0,0.35) !important;
  backdrop-filter: blur(calc(var(--lg-blur) + 6px)) saturate(200%) contrast(120%) !important;
  -webkit-backdrop-filter: blur(calc(var(--lg-blur) + 6px)) saturate(200%) contrast(120%) !important;
}

/* ===== BUILD 4.120 – Apple-like glass buttons (thicker + stronger distortion) ===== */
.btn,
.home-btn,
.btn-small,
.auth-button,
.bp-back-btn,
.bp-return-btn,
.biker-modal-btn,
.tsb-icon-btn,
#home-logout-btn,
#home-account-pill{
  position: relative !important;
  overflow: hidden !important;
  transform: translateZ(0);
  box-shadow:
    0 14px 34px rgba(0,0,0,0.38),
    inset 0 1px 0 rgba(255,255,255,0.55),
    inset 0 -10px 18px rgba(0,0,0,0.28),
    inset 0 0 0 1px rgba(0,0,0,0.12) !important;
}

/* subtle highlight */
.btn::before,
.home-btn::before,
.btn-small::before,
.auth-button::before,
.bp-back-btn::before,
.bp-return-btn::before,
.biker-modal-btn::before,
.tsb-icon-btn::before,
#home-logout-btn::before,
#home-account-pill::before{
  content:"";
  position:absolute;
  inset:-1px;
  border-radius: inherit;
  pointer-events:none;
  background:
    radial-gradient(120% 90% at 30% 20%, rgba(255,255,255,0.55), rgba(255,255,255,0.10) 45%, rgba(255,255,255,0.00) 70%),
    linear-gradient(180deg, rgba(255,255,255,0.18), rgba(255,255,255,0.06));
  opacity: 0.85;
  mix-blend-mode: overlay;
}

/* pressed */
.btn:active,
.home-btn:active,
.btn-small:active,
.auth-button:active,
.bp-back-btn:active,
.bp-return-btn:active,
.biker-modal-btn:active,
.tsb-icon-btn:active,
#home-logout-btn:active,
#home-account-pill:active{
  transform: translateY(1px) scale(0.995);
  box-shadow:
    0 10px 26px rgba(0,0,0,0.34),
    inset 0 1px 0 rgba(255,255,255,0.40),
    inset 0 -14px 22px rgba(0,0,0,0.32),
    inset 0 0 0 1px rgba(0,0,0,0.16) !important;
}

/* Accent variants */
#btn-db, .btn-db-save, .biker-modal-btn-primary{
  color: #111827 !important;
  background: linear-gradient(180deg, rgba(253,224,0,0.75), rgba(253,224,0,0.35)) !important;
  border-color: rgba(253,224,0,0.55) !important;
}
#btn-select, #btn-gara, #calc-btn, #save-race-button, .btn-db-add, .auth-button{
  background: linear-gradient(180deg, rgba(204,0,0,0.70), rgba(204,0,0,0.28)) !important;
  border-color: rgba(255,255,255,0.30) !important;
}
#btn-reset, #test-reset-btn{
  background: linear-gradient(180deg, rgba(148,163,184,0.50), rgba(148,163,184,0.20)) !important;
}

/* Inputs -> glass */
input, select, textarea{
  background: rgba(255,255,255,0.10) !important;
  border: 1px solid var(--lg-border) !important;
  border-top-color: rgba(255,255,255,0.38) !important;
  border-left-color: rgba(255,255,255,0.26) !important;
  border-radius: 16px !important;
  backdrop-filter: blur(var(--lg-blur)) saturate(185%) contrast(115%) !important;
  -webkit-backdrop-filter: blur(var(--lg-blur)) saturate(185%) contrast(115%) !important;
  box-shadow: 0 8px 18px rgba(0,0,0,0.20) !important;
}

/* Overlays */
#auth-overlay,
#biker-modal-overlay,
#account-overlay,
#loading-popup-overlay,
#bikers-loading-overlay{
  background: rgba(0,0,0,0.62) !important;
  backdrop-filter: blur(10px) !important;
  -webkit-backdrop-filter: blur(10px) !important;
}


/* ===== BUILD 4.120 – Glass calendar + performance panels ===== */

/* Calendar day cells & header */
#race-calendar,
#race-calendar .calendar,
#race-calendar .calendar-header,
#race-calendar .calendar-grid,
#race-calendar .calendar-day,
#race-calendar .day,
#race-calendar button{
  background: rgba(255,255,255,0.14) !important;
  backdrop-filter: blur(calc(var(--lg-blur) + 6px)) saturate(160%) !important;
  -webkit-backdrop-filter: blur(calc(var(--lg-blur) + 6px)) saturate(160%) !important;
  border: 1px solid rgba(255,255,255,0.28) !important;
  border-radius: 14px !important;
}

/* Selected days stronger glass */
#race-calendar .selected,
#race-calendar .active{
  background: rgba(255,255,255,0.26) !important;
  box-shadow: 0 10px 24px rgba(0,0,0,0.35) !important;
}

/* Performance main panel */
#performance-race-header,
#test-ranking-box,
.bp-profile,
.bp-history,
.bp-race-card{
  background: rgba(255,255,255,0.14) !important;
  backdrop-filter: blur(calc(var(--lg-blur) + 4px)) saturate(150%) !important;
  -webkit-backdrop-filter: blur(calc(var(--lg-blur) + 4px)) saturate(150%) !important;
  border: 1px solid rgba(255,255,255,0.30) !important;
  border-radius: var(--lg-radius) !important;
  box-shadow: 0 14px 34px rgba(0,0,0,0.35) !important;
}

/* Buttons inside performance */
#performance-race-header .btn,
#performance-race-header .home-btn,
#performance-race-header button{
  background: rgba(255,255,255,0.18) !important;
  backdrop-filter: blur(var(--lg-blur)) saturate(160%) !important;
}

/* Chart / bars background glass */
#performance-view canvas,
#performance-view svg,
.bp-chart,
.bp-bars{
  background: rgba(255,255,255,0.10) !important;
  border-radius: 18px !important;
  backdrop-filter: blur(var(--lg-blur)) saturate(185%) contrast(115%) !important;
}


/* ===== BUILD 4.120 – Override inline backgrounds (Performance) ===== */

/* Main performance white panel (inline background) -> glass */
#performance-chart,
#performance-chart *{
  box-sizing: border-box;
}

#performance-chart{
  background: rgba(255,255,255,0.14) !important;
  border: 1px solid rgba(255,255,255,0.28) !important;
  border-top-color: rgba(255,255,255,0.46) !important;
  border-left-color: rgba(255,255,255,0.30) !important;
  border-radius: var(--lg-radius) !important;
  box-shadow: 0 16px 44px rgba(0,0,0,0.40) !important;
  backdrop-filter: blur(calc(var(--lg-blur) + 8px)) saturate(160%) !important;
  -webkit-backdrop-filter: blur(calc(var(--lg-blur) + 8px)) saturate(160%) !important;
  padding: 14px 14px 18px !important;
}

/* Bars container - keep transparent */
#performance-bars{
  background: rgba(255,255,255,0.06) !important;
  border-radius: 18px !important;
}

/* Performance buttons (inline colors) -> glass */
#performance-overall-btn,
#performance-race-btn,
#performance-reset-btn{
  background: linear-gradient(180deg, rgba(255,255,255,0.22), rgba(255,255,255,0.10)) !important;
  border: 1px solid rgba(255,255,255,0.34) !important;
  border-top-color: rgba(255,255,255,0.55) !important;
  border-left-color: rgba(255,255,255,0.35) !important;
  color: #ffffff !important;
  box-shadow: 0 10px 26px rgba(0,0,0,0.34) !important;
  backdrop-filter: blur(var(--lg-blur)) saturate(160%) !important;
  -webkit-backdrop-filter: blur(var(--lg-blur)) saturate(160%) !important;
}

/* Optional: keep subtle semantic tint (glass + tint) */
#performance-overall-btn{
  background: linear-gradient(180deg, rgba(253,224,0,0.35), rgba(255,255,255,0.10)) !important;
  color: #111827 !important;
}
#performance-race-btn{
  background: linear-gradient(180deg, rgba(22,163,74,0.35), rgba(255,255,255,0.10)) !important;
}
#performance-reset-btn{
  background: linear-gradient(180deg, rgba(220,38,38,0.32), rgba(255,255,255,0.10)) !important;
}



/* ===== BUILD 4.120 – Calendar readability (less glass) ===== */

/* Make calendar panel more solid and readable */
#race-calendar{
  background: rgba(255,255,255,0.78) !important; /* less transparent */
  backdrop-filter: blur(10px) saturate(120%) !important;
  -webkit-backdrop-filter: blur(10px) saturate(120%) !important;
  border: 1px solid rgba(0,0,0,0.10) !important;
  box-shadow: 0 18px 50px rgba(0,0,0,0.35) !important;
}

/* Calendar text dark */
#race-calendar,
#race-calendar h1,
#race-calendar h2,
#race-calendar h3,
#race-calendar p,
#race-calendar span,
#race-calendar div,
#race-calendar button{
  color: #111827 !important;
}

/* Day cells: mild glass, not see-through */
#race-calendar .day,
#race-calendar .day-cell,
#race-calendar .calendar-day,
#race-calendar .calendar-cell,
#race-calendar td,
#race-calendar th{
  background: rgba(255,255,255,0.55) !important;
  border: 1px solid rgba(0,0,0,0.08) !important;
  backdrop-filter: blur(6px) saturate(115%) !important;
  -webkit-backdrop-filter: blur(6px) saturate(115%) !important;
}

/* Selected day: clear highlight */
#race-calendar .selected,
#race-calendar .active{
  background: rgba(253,224,0,0.45) !important;
  border-color: rgba(253,224,0,0.55) !important;
  box-shadow: 0 10px 20px rgba(0,0,0,0.18) !important;
}

/* Header controls buttons: clearer */
#race-calendar button,
#race-calendar .btn,
#race-calendar .home-btn,
#race-calendar .btn-small{
  background: rgba(255,255,255,0.70) !important;
  border: 1px solid rgba(0,0,0,0.10) !important;
  backdrop-filter: blur(6px) saturate(120%) !important;
  -webkit-backdrop-filter: blur(6px) saturate(120%) !important;
}

/* Close button: crisp */
#race-calendar .close,
#race-calendar .close-btn,
#race-calendar .x,
#race-calendar .dismiss{
  background: rgba(255,255,255,0.75) !important;
}



/* ===== BUILD 4.120 – Glass charts & trend popup ===== */

/* Trend/graphs popup card -> glass */
.bp-popup-card{
  background: rgba(255,255,255,0.14) !important;
  border: 1px solid rgba(255,255,255,0.28) !important;
  border-top-color: rgba(255,255,255,0.46) !important;
  border-left-color: rgba(255,255,255,0.30) !important;
  border-radius: var(--lg-radius) !important;
  box-shadow: 0 18px 50px rgba(0,0,0,0.45) !important;
  backdrop-filter: blur(calc(var(--lg-blur) + 8px)) saturate(155%) !important;
  -webkit-backdrop-filter: blur(calc(var(--lg-blur) + 8px)) saturate(155%) !important;
  overflow: hidden !important;
}

/* Header: slightly darker glass for contrast */
.bp-popup-header{
  background: rgba(15,23,42,0.42) !important;
  border-bottom: 1px solid rgba(255,255,255,0.18) !important;
  backdrop-filter: blur(calc(var(--lg-blur) + 6px)) saturate(140%) !important;
  -webkit-backdrop-filter: blur(calc(var(--lg-blur) + 6px)) saturate(140%) !important;
}

/* Title and close button readable */
.bp-popup-title{
  color: #ffffff !important;
}
.bp-popup-close{
  background: rgba(255,255,255,0.14) !important;
  border: 1px solid rgba(255,255,255,0.22) !important;
  color: #ffffff !important;
  backdrop-filter: blur(calc(var(--lg-blur) + 6px)) saturate(200%) contrast(120%) !important;
  -webkit-backdrop-filter: blur(calc(var(--lg-blur) + 6px)) saturate(200%) contrast(120%) !important;
}

/* ===== BUILD 4.120 – Apple-like glass buttons (thicker + stronger distortion) ===== */
.btn,
.home-btn,
.btn-small,
.auth-button,
.bp-back-btn,
.bp-return-btn,
.biker-modal-btn,
.tsb-icon-btn,
#home-logout-btn,
#home-account-pill{
  position: relative !important;
  overflow: hidden !important;
  transform: translateZ(0);
  box-shadow:
    0 14px 34px rgba(0,0,0,0.38),
    inset 0 1px 0 rgba(255,255,255,0.55),
    inset 0 -10px 18px rgba(0,0,0,0.28),
    inset 0 0 0 1px rgba(0,0,0,0.12) !important;
}

/* subtle highlight */
.btn::before,
.home-btn::before,
.btn-small::before,
.auth-button::before,
.bp-back-btn::before,
.bp-return-btn::before,
.biker-modal-btn::before,
.tsb-icon-btn::before,
#home-logout-btn::before,
#home-account-pill::before{
  content:"";
  position:absolute;
  inset:-1px;
  border-radius: inherit;
  pointer-events:none;
  background:
    radial-gradient(120% 90% at 30% 20%, rgba(255,255,255,0.55), rgba(255,255,255,0.10) 45%, rgba(255,255,255,0.00) 70%),
    linear-gradient(180deg, rgba(255,255,255,0.18), rgba(255,255,255,0.06));
  opacity: 0.85;
  mix-blend-mode: overlay;
}

/* pressed */
.btn:active,
.home-btn:active,
.btn-small:active,
.auth-button:active,
.bp-back-btn:active,
.bp-return-btn:active,
.biker-modal-btn:active,
.tsb-icon-btn:active,
#home-logout-btn:active,
#home-account-pill:active{
  transform: translateY(1px) scale(0.995);
  box-shadow:
    0 10px 26px rgba(0,0,0,0.34),
    inset 0 1px 0 rgba(255,255,255,0.40),
    inset 0 -14px 22px rgba(0,0,0,0.32),
    inset 0 0 0 1px rgba(0,0,0,0.16) !important;
}

/* Popup content area glass */
.bp-popup-content{
  background: rgba(255,255,255,0.08) !important;
  backdrop-filter: blur(calc(var(--lg-blur) + 6px)) saturate(145%) !important;
  -webkit-backdrop-filter: blur(calc(var(--lg-blur) + 6px)) saturate(145%) !important;
}

/* Any chart canvas inside popups: transparent */
.bp-popup-content canvas,
#performance-chart canvas,
#performance-view canvas,
#race-calendar canvas{
  background: transparent !important;
}

/* If charts are inside containers/divs */
.bp-popup-content .chart,
.bp-popup-content .chart-wrap,
.bp-popup-content .chart-container,
.bp-popup-content .canvas-wrap{
  background: rgba(255,255,255,0.08) !important;
  border: 1px solid rgba(255,255,255,0.18) !important;
  border-radius: 18px !important;
  backdrop-filter: blur(calc(var(--lg-blur) + 4px)) saturate(140%) !important;
  -webkit-backdrop-filter: blur(calc(var(--lg-blur) + 4px)) saturate(140%) !important;
}

/* Make any remaining light panels in profile/performance glassy */
.bp-profile,
.bp-profile-card,
.bp-panel,
.bp-section,
.bp-card{
  background: rgba(255,255,255,0.10) !important;
  border: 1px solid rgba(255,255,255,0.22) !important;
  backdrop-filter: blur(calc(var(--lg-blur) + 6px)) saturate(150%) !important;
  -webkit-backdrop-filter: blur(calc(var(--lg-blur) + 6px)) saturate(150%) !important;
}



/* ===== BUILD 4.120 – SVG chart glass (fix white background) ===== */
.bp-popup-content{
  background: rgba(255,255,255,0.06) !important;
}

.bp-popup-content .bp-glass-svg{
  background: transparent !important;
  border-radius: 18px !important;
}

.bp-popup-content .bp-glass-svg rect{
  fill: rgba(255,255,255,0.08) !important;
  stroke: rgba(255,255,255,0.20) !important;
}

/* Make any accidental inline backgrounds inside popup transparent */
#bp-popup-content [style*="background"]{
  background: rgba(255,255,255,0.08) !important;
}



/* ===== BUILD 4.120 – Bikers Performance popups: FULL Liquid Glass ===== */

/* Overlay: frosted dark */
#bp-popup-overlay{
  background: rgba(0,0,0,0.58) !important;
  backdrop-filter: blur(12px) saturate(120%) !important;
  -webkit-backdrop-filter: blur(12px) saturate(120%) !important;
}

/* Card: glass */
#bp-popup-overlay .bp-popup-card{
  background: rgba(255,255,255,0.12) !important;
  border: 1px solid rgba(255,255,255,0.26) !important;
  border-top-color: rgba(255,255,255,0.44) !important;
  border-left-color: rgba(255,255,255,0.30) !important;
  border-radius: var(--lg-radius) !important;
  box-shadow: 0 18px 50px rgba(0,0,0,0.45) !important;
  backdrop-filter: blur(calc(var(--lg-blur) + 8px)) saturate(155%) !important;
  -webkit-backdrop-filter: blur(calc(var(--lg-blur) + 8px)) saturate(155%) !important;
  overflow: hidden !important;
}

/* Header: glass dark for contrast */
#bp-popup-overlay .bp-popup-header{
  background: rgba(15,23,42,0.38) !important;
  border-bottom: 1px solid rgba(255,255,255,0.16) !important;
  backdrop-filter: blur(calc(var(--lg-blur) + 6px)) saturate(140%) !important;
  -webkit-backdrop-filter: blur(calc(var(--lg-blur) + 6px)) saturate(140%) !important;
}
#bp-popup-overlay .bp-popup-title{ color:#fff !important; }
#bp-popup-overlay .bp-popup-close{
  background: rgba(255,255,255,0.14) !important;
  border: 1px solid rgba(255,255,255,0.22) !important;
  color: #ffffff !important;
  border-radius: 999px !important;
  backdrop-filter: blur(calc(var(--lg-blur) + 6px)) saturate(200%) contrast(120%) !important;
  -webkit-backdrop-filter: blur(calc(var(--lg-blur) + 6px)) saturate(200%) contrast(120%) !important;
}

/* ===== BUILD 4.120 – Apple-like glass buttons (thicker + stronger distortion) ===== */
.btn,
.home-btn,
.btn-small,
.auth-button,
.bp-back-btn,
.bp-return-btn,
.biker-modal-btn,
.tsb-icon-btn,
#home-logout-btn,
#home-account-pill{
  position: relative !important;
  overflow: hidden !important;
  transform: translateZ(0);
  box-shadow:
    0 14px 34px rgba(0,0,0,0.38),
    inset 0 1px 0 rgba(255,255,255,0.55),
    inset 0 -10px 18px rgba(0,0,0,0.28),
    inset 0 0 0 1px rgba(0,0,0,0.12) !important;
}

/* subtle highlight */
.btn::before,
.home-btn::before,
.btn-small::before,
.auth-button::before,
.bp-back-btn::before,
.bp-return-btn::before,
.biker-modal-btn::before,
.tsb-icon-btn::before,
#home-logout-btn::before,
#home-account-pill::before{
  content:"";
  position:absolute;
  inset:-1px;
  border-radius: inherit;
  pointer-events:none;
  background:
    radial-gradient(120% 90% at 30% 20%, rgba(255,255,255,0.55), rgba(255,255,255,0.10) 45%, rgba(255,255,255,0.00) 70%),
    linear-gradient(180deg, rgba(255,255,255,0.18), rgba(255,255,255,0.06));
  opacity: 0.85;
  mix-blend-mode: overlay;
}

/* pressed */
.btn:active,
.home-btn:active,
.btn-small:active,
.auth-button:active,
.bp-back-btn:active,
.bp-return-btn:active,
.biker-modal-btn:active,
.tsb-icon-btn:active,
#home-logout-btn:active,
#home-account-pill:active{
  transform: translateY(1px) scale(0.995);
  box-shadow:
    0 10px 26px rgba(0,0,0,0.34),
    inset 0 1px 0 rgba(255,255,255,0.40),
    inset 0 -14px 22px rgba(0,0,0,0.32),
    inset 0 0 0 1px rgba(0,0,0,0.16) !important;
}

/* Content area: light glass */
#bp-popup-overlay .bp-popup-content{
  background: rgba(255,255,255,0.06) !important;
  backdrop-filter: blur(calc(var(--lg-blur) + 6px)) saturate(145%) !important;
  -webkit-backdrop-filter: blur(calc(var(--lg-blur) + 6px)) saturate(145%) !important;
}

/* Override any INLINE white panels inside popup content (stats blocks) */
#bp-popup-content [style*="background"],
#bp-popup-content [style*="background-color"]{
  background: rgba(255,255,255,0.10) !important;
  border: 1px solid rgba(255,255,255,0.18) !important;
  border-radius: 18px !important;
  backdrop-filter: blur(calc(var(--lg-blur) + 4px)) saturate(150%) !important;
  -webkit-backdrop-filter: blur(calc(var(--lg-blur) + 4px)) saturate(150%) !important;
}

/* Common inner blocks (robust selectors) */
#bp-popup-content > div,
#bp-popup-content .card,
#bp-popup-content .panel,
#bp-popup-content .box,
#bp-popup-content .stat,
#bp-popup-content .stats,
#bp-popup-content .kpi,
#bp-popup-content .grid,
#bp-popup-content .row{
  background: rgba(255,255,255,0.08) !important;
  border: 1px solid rgba(255,255,255,0.16) !important;
  border-radius: 18px !important;
  backdrop-filter: blur(calc(var(--lg-blur) + 4px)) saturate(145%) !important;
  -webkit-backdrop-filter: blur(calc(var(--lg-blur) + 4px)) saturate(145%) !important;
}

/* Charts (SVG): force glass background rect + transparent svg */
#bp-popup-content svg{
  background: transparent !important;
}
#bp-popup-content svg rect{
  fill: rgba(255,255,255,0.08) !important;
  stroke: rgba(255,255,255,0.20) !important;
}

/* Charts (canvas): transparent */
#bp-popup-content canvas{ background: transparent !important; }



/* ===== BUILD 4.120 – FIX: bp popup uses CLASS, enforce glass ===== */
.bp-popup-overlay, #bp-popup-overlay{
  background: rgba(0,0,0,0.58) !important;
  backdrop-filter: blur(12px) saturate(120%) !important;
  -webkit-backdrop-filter: blur(12px) saturate(120%) !important;
}

.bp-popup-overlay .bp-popup-card, #bp-popup-overlay .bp-popup-card{
  background: rgba(255,255,255,0.12) !important;
  border: 1px solid rgba(255,255,255,0.26) !important;
  border-top-color: rgba(255,255,255,0.44) !important;
  border-left-color: rgba(255,255,255,0.30) !important;
  border-radius: var(--lg-radius) !important;
  box-shadow: 0 18px 50px rgba(0,0,0,0.45) !important;
  backdrop-filter: blur(calc(var(--lg-blur) + 8px)) saturate(155%) !important;
  -webkit-backdrop-filter: blur(calc(var(--lg-blur) + 8px)) saturate(155%) !important;
  overflow: hidden !important;
}

.bp-popup-overlay .bp-popup-header, #bp-popup-overlay .bp-popup-header{
  background: rgba(15,23,42,0.38) !important;
  border-bottom: 1px solid rgba(255,255,255,0.16) !important;
  backdrop-filter: blur(calc(var(--lg-blur) + 6px)) saturate(140%) !important;
  -webkit-backdrop-filter: blur(calc(var(--lg-blur) + 6px)) saturate(140%) !important;
}
.bp-popup-overlay .bp-popup-title, #bp-popup-overlay .bp-popup-title{ color:#fff !important; }
.bp-popup-overlay .bp-popup-close, #bp-popup-overlay .bp-popup-close{
  background: rgba(255,255,255,0.14) !important;
  border: 1px solid rgba(255,255,255,0.22) !important;
  color: #ffffff !important;
  border-radius: 999px !important;
  backdrop-filter: blur(calc(var(--lg-blur) + 6px)) saturate(200%) contrast(120%) !important;
  -webkit-backdrop-filter: blur(calc(var(--lg-blur) + 6px)) saturate(200%) contrast(120%) !important;
}

/* ===== BUILD 4.120 – Apple-like glass buttons (thicker + stronger distortion) ===== */
.btn,
.home-btn,
.btn-small,
.auth-button,
.bp-back-btn,
.bp-return-btn,
.biker-modal-btn,
.tsb-icon-btn,
#home-logout-btn,
#home-account-pill{
  position: relative !important;
  overflow: hidden !important;
  transform: translateZ(0);
  box-shadow:
    0 14px 34px rgba(0,0,0,0.38),
    inset 0 1px 0 rgba(255,255,255,0.55),
    inset 0 -10px 18px rgba(0,0,0,0.28),
    inset 0 0 0 1px rgba(0,0,0,0.12) !important;
}

/* subtle highlight */
.btn::before,
.home-btn::before,
.btn-small::before,
.auth-button::before,
.bp-back-btn::before,
.bp-return-btn::before,
.biker-modal-btn::before,
.tsb-icon-btn::before,
#home-logout-btn::before,
#home-account-pill::before{
  content:"";
  position:absolute;
  inset:-1px;
  border-radius: inherit;
  pointer-events:none;
  background:
    radial-gradient(120% 90% at 30% 20%, rgba(255,255,255,0.55), rgba(255,255,255,0.10) 45%, rgba(255,255,255,0.00) 70%),
    linear-gradient(180deg, rgba(255,255,255,0.18), rgba(255,255,255,0.06));
  opacity: 0.85;
  mix-blend-mode: overlay;
}

/* pressed */
.btn:active,
.home-btn:active,
.btn-small:active,
.auth-button:active,
.bp-back-btn:active,
.bp-return-btn:active,
.biker-modal-btn:active,
.tsb-icon-btn:active,
#home-logout-btn:active,
#home-account-pill:active{
  transform: translateY(1px) scale(0.995);
  box-shadow:
    0 10px 26px rgba(0,0,0,0.34),
    inset 0 1px 0 rgba(255,255,255,0.40),
    inset 0 -14px 22px rgba(0,0,0,0.32),
    inset 0 0 0 1px rgba(0,0,0,0.16) !important;
}

.bp-popup-overlay .bp-popup-content, #bp-popup-overlay .bp-popup-content, #bp-popup-content{
  background: rgba(255,255,255,0.06) !important;
  backdrop-filter: blur(calc(var(--lg-blur) + 6px)) saturate(145%) !important;
  -webkit-backdrop-filter: blur(calc(var(--lg-blur) + 6px)) saturate(145%) !important;
}

/* Kill opaque/yellow inline backgrounds inside BP popups */
#bp-popup-content [style*="background"],
#bp-popup-content [style*="background-color"]{
  background: rgba(255,255,255,0.08) !important;
  border: 1px solid rgba(255,255,255,0.18) !important;
  border-radius: 18px !important;
  backdrop-filter: blur(calc(var(--lg-blur) + 4px)) saturate(150%) !important;
  -webkit-backdrop-filter: blur(calc(var(--lg-blur) + 4px)) saturate(150%) !important;
}



/* ===== BUILD 4.120 – Force BP SVG chart background glass ===== */
#bp-popup-content svg rect{
  fill: rgba(255,255,255,0.08) !important;
  stroke: rgba(255,255,255,0.20) !important;
}



/* ===== BUILD 4.120 – Charts: remove yellow fills, glass only ===== */
#bp-popup-content svg path[fill^="url("],
#bp-popup-content svg path[fill*="bpGrad"]{
  fill: rgba(255,255,255,0.06) !important;
}
#bp-popup-content svg .area,
#bp-popup-content svg .fill-area{
  fill: rgba(255,255,255,0.06) !important;
}



/* ===== BUILD 4.120 – ICON POPUPS (Bikers Performance stats & charts) in Liquid Glass ===== */

/* Overlay */
#icon-popup-overlay{
  background: rgba(0,0,0,0.58) !important;
  backdrop-filter: blur(12px) saturate(120%) !important;
  -webkit-backdrop-filter: blur(12px) saturate(120%) !important;
}

/* Popup card */
#icon-popup-overlay .icon-popup{
  background: rgba(255,255,255,0.12) !important;
  border: 1px solid rgba(255,255,255,0.26) !important;
  border-top-color: rgba(255,255,255,0.44) !important;
  border-left-color: rgba(255,255,255,0.30) !important;
  border-radius: var(--lg-radius) !important;
  box-shadow: 0 18px 50px rgba(0,0,0,0.45) !important;
  backdrop-filter: blur(calc(var(--lg-blur) + 8px)) saturate(155%) !important;
  -webkit-backdrop-filter: blur(calc(var(--lg-blur) + 8px)) saturate(155%) !important;
}

/* Header */
#icon-popup-overlay .icon-popup-header{
  background: rgba(15,23,42,0.38) !important;
  border-bottom: 1px solid rgba(255,255,255,0.16) !important;
  backdrop-filter: blur(calc(var(--lg-blur) + 6px)) saturate(140%) !important;
  -webkit-backdrop-filter: blur(calc(var(--lg-blur) + 6px)) saturate(140%) !important;
}
#icon-popup-overlay #icon-popup-title{
  color: #ffffff !important;
}

/* Close button */
#icon-popup-overlay .icon-popup-close{
  background: rgba(255,255,255,0.14) !important;
  border: 1px solid rgba(255,255,255,0.22) !important;
  color: #ffffff !important;
  border-radius: 999px !important;
  backdrop-filter: blur(calc(var(--lg-blur) + 6px)) saturate(200%) contrast(120%) !important;
  -webkit-backdrop-filter: blur(calc(var(--lg-blur) + 6px)) saturate(200%) contrast(120%) !important;
}

/* ===== BUILD 4.120 – Apple-like glass buttons (thicker + stronger distortion) ===== */
.btn,
.home-btn,
.btn-small,
.auth-button,
.bp-back-btn,
.bp-return-btn,
.biker-modal-btn,
.tsb-icon-btn,
#home-logout-btn,
#home-account-pill{
  position: relative !important;
  overflow: hidden !important;
  transform: translateZ(0);
  box-shadow:
    0 14px 34px rgba(0,0,0,0.38),
    inset 0 1px 0 rgba(255,255,255,0.55),
    inset 0 -10px 18px rgba(0,0,0,0.28),
    inset 0 0 0 1px rgba(0,0,0,0.12) !important;
}

/* subtle highlight */
.btn::before,
.home-btn::before,
.btn-small::before,
.auth-button::before,
.bp-back-btn::before,
.bp-return-btn::before,
.biker-modal-btn::before,
.tsb-icon-btn::before,
#home-logout-btn::before,
#home-account-pill::before{
  content:"";
  position:absolute;
  inset:-1px;
  border-radius: inherit;
  pointer-events:none;
  background:
    radial-gradient(120% 90% at 30% 20%, rgba(255,255,255,0.55), rgba(255,255,255,0.10) 45%, rgba(255,255,255,0.00) 70%),
    linear-gradient(180deg, rgba(255,255,255,0.18), rgba(255,255,255,0.06));
  opacity: 0.85;
  mix-blend-mode: overlay;
}

/* pressed */
.btn:active,
.home-btn:active,
.btn-small:active,
.auth-button:active,
.bp-back-btn:active,
.bp-return-btn:active,
.biker-modal-btn:active,
.tsb-icon-btn:active,
#home-logout-btn:active,
#home-account-pill:active{
  transform: translateY(1px) scale(0.995);
  box-shadow:
    0 10px 26px rgba(0,0,0,0.34),
    inset 0 1px 0 rgba(255,255,255,0.40),
    inset 0 -14px 22px rgba(0,0,0,0.32),
    inset 0 0 0 1px rgba(0,0,0,0.16) !important;
}

/* Content area */
#icon-popup-overlay #icon-popup-content,
#icon-popup-overlay .icon-popup-body{
  background: rgba(255,255,255,0.06) !important;
  backdrop-filter: blur(calc(var(--lg-blur) + 6px)) saturate(145%) !important;
  -webkit-backdrop-filter: blur(calc(var(--lg-blur) + 6px)) saturate(145%) !important;
  color: #ffffff !important;
}

/* Kill opaque inline panels (the "giallino" blocks) inside icon popup content */
#icon-popup-content [style*="background"],
#icon-popup-content [style*="background-color"]{
  background: rgba(255,255,255,0.08) !important;
  border: 1px solid rgba(255,255,255,0.18) !important;
  border-radius: 18px !important;
  backdrop-filter: blur(calc(var(--lg-blur) + 4px)) saturate(150%) !important;
  -webkit-backdrop-filter: blur(calc(var(--lg-blur) + 4px)) saturate(150%) !important;
}

/* Charts in icon popups: force glass */
#icon-popup-content svg{
  background: transparent !important;
}
#icon-popup-content svg rect{
  fill: rgba(255,255,255,0.08) !important;
  stroke: rgba(255,255,255,0.20) !important;
}
#icon-popup-content svg path[fill^="url("],
#icon-popup-content svg path[fill*="bpGrad"],
#icon-popup-content svg .area,
#icon-popup-content svg .fill-area{
  fill: rgba(255,255,255,0.06) !important;
}
#icon-popup-content canvas{
  background: transparent !important;
}



/* ===== BUILD 4.120 – Chart numbers (axis) red + better alignment ===== */
#bp-popup-content svg text,
#performance-chart svg text{
  fill: #CC0000 !important;
}

</style>

<style id="bp-back-liquid-glass-red">
/* ===== BUILD 4.120 – BIG back button: RED Liquid Glass (uniform, no white reflection) ===== */
#bp-return-bike-performance,
.bp-return-btn,
button#bp-return-bike-performance{
  background: rgba(204,0,0,0.88) !important;       /* uniform red */
  color: #ffffff !important;
  border: 1px solid rgba(255,255,255,0.18) !important;

  /* liquid glass feel, but homogeneous */
  -webkit-backdrop-filter: blur(12px) saturate(170%) !important;
  backdrop-filter: blur(12px) saturate(170%) !important;

  box-shadow:
    0 14px 28px rgba(0,0,0,0.38),
    0 0 16px rgba(255,0,0,0.32),
    inset 0 1px 0 rgba(255,255,255,0.06),
    inset 0 -10px 20px rgba(0,0,0,0.12) !important;

  opacity: 1 !important;
  font-weight: 900 !important;
  letter-spacing: 0.5px !important;
  position: relative !important;
}

/* hard-disable any legacy highlights/reflections */
#bp-return-bike-performance::before,
#bp-return-bike-performance::after,
.bp-return-btn::before,
.bp-return-btn::after{
  content: none !important;
  display: none !important;
}
</style>
<style id="lg-solid-pill-4-107">
/* ===== BUILD 4.120 – PILL BUTTONS: SOLID Liquid Glass (NO grey/white gradients) ===== */

/* Base glass pills previously using linear-gradients */
.auth-button,
.bp-back-btn,
.bp-return-btn,
.biker-modal-btn,
.tsb-icon-btn{
  background: rgba(255,255,255,0.12) !important;
  background-image: none !important;
  border: 1px solid rgba(255,255,255,0.20) !important;
  -webkit-backdrop-filter: blur(12px) saturate(170%) !important;
  backdrop-filter: blur(12px) saturate(170%) !important;
  box-shadow:
    0 12px 26px rgba(0,0,0,0.38),
    inset 0 1px 0 rgba(255,255,255,0.06),
    inset 0 -12px 22px rgba(0,0,0,0.14) !important;
}

/* Performance buttons (yellow/green) – force SOLID tint, no grey overlay */
#performance-overall-btn{
  background: rgba(253,224,0,0.92) !important; /* yellow */
  background-image: none !important;
  color: #111 !important;
  border: 1px solid rgba(255,255,255,0.26) !important;
  -webkit-backdrop-filter: blur(12px) saturate(170%) !important;
  backdrop-filter: blur(12px) saturate(170%) !important;
  box-shadow:
    0 14px 28px rgba(0,0,0,0.38),
    0 0 18px rgba(253,224,0,0.22),
    inset 0 1px 0 rgba(255,255,255,0.06),
    inset 0 -10px 20px rgba(0,0,0,0.12) !important;
}

#performance-race-btn{
  background: rgba(22,163,74,0.92) !important; /* green */
  background-image: none !important;
  color: #ffffff !important;
  border: 1px solid rgba(255,255,255,0.26) !important;
  -webkit-backdrop-filter: blur(12px) saturate(170%) !important;
  backdrop-filter: blur(12px) saturate(170%) !important;
  box-shadow:
    0 14px 28px rgba(0,0,0,0.38),
    0 0 18px rgba(22,163,74,0.22),
    inset 0 1px 0 rgba(255,255,255,0.06),
    inset 0 -10px 20px rgba(0,0,0,0.12) !important;
}

/* Hard disable any legacy shine layers */
#performance-overall-btn::before,
#performance-overall-btn::after,
#performance-race-btn::before,
#performance-race-btn::after{
  content: none !important;
  display: none !important;
}
</style>

<style id="login-red-btn">
/* LOGIN – Entra button RED */
.login-panel button[type="submit"],
#login-submit,
.btn-login,
button.login-submit {
  background: linear-gradient(180deg, #ff3b3b 0%, #c40000 100%) !important;
  color: #ffffff !important;
  border: none !important;
  box-shadow: 0 10px 24px rgba(0,0,0,0.35) !important;
  font-weight: 800;
}
.login-panel button[type="submit"]:active {
  transform: scale(0.98);
}
</style>
<style id="auth-entra-red">
/* AUTH – Entra button (force RED, iOS-safe) */
#auth-submit.auth-button{
  background: linear-gradient(180deg, #ff2d2d 0%, #b80000 100%) !important;
  color: #ffffff !important;
  border: none !important;
  opacity: 1 !important;
  filter: none !important;
  backdrop-filter: none !important;
  -webkit-backdrop-filter: none !important;
  box-shadow: 0 10px 24px rgba(0,0,0,0.38) !important;
  font-weight: 900 !important;
}
#auth-submit.auth-button:active{
  transform: scale(0.98);
}
</style>

<style id="build-4.116-bikers-liquid-glass">
/* ===== BUILD 4.120 – BIKERS (DB) Liquid Glass redesign ===== */
#db-container{
  background: rgba(255,255,255,0.06) !important;
  border: 1px solid rgba(255,255,255,0.16) !important;
  border-top-color: rgba(255,255,255,0.26) !important;
  border-left-color: rgba(255,255,255,0.20) !important;
  border-radius: 26px !important;
  padding: 16px !important;
  box-shadow: 0 14px 38px rgba(0,0,0,0.38) !important;
  backdrop-filter: blur(18px) saturate(155%) !important;
  -webkit-backdrop-filter: blur(18px) saturate(155%) !important;
}

.bikers-glass-header{
  display:flex;
  align-items:flex-start;
  justify-content:space-between;
  gap:12px;
  margin-bottom: 14px;
}
.bikers-glass-titlewrap{ flex:1; min-width:0; }
.bikers-glass-title{
  font-size: 22px;
  font-weight: 900;
  letter-spacing: 0.02em;
  color: #fff;
  line-height: 1.05;
}
.bikers-glass-sub{
  margin-top: 4px;
  font-size: 12px;
  color: rgba(255,255,255,0.78);
}

.bikers-glass-add{
  white-space: nowrap;
  padding: 10px 14px !important;
  border-radius: 999px !important;
}

.biker-list-glass{
  display:flex;
  flex-direction:column;
  gap:10px;
  margin-top: 6px;
}

.biker-list-item-glass{
  width:100%;
  text-align:left;
  padding: 12px 12px;
  border-radius: 22px;
  border: 1px solid rgba(255,255,255,0.18);
  border-top-color: rgba(255,255,255,0.28);
  border-left-color: rgba(255,255,255,0.22);
  background: rgba(255,255,255,0.08);
  color: #fff;
  box-shadow: 0 10px 24px rgba(0,0,0,0.30);
  backdrop-filter: blur(16px) saturate(150%);
  -webkit-backdrop-filter: blur(16px) saturate(150%);
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  cursor:pointer;
  transition: transform 0.08s ease, box-shadow 0.12s ease, background 0.12s ease;
}
.biker-list-item-glass:active{
  transform: translateY(1px) scale(0.99);
  box-shadow: 0 6px 14px rgba(0,0,0,0.26);
}

.biker-item-left{ display:flex; align-items:center; gap:12px; min-width:0; }
.biker-item-text{ display:flex; flex-direction:column; gap:2px; min-width:0; }
.biker-name-label{
  font-size: 16px;
  font-weight: 900;
  letter-spacing: 0.01em;
  color: #fff;
  overflow:hidden;
  text-overflow:ellipsis;
  white-space:nowrap;
}
.biker-meta{
  font-size: 12px;
  color: rgba(255,255,255,0.74);
  overflow:hidden;
  text-overflow:ellipsis;
  white-space:nowrap;
}

.biker-initial-glass{
  width: 38px;
  height: 38px;
  border-radius: 14px;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size: 16px;
  font-weight: 900;
  color: #fff;
  background: rgba(204,0,0,0.26);
  border: 1px solid rgba(255,255,255,0.18);
  box-shadow: inset 0 0 0 1px rgba(0,0,0,0.18);
  flex: 0 0 auto;
}

.biker-chevron{
  font-size: 22px;
  line-height: 1;
  opacity: 0.9;
  margin-left: 6px;
}

.bikers-glass-empty{
  margin-top: 10px;
  padding: 18px 14px;
  border-radius: 22px;
  background: rgba(255,255,255,0.06);
  border: 1px solid rgba(255,255,255,0.16);
  color: rgba(255,255,255,0.92);
  text-align:center;
  backdrop-filter: blur(16px) saturate(140%);
  -webkit-backdrop-filter: blur(16px) saturate(140%);
  box-shadow: 0 12px 26px rgba(0,0,0,0.30);
}
.bikers-glass-empty-ico{ font-size: 30px; margin-bottom: 8px; }
.bikers-glass-empty-title{ font-weight: 900; font-size: 16px; }
.bikers-glass-empty-text{ margin-top: 4px; font-size: 13px; color: rgba(255,255,255,0.78); }

.bikers-glass-bottom-space{ height: 14px; }
/* ===== BUILD 4.120 – RACE: selezione bikers con lo stesso design della pagina Bikers ===== */
#select-container{
  padding: 10px 14px 6px 14px;
  gap: 14px;
}
.race-select-list{ margin-top: 0; }
.race-select-item.selected{
  border-color: rgba(250,204,21,0.65);
  box-shadow: 0 10px 24px rgba(0,0,0,0.30), 0 0 0 2px rgba(250,204,21,0.22) inset;
  background: rgba(250,204,21,0.10);
}
.race-select-item.selected .race-select-mark{
  color: #facc15;
  font-weight: 900;
}


@media (max-width: 360px){
  #db-container{ padding: 14px !important; border-radius: 22px !important; }
  .bikers-glass-title{ font-size: 20px; }
  .biker-list-item-glass{ padding: 11px 11px; border-radius: 20px; }
  .biker-initial-glass{ width: 36px; height: 36px; border-radius: 13px; }
}
</style>

</head>

<body>

<!-- CRS SCORE GLOBAL BANNER -->
<div id="global-banner">
  <img src="crs-banner.png" alt="CRS Score banner">
</div>


<!-- LOADING -->
<div id="loading-screen"><div class="bike-wheel" role="img" aria-label="Caricamento">
  <svg viewBox="0 0 100 100" class="bike-wheel-svg" aria-hidden="true" focusable="false">
    <circle cx="50" cy="50" r="36" fill="none" stroke="currentColor" stroke-width="8"/>
    <circle cx="50" cy="50" r="6" fill="currentColor"/>
    <g stroke="currentColor" stroke-width="5" stroke-linecap="round">
      <line x1="50" y1="14" x2="50" y2="32"/>
      <line x1="50" y1="68" x2="50" y2="86"/>
      <line x1="14" y1="50" x2="32" y2="50"/>
      <line x1="68" y1="50" x2="86" y2="50"/>
      <line x1="26" y1="26" x2="38" y2="38"/>
      <line x1="62" y1="62" x2="74" y2="74"/>
      <line x1="26" y1="74" x2="38" y2="62"/>
      <line x1="62" y1="38" x2="74" y2="26"/>
    </g>
  </svg>
</div></div>
</div>

<!-- BIKERS LOADING POPUP -->
<div id="bikers-loading-overlay">
  <div class="bikers-loading-box"><div class="bike-wheel" role="img" aria-label="Caricamento">
  <svg viewBox="0 0 100 100" class="bike-wheel-svg" aria-hidden="true" focusable="false">
    <circle cx="50" cy="50" r="36" fill="none" stroke="currentColor" stroke-width="8"/>
    <circle cx="50" cy="50" r="6" fill="currentColor"/>
    <g stroke="currentColor" stroke-width="5" stroke-linecap="round">
      <line x1="50" y1="14" x2="50" y2="32"/>
      <line x1="50" y1="68" x2="50" y2="86"/>
      <line x1="14" y1="50" x2="32" y2="50"/>
      <line x1="68" y1="50" x2="86" y2="50"/>
      <line x1="26" y1="26" x2="38" y2="38"/>
      <line x1="62" y1="62" x2="74" y2="74"/>
      <line x1="26" y1="74" x2="38" y2="62"/>
      <line x1="62" y1="38" x2="74" y2="26"/>
    </g>
  </svg>
</div></div></div>
</div>

<!-- AUTH OVERLAY -->
<div id="auth-overlay">
  <div class="auth-card">
    <div class="auth-title">CRS Score</div>
    <div class="auth-subtitle">Accedi o crea un account per salvare bikers e gare.</div>

    <div class="auth-toggle-row">
      <button id="auth-toggle-login" class="auth-toggle-btn active" type="button">Login</button>
      <button id="auth-toggle-register" class="auth-toggle-btn" type="button">Crea account</button>
    </div>

    <div class="auth-field">
      <label for="auth-username">Username</label>
      <input id="auth-username" type="text" autocomplete="username" placeholder="Es. marco_79">
    </div>
    <div class="auth-field">
      <label for="auth-password">Password</label>
      <input id="auth-password" type="password" autocomplete="current-password" placeholder="Inserisci password">
    </div>

    <button id="auth-submit" class="auth-button" type="button">Entra</button>
    <div id="auth-error" class="auth-error" aria-live="polite"></div>
  </div>
</div>


<div id="menu-wrap" style="width:100%; display:flex; justify-content:center; margin-bottom:16px;">
  <div id="menu-icon" role="button" aria-label="Torna alla home" tabindex="0">
    <div class="menu-line"></div>
    <div class="menu-line"></div>
    <div class="menu-line"></div>
  </div>
</div>



<div id="home-view">

  <div class="home-box">
    <button class="home-btn" id="home-btn-race">Race</button>
    <button class="home-btn" id="home-btn-performance">Performance</button>
    <button class="home-btn" id="home-btn-bike-performance">Bike performance</button>
    <button class="home-btn" id="home-btn-test">Test Algoritmo</button>
    <button class="home-btn" id="home-btn-bikers">Bikers</button>
    

  </div>

  <!-- Home account button + version (outside yellow card) -->
  
<div class="home-bottom-area">
  <div class="home-controls-group">
    <button id="home-account-pill" type="button" class="home-account-pill" aria-label="Account">Account</button>
    <button id="home-audio-pill" type="button" class="home-audio-pill" aria-label="Audio toggle">🔊</button>
    <div id="home-version-label" class="home-version-label"></div>
  </div>
</div>

<div style="height:60px;"></div>

<div id="home-footer" class="home-footer-hidden">
    <div id="tech-status-bar" role="group" aria-label="Barra stato">
      <div class="tsb-left">
        <button id="home-logout-btn" type="button" class="tsb-icon-btn" aria-label="Logout">⎋</button>
      </div>

      <div class="tsb-center">
        <div class="tsb-toggle-buttons" role="group" aria-label="Suoni e vibrazione">
          <button id="sounds-btn" type="button" class="tsb-icon-btn tsb-toggle-btn" aria-label="Suoni" aria-pressed="true">
            <span class="tsb-toggle-ico" aria-hidden="true">🔊</span>
          </button>
          <button id="haptics-btn" type="button" class="tsb-icon-btn tsb-toggle-btn" aria-label="Vibrazione" aria-pressed="true">
            <span class="tsb-toggle-ico" aria-hidden="true">📳</span>
          </button>
        </div>
      </div>

      <div class="tsb-right">
        <div id="version-label"></div>
      </div>
    </div>
  </div>
</div>
</div>

<!-- Popup account (Logout / Cambia password) -->
<div id="account-overlay" aria-hidden="true">
  <div class="account-modal" role="dialog" aria-modal="true" aria-labelledby="account-title">
    <button id="account-close-btn" type="button" aria-label="Chiudi">×</button>
    <h2 id="account-title">Account</h2>
    <p class="sub">Gestisci logout e password.</p>

    <div class="row">
      <button id="account-logout-btn" type="button">Logout</button>
      <button id="account-change-password-btn" type="button">Cambia password</button>
    </div>

    <div id="change-password-panel">
      <div class="cp-field">
        <label for="cp-old">Password attuale</label>
        <input id="cp-old" type="password" autocomplete="current-password" />
      </div>
      <div class="cp-field">
        <label for="cp-new">Nuova password</label>
        <input id="cp-new" type="password" autocomplete="new-password" />
      </div>
      <div class="cp-field">
        <label for="cp-new2">Conferma nuova password</label>
        <input id="cp-new2" type="password" autocomplete="new-password" />
      </div>

      <div class="row" style="margin-top:14px;">
        <button id="account-save-password-btn" type="button">Salva password</button>
        <button id="account-future-btn" type="button" title="Elimina account">☢️</button>
      </div>

      <div id="account-msg" aria-live="polite"></div>
    </div>
  </div>
</div>


<div class="container">
  <div class="ranking" id="ranking-box">
    <div class="ranking-header">
      <div class="race-pills-row">
        <div class="race-pill">
          <div class="race-pill-label">Km</div>
          <div class="race-pill-value" id="race-distance-display"></div>
        </div>
        <div class="race-pill">
          <div class="race-pill-label">Dislivello</div>
          <div class="race-pill-value" id="race-elevation-display"></div>
        </div>
      </div>
      <div class="race-top-row">
        <span id="race-date-display" class="race-date"></span>
      </div>
    </div>
    <ol id="ranking-list"></ol>
  </div>

  <div id="db-container"></div>

  <!-- Popup loading performance -->
  <div id="loading-popup-overlay" aria-hidden="true">
    <div class="loading-popup" role="status" aria-live="polite"><div class="bike-wheel" role="img" aria-label="Caricamento">
  <svg viewBox="0 0 100 100" class="bike-wheel-svg" aria-hidden="true" focusable="false">
    <circle cx="50" cy="50" r="36" fill="none" stroke="currentColor" stroke-width="8"/>
    <circle cx="50" cy="50" r="6" fill="currentColor"/>
    <g stroke="currentColor" stroke-width="5" stroke-linecap="round">
      <line x1="50" y1="14" x2="50" y2="32"/>
      <line x1="50" y1="68" x2="50" y2="86"/>
      <line x1="14" y1="50" x2="32" y2="50"/>
      <line x1="68" y1="50" x2="86" y2="50"/>
      <line x1="26" y1="26" x2="38" y2="38"/>
      <line x1="62" y1="62" x2="74" y2="74"/>
      <line x1="26" y1="74" x2="38" y2="62"/>
      <line x1="62" y1="38" x2="74" y2="26"/>
    </g>
  </svg>
</div></div>
  </div>

  <!-- Modale gestione singolo biker -->
  <div id="biker-modal-overlay">
    <div class="biker-modal" role="dialog" aria-modal="true" aria-labelledby="biker-modal-title">
      <h2 id="biker-modal-title" class="biker-modal-title">Nuovo biker</h2>
      <p class="biker-modal-subtitle">Inserisci o modifica i dati del biker.</p>

      <div class="biker-modal-field">
        <label for="biker-modal-name">Nome</label>
        <input id="biker-modal-name" type="text" placeholder="Nome biker">
      </div>
      <div class="biker-modal-field">
        <label for="biker-modal-battery">Batteria (Wh)</label>
        <input id="biker-modal-battery" type="number" step="1" placeholder="Es. 500">
      </div>
      <div class="biker-modal-field">
        <label for="biker-modal-rider">Peso biker (kg)</label>
        <input id="biker-modal-rider" type="number" step="0.5" placeholder="Es. 65">
      </div>
      <div class="biker-modal-field">
        <label for="biker-modal-bike">Peso bici (kg)</label>
        <input id="biker-modal-bike" type="number" step="0.5" placeholder="Es. 15">
      </div>

      <div class="biker-modal-actions">
        <div class="biker-modal-actions-left">
          <button id="biker-modal-cancel" type="button" class="biker-modal-btn biker-modal-btn-secondary">Annulla</button>
          <button id="biker-modal-delete" type="button" class="biker-modal-btn biker-modal-btn-danger">Elimina</button>
        </div>
        <button id="biker-modal-save" type="button" class="biker-modal-btn biker-modal-btn-primary">Salva</button>
      </div>
    </div>
  </div>

  <div id="select-container"></div>
  <div id="players-container"></div>

  <!-- Input data semplice -->
  <div id="race-info-container" style="display:none;flex-direction:column;gap:6px;">
    <input id="race-date-input" type="date" />
    <input id="race-circuit-input" type="text" placeholder="Luogo / circuito">
    <input id="race-distance-input" type="number" step="0.1" placeholder="Km percorsi">
    <input id="race-elevation-input" type="number" step="1" placeholder="Dislivello (m)">
  </div>

  <div id="performance-container" style="display:none; margin-top:16px;">
    <div id="performance-graph" style="display:flex;align-items:flex-end;gap:10px;justify-content:center;margin-top:20px;"></div>

    <h2 id="performance-title" style="font-size:16px; margin:12px 0 4px; color:var(--coyote-red); text-align:center;">
      Performance complessive
    </h2>
    <p id="performance-subtitle" style="font-size:12px; color:#374151; text-align:center; margin:0 0 8px;">
      Media pesata delle performance su tutte le gare per ogni biker.
    </p>

    <!-- HEADER GARA SELEZIONATA -->
    <div id="performance-race-header" class="ranking" style="margin-top:8px; display:none;">
      <div class="ranking-header">
        <div class="race-pills-row">
          <div class="race-pill">
            <div class="race-pill-label">Km</div>
            <div class="race-pill-value" id="perf-race-distance-display"></div>
          </div>
          <div class="race-pill">
            <div class="race-pill-label">Dislivello</div>
            <div class="race-pill-value" id="perf-race-elevation-display"></div>
          </div>
        </div>
        <div class="race-top-row">
          <span id="perf-race-date-display" class="race-date"></span>
        </div>
      </div>
    </div>

    <div id="performance-chart" style="background:#f3f4f6; border-radius:12px; padding:10px; border:1px solid #d1d5db; margin-top:8px; animation: fadeInUp 0.3s ease-out;">
      <div id="performance-bars" style="display:flex; align-items:flex-end; gap:8px; height:220px; padding:8px 4px 0;"></div>
      <div id="performance-empty" style="font-size:12px; color:#6b7280; text-align:center; margin-top:8px;">
        Nessuna gara registrata.
      </div>
      <div style="margin-top:20px; margin-bottom:10px; display:flex; justify-content:center; gap:10px; flex-wrap:nowrap;">
        <button id="performance-overall-btn"
          style="background:#FDE000; color:#111; padding:16px 28px; border:none; border-radius:999px;
                 font-weight:800; cursor:pointer; font-size:20px; min-width:90px;">
          Media
        </button>
        <button id="performance-race-btn"
          style="background:#16A34A; color:#fff; padding:16px 28px; border:none; border-radius:999px;
                 font-weight:800; cursor:pointer; font-size:20px; min-width:90px;">
          Gare
        </button>
        <button id="reset-performance-btn"
          style="background:#CC0000; color:#fff; padding:16px 28px; border:none; border-radius:999px;
                 font-weight:800; cursor:pointer; font-size:20px; min-width:90px;">
          Reset
        </button>
      </div>

      <div style="margin-top:10px; display:flex; justify-content:center;">
        
      </div>

      <!-- POPUP CALENDARIO GARE -->
      <div id="race-calendar"
           style="display:none; margin:10px auto 0; padding:10px;
                  border-radius:16px; background:#fff7ed; border:1px solid #fed7aa;
                  box-shadow:0 6px 18px rgba(0,0,0,0.2);">
      </div>

    </div>
  </div>

  
  <div id="bikers-performance-view">
<div id="bp-list" class="bp-list"></div>

    <!-- PROFILO BIKER -->
    <div id="bp-profile" class="bp-profile" style="display:none;">
      <div id="bp-profile-name" class="bp-profile-name"></div>

      <div class="bp-rank-block">
        <div class="bp-rank-label">POSIZIONE CLASSIFICA</div>
        <div id="bp-rank-pos" class="bp-rank-pos"></div>
      </div>

      <div class="bp-icon-group">
<div class="bp-icon-grid" role="group" aria-label="Azioni profilo biker">
        <button class="bp-icon-btn" type="button" data-action="trend" aria-label="Andamento score nel tempo">
          <div class="bp-icon">📈</div>
        </button>
        <button class="bp-icon-btn" type="button" data-action="avg" aria-label="Consumo medio">
          <div class="bp-icon">⚡</div>
        </button>
        <button class="bp-icon-btn" type="button" data-action="best" aria-label="Miglior gara">
          <div class="bp-icon">🏁</div>
        </button>
        <button class="bp-icon-btn" type="button" data-action="count" aria-label="Numero gare disputate">
          <div class="bp-icon">🗓️</div>
        </button>
        <button class="bp-icon-btn" type="button" data-action="placements" aria-label="Piazzamenti">
          <div class="bp-icon">🏆</div>
        </button>
      </div>
</div>

      <div class="bp-return-row">
        <button id="bp-return-bike-performance" class="bp-return-btn" type="button">←</button>
      </div>
    </div>

    <!-- POPUP -->
    <div id="bp-popup-overlay" class="bp-popup-overlay" style="display:none;" aria-hidden="true">
      <div class="bp-popup-card" role="dialog" aria-modal="true" aria-labelledby="bp-popup-title">
        <div class="bp-popup-header">
          <div id="bp-popup-title" class="bp-popup-title">Dettaglio</div>
          <button id="bp-popup-close" class="bp-popup-close" type="button" aria-label="Chiudi">✕</button>
        </div>
        <div id="bp-popup-content" class="bp-popup-content"></div>
      </div>
    </div>

  </div>

<div id="test-view" style="display:none; margin-top:16px;">
    <div class="ranking" id="test-ranking-box">
      <div class="ranking-header">
        <div class="race-pills-row">
          <div class="race-pill">
            <div class="race-pill-value" id="test-scenario-display">Wh/kg</div>
          </div>
        </div>
      </div>
      <ol id="test-ranking-list"></ol>
    </div>

    
<div id="test-data-pills-container" style="display:flex;gap:6px;margin-top:10px;flex-wrap:wrap;justify-content:center;">
  <div class="test-data-pill" id="pill-out-wh">--</div>
  <div class="test-data-pill" id="pill-out-kg">--</div>
  <div class="test-data-pill" id="pill-out-bikekg">--</div>
  <div class="test-data-pill" id="pill-out-percent">--</div>
</div>

<div id="test-inputs">
      <div class="test-tabs">
        <button type="button" class="test-tab active" data-tab="wh" aria-label="Wh batteria">
          <span class="test-tab-icon">🔋</span>
        </button>
        <button type="button" class="test-tab" data-tab="riderkg" aria-label="Peso biker (kg)">
          <span class="test-tab-icon">🚴‍♂️</span>
        </button>
        <button type="button" class="test-tab" data-tab="bikekg" aria-label="Peso bici (kg)">
          <span class="test-tab-icon">🚲</span>
        </button>
        <button type="button" class="test-tab" data-tab="percent" aria-label="Carica residua (%)">
          <span class="test-tab-icon">%</span>
        </button>
      </div>
      <div class="test-tab-contents">
        <div class="test-tab-content active" data-tab="wh">
          <input id="test-battery-input" type="number" step="1"
                 placeholder="Inserisci capacità batteria in Wh (es. 500)">
        </div>
        <div class="test-tab-content" data-tab="riderkg">
          <input id="test-weight-input" type="number" step="0.5"
                 placeholder="Inserisci peso biker in kg (es. 65)">
        </div>
        <div class="test-tab-content" data-tab="bikekg">
          <input id="test-bike-weight-input" type="number" step="0.5"
                 placeholder="Inserisci peso bici in kg (es. 15)">
        </div>
        <div class="test-tab-content" data-tab="percent">
          <input id="test-percent-input" type="number" step="1" min="0" max="100"
                 placeholder="Inserisci carica residua in % (0-100)">
        </div>
      </div>
      <button id="test-calc-btn" type="button">Test</button>
      <button id="test-reset-btn" type="button">Reset</button>
    </div>
  </div>
</div>


</div>

<div class="buttons" id="main-buttons">
  <button class="btn" id="btn-db">Gestisci database</button>
  <button class="btn" id="btn-select">Bikers partecipanti</button>
  <button class="btn" id="btn-gara">Inserisci percentuali</button>
  <button class="btn" id="calc-btn">Calcola classifica</button>
  <button class="btn" id="btn-reset">Reset</button>
  <button class="btn" id="save-race-button">Invia dati</button>
</div>

<script>
"use strict";

const APP_VERSION = "4.103";
const BUILD_DATE = "";
const API_URL = "https://script.google.com/macros/s/AKfycbxon71F47wVkq1DFK7DBqQ2-j90ZTevoKOWEpE6h8DEbE5pW4eAl0GvC6gbTGXQp-_1sA/exec";


/* FETCH helper con timeout (evita freeze su iOS se Apps Script è lento) */
async function fetchWithTimeout(url, options = {}, timeoutMs = 8000) {
  const controller = new AbortController();
  const t = setTimeout(() => controller.abort(), timeoutMs);
  try {
    const res = await fetch(url, { ...options, signal: controller.signal });
    return res;
  } finally {
    clearTimeout(t);
  }
}



// ===== SUONI UI (Racing-tech, discreti) =====
const SOUND_STORAGE_KEY = "crs_sounds_enabled";
const HAPTIC_STORAGE_KEY = "crs_haptics_enabled_v1";
let soundsEnabled = (localStorage.getItem(SOUND_STORAGE_KEY) !== "0");


let hapticsEnabled = (localStorage.getItem(HAPTIC_STORAGE_KEY) !== "0");let __audioCtx = null;
function __ensureAudioCtx() {
  if (!soundsEnabled) return null;
  if (!__audioCtx) {
    const AC = window.AudioContext || window.webkitAudioContext;
    if (!AC) return null;
    __audioCtx = new AC();
  }
  if (__audioCtx && __audioCtx.state === "suspended") {
    // resume on gesture
    __audioCtx.resume().catch(()=>{});
  }
  return __audioCtx;
}
function setSoundsEnabled(v) {
  soundsEnabled = !!v;
  localStorage.setItem(SOUND_STORAGE_KEY, soundsEnabled ? "1" : "0");
}
function __envGain(ctx, t0, a=0.001, d=0.06, peak=0.18) {
  const g = ctx.createGain();
  g.gain.setValueAtTime(0.0001, t0);
  g.gain.exponentialRampToValueAtTime(Math.max(0.0002, peak), t0 + a);
  g.gain.exponentialRampToValueAtTime(0.0001, t0 + a + d);
  return g;
}
let __lastTapAt = 0;
function playTap(){
  const now = (window.performance && performance.now) ? performance.now() : Date.now();
  if (now - __lastTapAt < 90) return;
  __lastTapAt = now;
const ctx = __ensureAudioCtx(); if (!ctx) return;
  const t0 = ctx.currentTime;

  // iPhone-like keyboard tap: very short, soft high click
  const osc = ctx.createOscillator();
  osc.type = "triangle";
  osc.frequency.setValueAtTime(2200, t0);

  const hp = ctx.createBiquadFilter();
  hp.type = "highpass";
  hp.frequency.setValueAtTime(900, t0);

  const g = ctx.createGain();
  g.gain.setValueAtTime(0.0001, t0);
  g.gain.exponentialRampToValueAtTime(0.12, t0 + 0.0012);
  g.gain.exponentialRampToValueAtTime(0.0001, t0 + 0.020);

  osc.connect(hp).connect(g).connect(ctx.destination);
  osc.start(t0);
  osc.stop(t0 + 0.025);
}
function playUiClick(){
  playTap();
}

function playWhoosh(){
  playTap();
}

function playLockIn(){
  playTap();
}

function playSuccess(){
  playTap();
}

function playError(){
  playTap();
}

let __lastHapticAt = 0;

// Haptics support (nota: su iOS browser la Vibration API è generalmente NON disponibile)
function supportsHaptics(){
  try{
    return !!(navigator && typeof navigator.vibrate === "function");
  }catch(_e){ return false; }
}

// Tiny toast (non invasivo)
let __tinyToastEl = null;
let __tinyToastTO = null;
function tinyToast(msg){
  try{
    if (!__tinyToastEl){
      __tinyToastEl = document.createElement("div");
      __tinyToastEl.id = "tiny-toast";
      __tinyToastEl.style.position = "fixed";
      __tinyToastEl.style.left = "50%";
      __tinyToastEl.style.bottom = "92px"; // sopra la tab bar
      __tinyToastEl.style.transform = "translateX(-50%)";
      __tinyToastEl.style.padding = "10px 12px";
      __tinyToastEl.style.borderRadius = "14px";
      __tinyToastEl.style.background = "rgba(0,0,0,0.72)";
      __tinyToastEl.style.color = "#fff";
      __tinyToastEl.style.fontSize = "13px";
      __tinyToastEl.style.lineHeight = "1.2";
      __tinyToastEl.style.maxWidth = "92vw";
      __tinyToastEl.style.textAlign = "center";
      __tinyToastEl.style.zIndex = "99999";
      __tinyToastEl.style.opacity = "0";
      __tinyToastEl.style.pointerEvents = "none";
      __tinyToastEl.style.transition = "opacity 160ms ease";
      document.body.appendChild(__tinyToastEl);
    }
    __tinyToastEl.textContent = msg;
    if (__tinyToastTO) clearTimeout(__tinyToastTO);
    requestAnimationFrame(()=>{ __tinyToastEl.style.opacity = "1"; });
    __tinyToastTO = setTimeout(()=>{
      __tinyToastEl.style.opacity = "0";
    }, 1600);
  }catch(_e){}
}

function doHaptic(){
  if (!hapticsEnabled) return;
  const now = (window.performance && performance.now) ? performance.now() : Date.now();
  // Anti-doppio impulso (alcuni device sparano due eventi quasi simultanei)
  if (now - __lastHapticAt < 90) return;
  __lastHapticAt = now;
  try{
    if (supportsHaptics()) {
      navigator.vibrate(10);
    }
  }catch(_e){}
}


// Init toggle in HOME
(function initSoundsToggle(){
  const btn = document.getElementById("sounds-btn");
  if (!btn) return;

  // Default ON
  setSoundsUI(!!soundsEnabled);

  btn.addEventListener("click", (e) => {
    e.preventDefault();
    soundsEnabled = !soundsEnabled;
    try { localStorage.setItem(SOUND_STORAGE_KEY, soundsEnabled ? "1" : "0"); } catch(_e){}
    setSoundsUI(soundsEnabled);
  });

  function setSoundsUI(on){
    btn.setAttribute("aria-pressed", on ? "true" : "false");
    btn.classList.toggle("is-off", !on);
    // cambia icona per stato OFF
    const ico = btn.querySelector(".tsb-toggle-ico");
    if (ico) ico.textContent = on ? "🔊" : "🔇";
  }
})();
// Init toggle in HOME (Vibrazione)
(function initHapticsToggle(){
  const btn = document.getElementById("haptics-btn");
  if (!btn) return;

  // Se non supportato, forza OFF
  const supported = !!(navigator && typeof navigator.vibrate === "function");
  if (!supported) {
    hapticsEnabled = false;
    try { localStorage.setItem(HAPTIC_STORAGE_KEY, "0"); } catch(_e){}
  }

  setHapticsUI(!!hapticsEnabled);

  btn.addEventListener("click", (e) => {
    e.preventDefault();
    if (!supported) return;
    hapticsEnabled = !hapticsEnabled;
    try { localStorage.setItem(HAPTIC_STORAGE_KEY, hapticsEnabled ? "1" : "0"); } catch(_e){}
    setHapticsUI(hapticsEnabled);
    // Se il browser non supporta vibrazione aptica (es. iOS Chrome/Safari),
    // disattivo subito e avviso l'utente (per evitare un toggle "finto").
    if (hapticsEnabled && !supportsHaptics()){
      hapticsEnabled = false;
      try { localStorage.setItem(HAPTIC_STORAGE_KEY, "0"); } catch(_e){}
      setHapticsUI(false);
      tinyToast("Vibrazione non supportata dal browser su iPhone (serve app/PWA).");
      return;
    }
  });

  function setHapticsUI(on){
    btn.setAttribute("aria-pressed", on ? "true" : "false");
    btn.classList.toggle("is-off", !on);
    const ico = btn.querySelector(".tsb-toggle-ico");
    if (ico) ico.textContent = on ? "📳" : "📴";
  }
})();
// global click sound (discreto)
(function bindGlobalClickSound(){
  if (window.__uiSoundClicksBound) return;
  window.__uiSoundClicksBound = true;
  document.addEventListener("pointerdown", (e) => {
    if (!soundsEnabled && !hapticsEnabled) return;
    const t = e.target && e.target.closest ? e.target.closest("button, [role='button'], .home-btn, .participant-row, .biker-list-item, .bp-item") : null;
    if (!t) return;
    if (t.id === "sounds-btn" || t.closest(".tsb-toggle-buttons") || t.id === "haptics-btn" || t.closest(".tsb-toggle-buttons")) return;
    if (t.getAttribute && t.getAttribute("data-sound") === "none") return;
    playUiClick();
    doHaptic();
  }, false);
})();
const USER_ID_STORAGE_KEY = "crs_userId_v2";
const USERNAME_STORAGE_KEY = "crs_username_v2";

window.__bikersCache = [];
let MAX_BIKERS = 20;


// ===== Nuovo algoritmo CRS Score basato su peso relativo =====
const BASE_RIDER_WEIGHT_KG = 65;
const BASE_BIKE_WEIGHT_KG = 15;
const BASE_TOTAL_WEIGHT_KG = BASE_RIDER_WEIGHT_KG + BASE_BIKE_WEIGHT_KG;


function computeCoyoteScore(batteryWh, totalWeightKg, percentRemaining) {
  const battery = parseFloat(batteryWh);
  const totalWeight = parseFloat(totalWeightKg);
  let percent = parseFloat(percentRemaining);

  if (!Number.isFinite(battery) || battery <= 0) return null;
  if (!Number.isFinite(totalWeight) || totalWeight <= 0) return null;
  if (!Number.isFinite(percent)) return null;

  if (percent < 0) percent = 0;
  if (percent > 100) percent = 100;

  // 1) Wh consumati (NON rimanenti)
  const consumedWh  = battery * (1 - percent / 100);
  const remainingWh = battery * (percent / 100); // solo informativo

  // se praticamente non ha consumato, evitiamo numeri assurdi
  if (consumedWh <= 0) return null;

  // 2) Normalizzazione al peso standard (80 kg)
  // Wh_cons_norm = Wh_cons * (Peso_std / Peso_tot)
  const normalizedConsumedWh = consumedWh * (BASE_TOTAL_WEIGHT_KG / totalWeight);

  // 3) Efficienza Wh/kg reale (dato per pannello Test)
  const efficiencyWhPerKg = totalWeight > 0 ? (consumedWh / totalWeight) : Infinity;

  // 4) Coyote Score: più sei efficiente (meno Wh consumati normalizzati), più il punteggio sale
  const SCORE_SCALE = 1000; // fattore di scala per numeri "comodi"
  const score = SCORE_SCALE / normalizedConsumedWh;

  if (!Number.isFinite(score)) return null;

  return { percent, consumedWh, remainingWh, efficiencyWhPerKg, score };
}
// ===== Fine nuovo algoritmo =====


/* Loading dots */
let loadingDotCount = 0;
const loadingInterval = setInterval(() => {
  const dots = document.getElementById("loading-dots");
  if (dots) {
    loadingDotCount = (loadingDotCount + 1) % 4;
    dots.textContent = ".".repeat(loadingDotCount);
  }
}, 400);

/* Bikers loading popup */
let bikersLoadingInterval = null;
function showBikersLoading() {
  const overlay = document.getElementById("bikers-loading-overlay");
  if (!overlay) return;
  overlay.style.display = "flex";
}
function hideBikersLoading() {
  const overlay = document.getElementById("bikers-loading-overlay");
  if (overlay) overlay.style.display = "none";
}


// Mostra SEMPRE e SOLO la ruota durante qualsiasi operazione verso il database (API_URL)
(() => {
  const _origFetch = window.fetch ? window.fetch.bind(window) : null;
  if (!_origFetch) return;

  let _dbPending = 0;
  window.fetch = function(resource, init) {
    const isApi = (typeof resource === "string" && resource.indexOf(API_URL) === 0) || (resource === API_URL);
    if (isApi) {
      _dbPending++;
      showBikersLoading();
    }
    const p = _origFetch(resource, init);
    // In caso di fetch non-Promise (raro), fallback
    if (!p || typeof p.finally !== "function") return p;
    return p.finally(() => {
      if (isApi) {
        _dbPending = Math.max(0, _dbPending - 1);
        if (_dbPending === 0) hideBikersLoading();
      }
    });
  };
})();


/* REFERENCES */
const dbContainer = document.getElementById("db-container");
const loadingPopupOverlay = document.getElementById("loading-popup-overlay");

const bikerModalOverlay = document.getElementById("biker-modal-overlay");
const bikerModalTitle   = document.getElementById("biker-modal-title");
const bikerModalName    = document.getElementById("biker-modal-name");
const bikerModalBattery = document.getElementById("biker-modal-battery");
const bikerModalRider   = document.getElementById("biker-modal-rider");
const bikerModalBike    = document.getElementById("biker-modal-bike");
const bikerModalBtnSave   = document.getElementById("biker-modal-save");
const bikerModalBtnDelete = document.getElementById("biker-modal-delete");
const bikerModalBtnCancel = document.getElementById("biker-modal-cancel");

const selectContainer = document.getElementById("select-container");
const playersContainer = document.getElementById("players-container");
const raceInfoContainer = document.getElementById("race-info-container");
const rankingList = document.getElementById("ranking-list");
const rankingBox = document.getElementById("ranking-box");
const saveRaceButton = document.getElementById("save-race-button");

const homeView = document.getElementById("home-view");
const homeBtnRace = document.getElementById("home-btn-race");
const homeBtnPerformance = document.getElementById("home-btn-performance");
const homeBtnTest = document.getElementById("home-btn-test");
const homeBtnBikers = document.getElementById("home-btn-bikers");
const homeAccountPill = document.getElementById("home-account-pill");

const homeBtnBikePerformance = document.getElementById("home-btn-bike-performance");
if (homeBtnBikePerformance) {
  homeBtnBikePerformance.onclick = async () => {
    showBikersLoading();
    try {
      // Carica dati gara se necessario (riusa pipeline Performance)
      await loadPerformanceView();
      // Render pagina elenco biker + storico
      renderBikersPerformanceView();
      // Mostra la view corretta (gestisce anche home-mode/container)
      showView("bikersPerformance");
    try { if (typeof bpSetCompareControlsVisibility === "function") bpSetCompareControlsVisibility(); } catch(e) {}
      // Stato iniziale: lista visibile, profilo chiuso
      if (bpList) bpList.style.display = "flex";
      if (bpProfile) bpProfile.style.display = "none";
      hideBpPopup();
    } finally {
      hideBikersLoading();
    }
  };
}
const mainButtons = document.getElementById("main-buttons");
const btnDb = document.getElementById("btn-db");
const btnSelect = document.getElementById("btn-select");
const btnGara = document.getElementById("btn-gara");
const calcBtn = document.getElementById("calc-btn");
const btnReset = document.getElementById("btn-reset");

const raceDateInput = document.getElementById("race-date-input");
if (raceDateInput) raceDateInput.addEventListener("change", updateRaceDateDisplay);
const raceCircuitInput = document.getElementById("race-circuit-input");
const raceDistanceInput = document.getElementById("race-distance-input");
const raceElevationInput = document.getElementById("race-elevation-input");

const raceDateDisplay = document.getElementById("race-date-display");
const raceDistanceDisplay = document.getElementById("race-distance-display");
const raceElevationDisplay = document.getElementById("race-elevation-display");

const performanceContainer = document.getElementById("performance-container");
const performanceBars = document.getElementById("performance-bars");
const performanceEmpty = document.getElementById("performance-empty");
const performanceTitle = document.getElementById("performance-title");
const performanceSubtitle = document.getElementById("performance-subtitle");
const performanceOverallBtn = document.getElementById("performance-overall-btn");
const performanceRaceBtn = document.getElementById("performance-race-btn");
const raceCalendar = document.getElementById("race-calendar");

const performanceRaceHeader = document.getElementById("performance-race-header");
const performanceBikersBtn = document.getElementById("performance-bikers-btn");
const bikersPerformanceView = document.getElementById("bikers-performance-view");
const bpList = document.getElementById("bp-list");
const bpProfile = document.getElementById("bp-profile");
const bpProfileName = document.getElementById("bp-profile-name");
const bpProfileBack = document.getElementById("bp-profile-back");

const bpPopupOverlay = document.getElementById("bp-popup-overlay");
const bpPopupTitle = document.getElementById("bp-popup-title");
const bpPopupContent = document.getElementById("bp-popup-content");
const bpPopupClose = document.getElementById("bp-popup-close");
const bpBackBtn = document.getElementById("bp-back-btn");
if (bpBackBtn) {
  bpBackBtn.addEventListener("click", () => {
    // BACK = return to bikers list
    if (bpProfile) bpProfile.style.display = "none";
    if (bpList) bpList.style.display = "flex";
  });
}


// BP RETURN TO BIKE PERFORMANCE

const bpReturnBtn = document.getElementById("bp-return-bike-performance");
if (bpReturnBtn) {
  bpReturnBtn.addEventListener("click", () => {
    if (bpProfile) bpProfile.style.display = "none";
    if (bpList) bpList.style.display = "flex";
    showView("bikersPerformance");
  });
}



const perfRaceDateDisplay = document.getElementById("perf-race-date-display");
const perfRaceDistanceDisplay = document.getElementById("perf-race-distance-display");
const perfRaceElevationDisplay = document.getElementById("perf-race-elevation-display");

/* TEST */
const testView = document.getElementById("test-view");
const testRankingList = document.getElementById("test-ranking-list");
const testBatteryInput = document.getElementById("test-battery-input");
const testWeightInput = document.getElementById("test-weight-input");
const testBikeWeightInput = document.getElementById("test-bike-weight-input");
const testPercentInput = document.getElementById("test-percent-input");
const testCalcBtn = document.getElementById("test-calc-btn");
const testResetBtn = document.getElementById("test-reset-btn");
const testTabs = document.querySelectorAll(".test-tab");
const testTabContents = document.querySelectorAll(".test-tab-content");

testTabs.forEach((tab) => {
  tab.addEventListener("keydown", (e) => {
    if (e.key === "Enter" || e.key === " ") {
      e.preventDefault();
      tab.click();
    }
  });
});


/* AUTH & ACCOUNT */
const authOverlay = document.getElementById("auth-overlay");
const authToggleLogin = document.getElementById("auth-toggle-login");
const authToggleRegister = document.getElementById("auth-toggle-register");
const authUsernameInput = document.getElementById("auth-username");
const authPasswordInput = document.getElementById("auth-password");
const authSubmitButton = document.getElementById("auth-submit");
const authErrorLabel = document.getElementById("auth-error");
const accountBadge = document.getElementById("account-badge");
const versionLabel = document.getElementById("version-label");

const viewSections = [
  dbContainer,
  selectContainer,
  playersContainer,
  raceInfoContainer,
  performanceContainer,
  bikersPerformanceView,
  testView,
  rankingBox
];
viewSections.forEach((v) => {
  if (v) v.classList.add("view-section");
});


let authMode = "login";
let selectedIndices = {};
let currentView = "home";
let allRaces = [];
let performanceMode = "overall";
let currentRaceSample = null;

/* ACCOUNT UTILS */
/* ACCOUNT CACHE (RAM + localStorage) */
const CACHE_TTL_MS = 1000 * 60 * 60 * 6; // 6 ore
const CACHE_SCHEMA = 1;

function cacheKeyForUser(userId) {
  return `crs_account_cache_v${CACHE_SCHEMA}_${userId}`;
}

function readAccountCache(userId) {
  try {
    const raw = localStorage.getItem(cacheKeyForUser(userId));
    if (!raw) return null;
    const obj = JSON.parse(raw);
    if (!obj || !obj.ts) return null;
    const age = Date.now() - obj.ts;
    if (age > CACHE_TTL_MS) return null;
    return obj;
  } catch {
    return null;
  }
}

function writeAccountCache(userId, bikers, races) {
  try {
    const obj = { ts: Date.now(), bikers: bikers || [], races: races || [] };
    localStorage.setItem(cacheKeyForUser(userId), JSON.stringify(obj));
  } catch {
    // storage pieno / limitazioni iOS: ignora
  }
}

function clearAccountCache(userId) {
  try { localStorage.removeItem(cacheKeyForUser(userId)); } catch {}
}

let __refreshInFlight = false;

async function fetchAllAccountDataFromServer(userId) {
  // Preferisci endpoint unico (più veloce). Fallback se non presente.
  try {
    const url = `${API_URL}?action=getAllData&userId=${encodeURIComponent(userId)}`;
    const res = await fetchWithTimeout(url, { cache: "no-store" }, 8000);
    if (!res.ok) throw new Error("HTTP " + res.status);
    const data = await res.json().catch(() => null);
    if (!data || !data.ok) throw new Error((data && data.error) ? data.error : "getAllData non ok");

    const bikers = Array.isArray(data.bikers) ? data.bikers : [];
    const racesRaw = Array.isArray(data.races) ? data.races : [];
    const racesFlat = flattenRacesForClient(racesRaw, bikers);
    return { bikers, racesFlat };
  } catch (e) {
    // Fallback: usa le chiamate esistenti (più lente)
    await loadBikers();
    const bikers = Array.isArray(window.__bikersCache) ? window.__bikersCache : [];
    const racesFlat = await fetchRacesFlatLegacy(userId, bikers);
    return { bikers, racesFlat };
  }
}

async function refreshAccountDataInBackground(userId) {
  if (__refreshInFlight) return;
  __refreshInFlight = true;
  try {
    const fresh = await fetchAllAccountDataFromServer(userId);
    window.__bikersCache = fresh.bikers || [];
    window.allRaces = fresh.racesFlat || [];
    window.__accountData = { userId, bikers: window.__bikersCache, races: window.allRaces };
    writeAccountCache(userId, window.__bikersCache, window.allRaces);
  } catch {
    // ok: resta la cache
  } finally {
    __refreshInFlight = false;
  }
}

async function ensureAccountDataLoaded({ forceRefresh = false } = {}) {
  const userId = getCurrentUserId();
  if (!userId) return { userId: null, bikers: [], races: [] };

  if (!forceRefresh && window.__accountData && window.__accountData.userId === userId) {
    return window.__accountData;
  }

  if (!forceRefresh) {
    const cached = readAccountCache(userId);
    if (cached) {
      window.__bikersCache = cached.bikers || [];
      window.allRaces = cached.races || [];
      window.__accountData = { userId, bikers: window.__bikersCache, races: window.allRaces };
      refreshAccountDataInBackground(userId); // refresh senza bloccare UI
      return window.__accountData;
    }
  }

  const fresh = await fetchAllAccountDataFromServer(userId);
  window.__bikersCache = fresh.bikers || [];
  window.allRaces = fresh.racesFlat || [];
  window.__accountData = { userId, bikers: window.__bikersCache, races: window.allRaces };
  writeAccountCache(userId, window.__bikersCache, window.allRaces);
  return window.__accountData;
}

/* Helper: flatten gare (server->client) */
function flattenRacesForClient(racesRaw, bikers) {
  const bikerByName = new Map();
  (bikers || []).forEach(b => bikerByName.set((b.name || "").trim().toLowerCase(), b));

  const racesFlat = [];
  (racesRaw || []).forEach(race => {
    const results = Array.isArray(race.results) ? race.results : [];
    results.forEach(resBiker => {
      const name = (resBiker && resBiker.name) ? String(resBiker.name) : "";
      const key = name.trim().toLowerCase();
      const meta = bikerByName.get(key) || {};
      racesFlat.push({
        userId: race.userId || "",
        raceId: race.raceId || "",
        date: race.date || "",
        circuit: race.circuit || "",
        km: Number(race.km) || 0,
        elevation: Number(race.elevation) || 0,
        name: name,
        score: Number(resBiker.score) || 0,
        batteryWh: Number(meta.batteryWh) || 0,
        riderKg: Number(meta.riderKg) || 0,
        bikeKg: Number(meta.bikeKg) || 0
      });
    });
  });

  return racesFlat;
}

/* Fallback legacy: GET getRaces e flatten client-side */
async function fetchRacesFlatLegacy(userId, bikers) {
  const url = `${API_URL}?action=getRaces&userId=${encodeURIComponent(userId)}`;
  const res = await fetchWithTimeout(url, { cache: "no-store" }, 8000);
  if (!res.ok) return [];
  const data = await res.json().catch(() => null);
  if (!data || !data.ok) return [];
  return flattenRacesForClient(data.races || [], bikers || []);
}

function getCurrentUserId() {
  return localStorage.getItem(USER_ID_STORAGE_KEY);
}
function getCurrentUsername() {
  return localStorage.getItem(USERNAME_STORAGE_KEY) || "";
}
function setCurrentUser(userId, username) {
  localStorage.setItem(USER_ID_STORAGE_KEY, userId);
  localStorage.setItem(USERNAME_STORAGE_KEY, username || "");
  updateAccountBadge();
  updateHomeAccountPill();





}
function clearCurrentUser() {
  try {
    const uid = localStorage.getItem(USER_ID_STORAGE_KEY);
    if (uid) clearAccountCache(uid);
  } catch {}
  window.__accountData = null;
  window.allRaces = [];
  window.__bikersCache = [];

  localStorage.removeItem(USER_ID_STORAGE_KEY);
  localStorage.removeItem(USERNAME_STORAGE_KEY);
  updateAccountBadge();
  updateHomeAccountPill();





}

/**
 * Chiede la password dell'account e la verifica chiamando action:"login".
 * Serve come conferma prima di operazioni distruttive (cancella gara / reset).
 */
async function requireAccountPasswordConfirm(message) {
  const username = getCurrentUsername();
  if (!username) {
    alert("Nessun account attivo. Effettua prima il login.");
    return false;
  }
  const pwd = prompt(message || "Inserisci la password dell’account per confermare:");
  if (pwd === null) return false; // annullato

  try {
    const res = await fetch(API_URL, {
      method: "POST",
      headers: { "Content-Type": "text/plain" },
      body: JSON.stringify({ action: "login", username, password: pwd })
    });
    const data = await res.json().catch(() => null);
    if (data && data.ok) return true;

    alert("Password errata.");
    return false;
  } catch (e) {
    console.error(e);
    alert("Errore di rete durante la verifica password.");
    return false;
  }
}


function updateAccountBadge() {
  if (!accountBadge) return;
  const uid = getCurrentUserId();
  const name = getCurrentUsername();
  if (!uid) accountBadge.textContent = "Nessun account";
  else accountBadge.textContent = name ? ("@" + name) : uid;
}


function updateHomeAccountPill() {
  if (!homeAccountPill) return;
  const uid = getCurrentUserId();
  const name = getCurrentUsername();

  const homeLogoutBtn = document.getElementById("home-logout-btn");
  if (homeLogoutBtn) homeLogoutBtn.style.display = "none";

  if (!uid) {
    homeAccountPill.textContent = "Account";
    homeAccountPill.style.opacity = "0.6";
  } else {
    homeAccountPill.textContent = "@" + (name || uid);
    homeAccountPill.style.opacity = "1";
  }
}

if (versionLabel) {
  versionLabel.textContent = APP_VERSION;
}

const homeVersionLabel = document.getElementById("home-version-label");
if (homeVersionLabel) homeVersionLabel.textContent = APP_VERSION;

// Home audio toggle (soundsEnabled + localStorage)
const homeAudioPill = document.getElementById("home-audio-pill");
function __syncHomeAudioPill(){
  if (!homeAudioPill) return;
  homeAudioPill.textContent = soundsEnabled ? "🔊" : "🔇";
}
__syncHomeAudioPill();
homeAudioPill?.addEventListener("click", () => {
  setSoundsEnabled(!soundsEnabled);
  // iOS: ensure AudioContext is allowed only after gesture; this call is safe
  __ensureAudioCtx();
  __syncHomeAudioPill();
});



updateAccountBadge();
updateHomeAccountPill();








/* AUTH UI */
function showAuthOverlay(message) {
  if (authOverlay) {
    authOverlay.style.display = "flex";
    if (message && authErrorLabel) authErrorLabel.textContent = message;
  }
}
function hideAuthOverlay() {
  if (authOverlay) {
    authOverlay.style.display = "none";
    if (authErrorLabel) authErrorLabel.textContent = "";
  }
}
function setAuthMode(mode) {
  authMode = mode === "register" ? "register" : "login";
  if (!authToggleLogin || !authToggleRegister || !authSubmitButton) return;
  if (authMode === "login") {
    authToggleLogin.classList.add("active");
    authToggleRegister.classList.remove("active");
    authSubmitButton.textContent = "Entra";
  } else {
    authToggleLogin.classList.remove("active");
    authToggleRegister.classList.add("active");
    authSubmitButton.textContent = "Crea account";
  }
  if (authErrorLabel) authErrorLabel.textContent = "";
}
if (authToggleLogin) authToggleLogin.onclick = () => setAuthMode("login");
if (authToggleRegister) authToggleRegister.onclick = () => setAuthMode("register");
if (accountBadge) {
  accountBadge.onclick = () => {
    const confirmLogout = confirm("Vuoi cambiare account? (Logout)");
    if (!confirmLogout) return;
    clearCurrentUser();
    showAuthOverlay();
  };
}

/* AUTH SUBMIT */
async function handleAuthSubmit() {
  if (!authUsernameInput || !authPasswordInput) return;
  const username = authUsernameInput.value.trim();
  const password = authPasswordInput.value;

  if (!username || !password) {
    if (authErrorLabel) authErrorLabel.textContent = "Inserisci username e password.";
    return;
  }

  const payload = {
    action: authMode === "register" ? "createUser" : "login",
    username,
    password
  };

  try {
    if (authErrorLabel) authErrorLabel.textContent = "";
    const res = await fetch(API_URL, {
      method: "POST",
      headers: { "Content-Type": "text/plain" },
      body: JSON.stringify(payload)
    });
    const data = await res.json().catch(() => null);
    if (!data || !data.ok) {
      if (authErrorLabel) authErrorLabel.textContent = data && data.error ? data.error : "Errore autenticazione";
      return;
    }
    const userId = data.userId;
    setCurrentUser(userId, username);
    hideAuthOverlay();
    await loadBikers(true);
    showView("home");
  } catch (e) {
    console.error(e);
    if (authErrorLabel) authErrorLabel.textContent = "Errore di rete.";
  }
}
if (authSubmitButton) authSubmitButton.onclick = handleAuthSubmit;

/* PERFORMANCE BUTTON TEXT */
function updateResetPerformanceButton() {
  const btn = document.getElementById("reset-performance-btn");
  if (!btn) return;
  if (performanceMode === "race" && currentRaceSample) btn.textContent = "Cancella";
  else btn.textContent = "Reset";
}

/* LOAD BIKERS */
async function loadBikers(force = false) {
  const userId = getCurrentUserId();
  if (!userId) {
    showAuthOverlay("Effettua il login per vedere i tuoi bikers.");
    return [];
  }
  if (!force && window.__bikersCache.length > 0) return window.__bikersCache;
  try {
    const url = API_URL + "?action=getBikers&userId=" + encodeURIComponent(userId);
    const res = await fetchWithTimeout(url, { cache: "no-store" }, 8000);
    if (!res.ok) throw new Error("Errore rete");
    const text = await res.text();
    const data = JSON.parse(text);
    if (!data.ok) throw new Error(data.error || "Errore API getBikers");
    const bikers = Array.isArray(data.bikers) ? data.bikers : [];
    window.__bikersCache = bikers;
    return bikers;
  } catch (e) {
    console.error(e);
    return window.__bikersCache;
  }
}

/* SAVE BIKERS */
async function saveBikersToServer(bikers) {
  const userId = getCurrentUserId();
  if (!userId) {
    showAuthOverlay("Effettua il login per salvare i bikers.");
    return;
  }
  try {
    const res = await fetch(API_URL, {
      method: "POST",
      headers: { "Content-Type": "text/plain" },
      body: JSON.stringify({
        action: "saveBikers",
        userId,
        bikers
      })
    });
    const data = await res.json().catch(() => null);
    if (!data || !data.ok) {
      console.error("API saveBikers error", data);
      alert("Errore salvataggio bikers");
      return;
    }
    window.__bikersCache = data.bikers || [];
  } catch (e) {
    console.error(e);
    alert("Errore salvataggio");
  }
}

/* BOTTONI VIEW */
function updateButtonsForView(mode) {
  if (mode === "home") {
    mainButtons.style.display = "none";
    return;
  }

  if (mode === "db") {
    mainButtons.style.display = "none";
    return;
  }

  mainButtons.style.display = "flex";
  mainButtons.style.flexDirection = "column";
  mainButtons.style.justifyContent = "flex-start";

  [btnDb, btnSelect, btnGara, calcBtn, btnReset, saveRaceButton].forEach(b => {
    b.style.display = "none";
    b.style.flex = "";
    b.style.marginLeft = "";
    b.style.marginRight = "";
  });

  btnDb.style.background = "#FDE000"; btnDb.style.color = "#111";
  btnSelect.style.background = "#CC0000"; btnSelect.style.color = "#fff";
  btnGara.style.background = "#CC0000"; btnGara.style.color = "#fff";
  calcBtn.style.background = "#CC0000"; calcBtn.style.color = "#fff";
  btnReset.style.background = "#6b7280"; btnReset.style.color = "#fff";

  calcBtn.textContent = "Calcola classifica";

  if (mode === "select") {
    mainButtons.style.flexDirection = "column";
    if (btnGara) {
      btnGara.style.display = "block";
      btnGara.style.flex = "none";
      btnGara.style.padding = "24px"; // altezza doppia
    }
  } else if (mode === "percent") {
    mainButtons.style.flexDirection = "row";
    mainButtons.style.justifyContent = "space-between";
    btnSelect.style.display = "block";
    calcBtn.style.display = "block";
    calcBtn.textContent = "Conferma dati";
    btnSelect.style.background = "#FDE000"; btnSelect.style.color = "#111";
    btnSelect.style.flex = "1"; calcBtn.style.flex = "1";
    btnSelect.style.marginRight = "4px"; calcBtn.style.marginLeft = "4px";
    // bottoni più alti
    btnSelect.style.padding = "24px";
    calcBtn.style.padding = "24px";
  } else if (mode === "raceinfo") {
    calcBtn.style.display = "block";
    calcBtn.style.padding = "24px"; // tasto alto il doppio
  } else if (mode === "results") {
    // Bottoni risultati: affiancati, più alti e a pillola
    mainButtons.style.flexDirection = "row";
    mainButtons.style.justifyContent = "space-between";

    if (btnReset) {
      btnReset.style.display = "block";
      btnReset.style.background = "#FDE000";
      btnReset.style.color = "#111";
      btnReset.style.flex = "1";
      btnReset.style.marginRight = "6px";
      btnReset.style.borderRadius = "999px"; // pillola
      btnReset.style.padding = "24px";      // altezza doppia
      btnReset.style.fontSize = "20px";     // testo più grande
    }
    if (saveRaceButton) {
      saveRaceButton.style.display = "block";
      saveRaceButton.style.background = "#CC0000";
      saveRaceButton.style.color = "#fff";
      saveRaceButton.style.flex = "1";
      saveRaceButton.style.marginLeft = "6px";
      saveRaceButton.style.borderRadius = "999px"; // pillola
      saveRaceButton.style.padding = "24px";      // altezza doppia
      saveRaceButton.style.fontSize = "20px";     // testo più grande
    }
  } else if (mode === "performance" || mode === "test") {
    mainButtons.style.display = "none";
  }
}

function setActiveSection(elem, shouldShow, useFlex = false) {
  if (!elem) return;
  elem.classList.add("view-section");
  if (shouldShow) {
    elem.style.display = useFlex ? "flex" : "block";
    elem.classList.remove("active-view");
    // forza reflow per permettere la transizione
    void elem.offsetWidth;
    elem.classList.add("active-view");
  } else {
    elem.classList.remove("active-view");
    elem.style.display = "none";
  }
}

function showView(mode) {
  currentView = mode;

  if (mode === "home") document.body.classList.add("home-mode");
  else document.body.classList.remove("home-mode");

  if (homeView) homeView.style.display = (mode === "home") ? "flex" : "none";

  setActiveSection(dbContainer,        mode === "db");
  setActiveSection(selectContainer,    mode === "select");
  setActiveSection(playersContainer,   mode === "percent");
  setActiveSection(raceInfoContainer,  mode === "raceinfo", true);
  setActiveSection(performanceContainer, mode === "performance");
  setActiveSection(bikersPerformanceView, mode === "bikersPerformance");
  setActiveSection(testView,           mode === "test");
  setActiveSection(rankingBox,         mode === "results");

  updateButtonsForView(mode);

  // Confronto bikers: crea/mostra controlli solo nella vista Bike Performance
  try{
    if (mode === "bikersPerformance" && typeof bpEnsureCompareControls === "function") {
      bpEnsureCompareControls();
    }
    if (typeof bpSetCompareControlsVisibility === "function") bpSetCompareControlsVisibility();
  }catch(e){}
}

// Suono cambio vista (whoosh)
(function(){
  if (window.__soundShowViewPatched) return;
  window.__soundShowViewPatched = true;
  const _origShowView = showView;
  let __lastMode = null;
  showView = function(mode){
    try{
      if (__lastMode !== null && mode && mode !== __lastMode) playWhoosh();
      __lastMode = mode;
    }catch(e){}
    return _origShowView(mode);
  };
})();



/* DB VIEW */
async function renderDBView() {
  const userId = getCurrentUserId();
  if (!userId) {
    showAuthOverlay("Effettua il login per gestire i bikers.");
    return;
  }

  dbContainer.innerHTML = "";

  // Header (Liquid Glass)
  const header = document.createElement("div");
  header.className = "bikers-glass-header";

  const titleWrap = document.createElement("div");
  titleWrap.className = "bikers-glass-titlewrap";
  titleWrap.innerHTML = `
    <div class="bikers-glass-title">Bikers</div>
    <div class="bikers-glass-sub">Database profili (Wh · kg biker · kg bici)</div>
  `;

  const addTop = document.createElement("button");
  addTop.type = "button";
  addTop.className = "btn-small btn-db-add bikers-glass-add";
  addTop.textContent = "Nuovo biker";
  addTop.onclick = () => openBikerModal(null);

  header.appendChild(titleWrap);
  header.appendChild(addTop);
  dbContainer.appendChild(header);

  const bikers = await loadBikers(true);

  if (!bikers || bikers.length === 0) {
    const empty = document.createElement("div");
    empty.className = "bikers-glass-empty";
    empty.innerHTML = `
      <div class="bikers-glass-empty-ico">🏁</div>
      <div class="bikers-glass-empty-title">Nessun biker presente</div>
      <div class="bikers-glass-empty-text">Premi <b>Nuovo biker</b> per aggiungerne uno.</div>
    `;
    dbContainer.appendChild(empty);
    return;
  }

  const list = document.createElement("div");
  list.className = "biker-list biker-list-glass";

  bikers.forEach((biker, index) => {
    const btn = document.createElement("button");
    btn.type = "button";
    btn.className = "biker-list-item biker-list-item-glass";

    const initial = ((biker.name || "").trim().charAt(0)) || "?";
    const batteryWh   = biker.batteryWh ?? biker.battery ?? "";
    const riderWeight = biker.riderKg   ?? biker.weight  ?? "";
    const bikeWeight  = biker.bikeKg    ?? "";

    btn.innerHTML = `
      <div class="biker-item-left">
        <span class="biker-initial biker-initial-glass">${initial.toUpperCase()}</span>
        <div class="biker-item-text">
          <div class="biker-name-label">${biker.name || ("Biker " + (index + 1))}</div>
          <div class="biker-meta">${batteryWh} Wh · ${riderWeight} kg biker · ${bikeWeight} kg bici</div>
        </div>
      </div>
      <span class="biker-chevron">›</span>
    `;

    btn.onclick = () => openBikerModal(index);
    list.appendChild(btn);
  });

  dbContainer.appendChild(list);

  // Bottom spacer (keeps layout comfy on iPhone)
  const spacer = document.createElement("div");
  spacer.className = "bikers-glass-bottom-space";
  dbContainer.appendChild(spacer);
}

function createDBCard(b) {
  const card = document.createElement("div");
  card.className = "player-card";

  // Compatibilità: se arrivano dati vecchi con solo "weight", lo considero come peso biker
  const name        = b ? (b.name        ?? "") : "";
  const batteryWh   = b ? (b.batteryWh   ?? b.battery ?? "") : "";
  const riderWeight = b ? (b.riderKg     ?? b.weight  ?? "") : "";
  const bikeWeight  = b ? (b.bikeKg      ?? "") : "";

  card.innerHTML = `
    <div class="player-title">
      <span>${name || "Nuovo Biker"}</span>
      <button class="delete-biker">✕</button>
    </div>
    <input class="name-input" placeholder="Nome" value="${name}">
    <input class="battery-input" type="number" placeholder="Wh batteria" value="${batteryWh}">
    <input class="rider-weight-input" type="number" placeholder="Peso biker (kg)" value="${riderWeight}">
    <input class="bike-weight-input" type="number" placeholder="Peso bici (kg)" value="${bikeWeight}">
  `;

  card.querySelector(".delete-biker").onclick = () => card.remove();

  const btnRow = document.getElementById("db-buttons-inline");
  if (btnRow) dbContainer.insertBefore(card, btnRow);
  else dbContainer.appendChild(card);
}

async function saveDatabaseFromView() {
  const cards = [...dbContainer.getElementsByClassName("player-card")];
  const bikers = cards.map(c => {
    const nameVal        = c.querySelector(".name-input").value.trim();
    const batteryVal     = parseFloat(c.querySelector(".battery-input").value);
    const riderWeightVal = parseFloat(c.querySelector(".rider-weight-input").value);
    const bikeWeightVal  = parseFloat(c.querySelector(".bike-weight-input").value);

    const validName        = !!nameVal;
    const validBattery     = Number.isFinite(batteryVal)     && batteryVal > 0;
    const validRiderWeight = Number.isFinite(riderWeightVal) && riderWeightVal > 0;
    const validBikeWeight  = Number.isFinite(bikeWeightVal)  && bikeWeightVal > 0;

    if (!validName || !validBattery || !validRiderWeight || !validBikeWeight) return null;

    return {
      name:       nameVal,
      batteryWh:  batteryVal,
      riderKg:    riderWeightVal,
      bikeKg:     bikeWeightVal
    };
  }).filter(Boolean);

  if (bikers.length === 0) {
    alert("Inserisci almeno un biker valido (nome, Wh, peso biker, peso bici).");
    return;
  }

  if (bikers.length > MAX_BIKERS) {
    alert("Numero massimo di biker superato (" + MAX_BIKERS + ").");
    return;
  }

  await saveBikersToServer(bikers);
  await renderSelectView();
  showView("select");
}
let currentBikerIndex = null;

function openBikerModal(index) {
  const bikers = window.__bikersCache || [];
  currentBikerIndex = (typeof index === "number") ? index : null;

  if (!bikerModalOverlay) return;

  if (currentBikerIndex === null) {
    bikerModalTitle.textContent = "Nuovo biker";
    bikerModalName.value = "";
    bikerModalBattery.value = "";
    bikerModalRider.value = "65";
    bikerModalBike.value = "15";
    bikerModalBtnDelete.style.display = "none";
  } else {
    const b = bikers[currentBikerIndex];
    bikerModalTitle.textContent = "Modifica biker";
    bikerModalName.value = (b && b.name) ? b.name : "";
    bikerModalBattery.value = (b && b.batteryWh != null) ? b.batteryWh : "";
    bikerModalRider.value = (b && b.riderKg != null) ? b.riderKg : "";
    bikerModalBike.value = (b && b.bikeKg != null) ? b.bikeKg : "";
    bikerModalBtnDelete.style.display = "inline-block";
  }

  bikerModalOverlay.style.display = "flex";
}

function closeBikerModal() {
  if (bikerModalOverlay) bikerModalOverlay.style.display = "none";
  currentBikerIndex = null;
}

async function handleBikerModalSave() {
  const name = bikerModalName.value.trim();
  const batteryVal = parseFloat(bikerModalBattery.value);
  const riderVal = parseFloat(bikerModalRider.value);
  const bikeVal  = parseFloat(bikerModalBike.value);

  if (!name ||
      !Number.isFinite(batteryVal) || batteryVal <= 0 ||
      !Number.isFinite(riderVal)   || riderVal   <= 0 ||
      !Number.isFinite(bikeVal)    || bikeVal    <= 0) {
    alert("Inserisci nome, Wh, peso biker e peso bici validi.");
    return;
  }

  const bikers = Array.isArray(window.__bikersCache) ? [...window.__bikersCache] : [];

  const bikerData = {
    name,
    batteryWh: batteryVal,
    riderKg: riderVal,
    bikeKg: bikeVal
  };

  if (currentBikerIndex === null) {
    if (bikers.length >= MAX_BIKERS) {
      alert("Hai raggiunto il numero massimo di biker (" + MAX_BIKERS + ").");
      return;
    }
    bikers.push(bikerData);
  } else {
    bikers[currentBikerIndex] = bikerData;
  }

  await saveBikersToServer(bikers);
  closeBikerModal();
  await renderDBView();
}

async function handleBikerModalDelete() {
  if (currentBikerIndex === null) {
    closeBikerModal();
    return;
  }

  if (!confirm("Eliminare questo biker dal database?")) return;

  const bikers = Array.isArray(window.__bikersCache) ? [...window.__bikersCache] : [];
  if (currentBikerIndex >= 0 && currentBikerIndex < bikers.length) {
    bikers.splice(currentBikerIndex, 1);
  }

  await saveBikersToServer(bikers);
  closeBikerModal();
  await renderDBView();
}

/* SELECT VIEW */
async function renderSelectView() {
  const userId = getCurrentUserId();
  if (!userId) {
    showAuthOverlay("Effettua il login per selezionare i bikers.");
    return;
  }

  // Liquid Glass — stesso design della pagina Bikers
  selectContainer.innerHTML = "";
  selectedIndices = {};

  // Header
  const header = document.createElement("div");
  header.className = "bikers-glass-header";

  const titleWrap = document.createElement("div");
  titleWrap.className = "bikers-glass-titlewrap";
  titleWrap.innerHTML = `
    <div class="bikers-glass-title">Race</div>
    <div class="bikers-glass-sub">Seleziona i bikers partecipanti (Wh · kg biker · kg bici)</div>
  `;

  header.appendChild(titleWrap);
  selectContainer.appendChild(header);

  const bikers = await loadBikers();

  if (!bikers || bikers.length === 0) {
    const empty = document.createElement("div");
    empty.className = "bikers-glass-empty";
    empty.innerHTML = `
      <div class="bikers-glass-empty-ico">🏁</div>
      <div class="bikers-glass-empty-title">Nessun biker presente</div>
      <div class="bikers-glass-empty-text">Vai su <b>Bikers</b> per aggiungerne uno.</div>
    `;
    selectContainer.appendChild(empty);
    return;
  }

  const list = document.createElement("div");
  list.className = "biker-list biker-list-glass race-select-list";
  selectContainer.appendChild(list);

  bikers.forEach((b, i) => createParticipantRow(b, i, list));

  const spacer = document.createElement("div");
  spacer.className = "bikers-glass-bottom-space";
  selectContainer.appendChild(spacer);
}

function createParticipantRow(b, i, listEl) {
  const btn = document.createElement("button");
  btn.type = "button";
  btn.className = "biker-list-item biker-list-item-glass race-select-item";
  btn.dataset.index = i;

  const initial = (b.name && b.name.trim().charAt(0))
    ? b.name.trim().charAt(0).toUpperCase()
    : "?";

  const batteryWh   = b.batteryWh ?? b.battery ?? "";
  const riderWeight = b.riderKg   ?? b.weight  ?? "";
  const bikeWeight  = b.bikeKg    ?? "";

  btn.innerHTML = `
    <div class="biker-item-left">
      <span class="biker-initial biker-initial-glass">${initial}</span>
      <div class="biker-item-text">
        <div class="biker-name-label">${b.name}</div>
        <div class="biker-meta">${batteryWh} Wh · ${riderWeight} kg biker · ${bikeWeight} kg bici</div>
      </div>
    </div>
    <span class="biker-chevron race-select-mark" aria-hidden="true">›</span>
  `;

  const mark = btn.querySelector(".race-select-mark");

  const toggleSelected = () => {
    selectedIndices[i] = !selectedIndices[i];
    btn.classList.toggle("selected", !!selectedIndices[i]);
    if (mark) mark.textContent = selectedIndices[i] ? "✓" : "›";
  };

  btn.addEventListener("click", toggleSelected);
  btn.addEventListener("keydown", (e) => {
    if (e.key === "Enter" || e.key === " ") {
      e.preventDefault();
      toggleSelected();
    }
  });

  (listEl || selectContainer).appendChild(btn);
}

/* GARA */
function clearPlayersUI() { playersContainer.innerHTML = ""; }

async function buildGaraFromSelection() {
  const userId = getCurrentUserId();
  if (!userId) {
    showAuthOverlay("Effettua il login per inserire i dati di gara.");
    return;
  }
  const bikers = await loadBikers();
  clearPlayersUI();
  let any = false;
  Object.keys(selectedIndices).forEach(i => {
    if (selectedIndices[i]) {
      createGaraCard(bikers[i]);
      any = true;
    }
  });
  if (!any) {
    alert("Seleziona almeno un Biker partecipante.");
    return;
  }
  showView("percent");
}

function createGaraCard(b) {
  const batteryWh   = b.batteryWh ?? b.battery ?? "";
  const riderWeight = b.riderKg   ?? b.weight  ?? "";
  const bikeWeight  = b.bikeKg    ?? "";

  const c = document.createElement("div");
  c.className = "player-card";
  c.innerHTML = `
    <div class="player-title"><span>${b.name}</span></div>
    <input type="hidden" class="name-input" value="${b.name}">
    <input type="hidden" class="battery-input" value="${batteryWh}">
    <input type="hidden" class="rider-weight-input" value="${riderWeight}">
    <input type="hidden" class="bike-weight-input" value="${bikeWeight}">
    <input type="number" class="percent-input" placeholder="% residua" min="0" max="100">
  `;
  playersContainer.appendChild(c);
}

/* COLLECT */
function collectResultsFromPercentView() {
  const cards = [...playersContainer.getElementsByClassName("player-card")];
  const results = cards.map(c => {
    const name    = c.querySelector(".name-input").value.trim();
    const battery = parseFloat(c.querySelector(".battery-input").value);
    const riderW  = parseFloat(c.querySelector(".rider-weight-input").value);
    const bikeW   = parseFloat(c.querySelector(".bike-weight-input").value);
    let percent   = parseFloat(c.querySelector(".percent-input").value);

    if (!name) return null;
    if (!Number.isFinite(battery) || battery <= 0) return null;
    if (!Number.isFinite(riderW) || riderW  <= 0) return null;
    if (!Number.isFinite(bikeW)  || bikeW   <= 0) return null;
    if (!Number.isFinite(percent)) return null;

    if (percent < 0) percent = 0;
    if (percent > 100) percent = 100;

    const totalWeight = riderW + bikeW;
    const calc = computeCoyoteScore(battery, totalWeight, percent);
    if (!calc) return null;

    return { name, percent: calc.percent, score: calc.score };
  }).filter(Boolean);

  window.__coyoteResults = results;
}

/* FORMATTARE DATA ITA */
function formatItalianDate(dateStr) {
  if (!dateStr) return "";
  const [year, month, day] = dateStr.split("-");
  const mesi = [
    "gennaio","febbraio","marzo","aprile","maggio","giugno",
    "luglio","agosto","settembre","ottobre","novembre","dicembre"
  ];
  const mIndex = parseInt(month, 10) - 1;
  const nomeMese = mesi[mIndex] || "";
  if (!nomeMese) return dateStr;
  return parseInt(day, 10) + " " + nomeMese + " " + year;
}

function updateRaceDateDisplay() {
  const v = raceDateInput.value;
  raceDateDisplay.textContent = v ? formatItalianDate(v) : "";
}

/* DATE PER PERFORMANCE */
function formatRaceDateForDisplay(raw) {
  if (!raw) return "";
  const s = raw.toString().trim();

  if (/^\d{4}-\d{2}-\d{2}$/.test(s)) {
    return formatItalianDate(s);
  }
  if (/^\d{1,2}\/\d{1,2}\/\d{4}$/.test(s)) {
    const parts = s.split("/");
    const dd = parts[0].padStart(2, "0");
    const mm = parts[1].padStart(2, "0");
    const yyyy = parts[2];
    return formatItalianDate(`${yyyy}-${mm}-${dd}`);
  }
  const d = new Date(s);
  if (!isNaN(d.getTime())) {
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth() + 1).padStart(2, "0");
    const dd = String(d.getDate()).padStart(2, "0");
    return formatItalianDate(`${yyyy}-${mm}-${dd}`);
  }
  return s;
}

/* COLORI BATTERIA & CLASSIFICA */
function batteryColorForPercent(p) {
  if (!Number.isFinite(p)) return "#9ca3af";
  if (p < 25) return "#ef4444";
  if (p < 50) return "#f97316";
  if (p < 75) return "#eab308";
  return "#22c55e";
}

function calculate() {
  const results = window.__coyoteResults || [];

  const dateVal = raceDateInput.value;
  const circuito = raceCircuitInput.value.trim();
  const km = raceDistanceInput.value.trim();
  const disl = raceElevationInput.value.trim();

  const formattedDate = dateVal ? formatItalianDate(dateVal) : "";

  let headerText = "";
  if (formattedDate && circuito) headerText = circuito + " - " + formattedDate;
  else if (formattedDate) headerText = formattedDate;
  else if (circuito) headerText = circuito;

  raceDateDisplay.textContent = headerText;
  raceDistanceDisplay.textContent = km ? km + " km" : "";
  raceElevationDisplay.textContent = disl ? disl + " m" : "";

  showView("results");
  rankingList.innerHTML = "";

  if (!results.length) {
    const li = document.createElement("li");
    li.textContent = "Nessun dato valido. Inserisci le %.";
    rankingList.appendChild(li);
    return;
  }

  results.sort((a, b) => b.score - a.score);

  results.forEach((r, i) => {
    const li = document.createElement("li");
    li.innerHTML = `
      <div class="result-left">
        <div class="result-topline">
          <span class="position-number">${i + 1}</span>
          <span class="result-name">${r.name || "Biker"}</span>
        </div>
        <div class="battery-row">
          <div class="battery">
            <div class="battery-level" style="background:${batteryColorForPercent(r.percent)}"></div>
            <span class="battery-percent-label">${r.percent}%</span>
          </div>
        </div>
      </div>
      <div class="result-right">
        <div class="right-topline">
          <span class="medal">${["🥇","🥈","🥉"][i] || "🏁"}</span>
          <span class="result-score">${r.score.toFixed(2)}</span>
        </div>
      </div>
    `;

    const level = li.querySelector(".battery-level");
    setTimeout(() => {
      const safePercent = Number.isFinite(r.percent) ? r.percent : 0;
      level.style.width = (Math.round(safePercent / 4) * 4) + "%";
    }, 50);

    rankingList.appendChild(li);
  });
}

/* MENU ICON */
const menuIcon = document.getElementById("menu-icon");
if (menuIcon) {
  menuIcon.onclick = () => showView("home");
  menuIcon.onkeydown = (e) => {
    if (e.key === "Enter" || e.key === " ") {
      e.preventDefault();
      showView("home");
    }
  };
}

/* HOME BUTTONS */
if (homeBtnRace) {
  homeBtnRace.onclick = async () => {
    await renderSelectView();
    showView("select");
  };
}
if (homeBtnPerformance) {
  homeBtnPerformance.onclick = () => loadPerformanceView();
}
if (homeBtnTest) {
  homeBtnTest.onclick = () => {
    initTestView();
    showView("test");
  };
}

if (document.getElementById("home-btn-account")) {
  document.getElementById("home-btn-account").onclick = () => {
    const uid = getCurrentUserId();
    const username = getCurrentUsername();

    // Se NON loggato → apri login
    if (!uid) {
      showAuthOverlay();
      return;
    }

    // Se loggato → chiedi logout
    const confirmLogout = confirm("Sei già connesso come " + (username ? ("@" + username) : uid) + ". Vuoi eseguire il logout?");
    if (confirmLogout) {
      clearCurrentUser();            // rimuove userId e username
      alert("Logout eseguito.");     // feedback
      showAuthOverlay();             // torna alla schermata di login
    }
  };
}

const homeAccountPillEl = document.getElementById("home-account-pill");
if (homeAccountPillEl) {
  // Click sul pill account: login / logout
  homeAccountPillEl.onclick = () => {
    const uid = getCurrentUserId();
    const username = getCurrentUsername();

    // Se NON loggato → apri login
    if (!uid) {
      showAuthOverlay();
      return;
    }

    // Se loggato → chiedi logout
    const confirmLogout = confirm("Sei già connesso come " + (username ? ("@" + username) : uid) + ". Vuoi eseguire il logout?");
    if (confirmLogout) {
      clearCurrentUser();
      alert("Logout eseguito.");
      showAuthOverlay();
    }
  };

  // Accessibilità tastiera: Invio/Spazio attivano il click
  homeAccountPillEl.addEventListener("keydown", (e) => {
    if (e.key === "Enter" || e.key === " ") {
      e.preventDefault();
      homeAccountPillEl.click();
    }
  });
}

if (homeBtnBikers) {
  homeBtnBikers.onclick = async () => {
    showBikersLoading();
    try {
      await renderDBView();
      showView("db");
    } finally {
      hideBikersLoading();
    }
  };
}


/* PULSANTI MODALE BIKER */
if (bikerModalBtnSave)   bikerModalBtnSave.onclick   = () => handleBikerModalSave();
if (bikerModalBtnDelete) bikerModalBtnDelete.onclick = () => handleBikerModalDelete();
if (bikerModalBtnCancel) bikerModalBtnCancel.onclick = () => closeBikerModal();

/* MAIN BUTTONS */
btnDb.onclick = () => { renderDBView(); showView("db"); };
btnSelect.onclick = () => { renderSelectView(); showView("select"); };
btnGara.onclick = () => buildGaraFromSelection();

calcBtn.onclick = () => {
  if (currentView === "percent") {
    collectResultsFromPercentView();
    if (!window.__coyoteResults || !window.__coyoteResults.length) {
      alert("Inserisci almeno una percentuale valida.");
      return;
    }
    showView("raceinfo");
  } else if (currentView === "raceinfo") {
    calculate();
  }
};

btnReset.onclick = () => {
  rankingList.innerHTML = "";
  raceDateInput.value = "";
  raceCircuitInput.value = "";
  raceDistanceInput.value = "";
  raceElevationInput.value = "";
  raceDateDisplay.textContent = "";
  raceDistanceDisplay.textContent = "";
  raceElevationDisplay.textContent = "";
  window.__coyoteResults = [];
  selectedIndices = {};
  renderSelectView();
  showView("select");
};

/* INVIO GARA AL DB – POST text/plain con no-cors */
async function sendRaceToDatabase() {
  if (!window.__coyoteResults || !window.__coyoteResults.length) {
    alert("Prima calcola la classifica (score) per la gara.");
    return;
  }

  const userId = getCurrentUserId();
  if (!userId) {
    showAuthOverlay("Effettua il login per salvare le gare.");
    return;
  }

  const dateVal = raceDateInput.value;
  const circuito = (raceCircuitInput.value || "").trim();
  const km = parseFloat(raceDistanceInput.value) || 0;
  const disl = parseFloat(raceElevationInput.value) || 0;

  const payload = {
    action: "saveRace",
    userId,
    race: {
      date: dateVal || "",
      circuit: circuito || "",
      km: km,
      elevation: disl,
      results: window.__coyoteResults
    }
  };

  try {
    await fetch(API_URL, {
      method: "POST",
      mode: "no-cors",
      headers: { "Content-Type": "text/plain" },
      body: JSON.stringify(payload)
    });

    alert("Gara inviata al nuovo database (controlla il foglio Google).");
  } catch (e) {
    console.error(e);
    alert("Errore di rete nell'invio della gara al database.");
  }
}
if (saveRaceButton) saveRaceButton.onclick = sendRaceToDatabase;

/* PERFORMANCE: MEDIE */
function computeWeightedAveragesByKm(races) {
  const bikerStats = {};
  (races || []).forEach(r => {
    const name = r.name;
    const score = Number(r.score);
    if (!name || !Number.isFinite(score)) return;

    const kmVal = Number(r.km);
    const weight = Number.isFinite(kmVal) && kmVal > 0 ? kmVal : 1;

    if (!bikerStats[name]) bikerStats[name] = { wsum: 0, wtot: 0 };
    bikerStats[name].wsum += score * weight;
    bikerStats[name].wtot += weight;
  });

  return Object.entries(bikerStats).map(([name, s]) => ({
    name,
    avg: s.wtot > 0 ? (s.wsum / s.wtot) : 0
  }));
}

function renderPerformanceBars(entries) {
  if (!performanceBars) return;

  if (!entries || !entries.length) {
    performanceBars.innerHTML = "";
    if (performanceEmpty) {
      performanceEmpty.textContent = "Nessun dato valido.";
      performanceEmpty.style.display = "block";
    }
    return;
  }

  const maxScore = Math.max(...entries.map(e => e[1])) || 1;
  performanceBars.innerHTML = "";
  if (performanceEmpty) performanceEmpty.style.display = "none";

  entries.sort((a, b) => b[1] - a[1]);
  const lastIndex = entries.length - 1;

  entries.forEach((entry, index) => {
    const [name, total] = entry;

    const bar = document.createElement("div");
    bar.style.flex = "1";
    bar.style.minWidth = "24px";
    bar.style.display = "flex";
    bar.style.flexDirection = "column";
    bar.style.alignItems = "center";
    bar.style.justifyContent = "flex-end";

    const medal = document.createElement("div");
    let medalEmoji = "";
    if (index === 0) medalEmoji = "🥇";
    else if (index === 1) medalEmoji = "🥈";
    else if (index === 2) medalEmoji = "🥉";
    else if (index === lastIndex) medalEmoji = "🍗";
    medal.textContent = medalEmoji;
    medal.style.fontSize = "32px";
    medal.style.marginBottom = "2px";
    if (!medalEmoji) medal.style.visibility = "hidden";

    const val = document.createElement("div");
    val.textContent = total.toFixed(2);
    val.style.fontSize = "12px";
    val.style.color = "#dc2626";
    val.style.fontWeight = "700";
    val.style.marginBottom = "2px";

    const inner = document.createElement("div");
    inner.style.width = "100%";
    inner.style.borderRadius = "6px 6px 0 0";
    inner.style.background = "linear-gradient(to top, #CC0000, #F97316)";
    inner.style.height = "0%";

    const label = document.createElement("div");
    label.textContent = name;
    label.style.fontSize = "11px";
    label.style.color = "#111827";
    label.style.marginTop = "4px";
    label.style.textAlign = "center";
    label.style.whiteSpace = "nowrap";
    label.style.overflow = "hidden";
    label.style.textOverflow = "ellipsis";

    bar.appendChild(medal);
    bar.appendChild(val);
    bar.appendChild(inner);
    bar.appendChild(label);
    performanceBars.appendChild(bar);

    requestAnimationFrame(() => {
      const h = Math.max(6, (total / maxScore) * 100);
      inner.style.height = h + "%";
    });
  });
}

function updatePerformanceRaceHeader(raceSample) {
  if (!performanceRaceHeader) return;

  if (!raceSample) {
    performanceRaceHeader.style.display = "none";
    if (perfRaceDateDisplay) perfRaceDateDisplay.textContent = "";
    if (perfRaceDistanceDisplay) perfRaceDistanceDisplay.textContent = "";
    if (perfRaceElevationDisplay) perfRaceElevationDisplay.textContent = "";
    return;
  }

  const rawDate = getRaceDateString(raceSample);
  const circuit = (raceSample.circuit || "").toString().trim();
  const kmVal = Number(raceSample.km);
  const elevVal = Number(raceSample.elevation || 0);

  const dateText = formatRaceDateForDisplay(rawDate);
  let headerText = "";
  if (circuit && dateText) headerText = circuit + " - " + dateText;
  else if (dateText) headerText = dateText;
  else if (circuit) headerText = circuit;

  if (perfRaceDateDisplay) perfRaceDateDisplay.textContent = headerText;
  if (perfRaceDistanceDisplay) {
    perfRaceDistanceDisplay.textContent = Number.isFinite(kmVal) && kmVal > 0 ? kmVal + " km" : "";
  }
  if (perfRaceElevationDisplay) {
    perfRaceElevationDisplay.textContent = Number.isFinite(elevVal) && elevVal > 0 ? elevVal + " m" : "";
  }

  performanceRaceHeader.style.display = "block";
}

function renderPerformanceOverall() {
  performanceMode = "overall";
  currentRaceSample = null;
  updateResetPerformanceButton();

  const races = allRaces || [];
  if (!races.length) {
    if (performanceEmpty) {
      performanceEmpty.textContent = "Nessuna gara registrata.";
      performanceEmpty.style.display = "block";
    }
    if (performanceBars) performanceBars.innerHTML = "";
    updatePerformanceRaceHeader(null);
    return;
  }

  if (performanceTitle && performanceSubtitle) {
    performanceTitle.textContent = "Performance complessive";
    performanceSubtitle.textContent = "Media pesata delle performance su tutte le gare per ogni biker.";
  }

  const avgsArr = computeWeightedAveragesByKm(races);
  const entries = avgsArr.map(e => [e.name, e.avg]);
  renderPerformanceBars(entries);
  updatePerformanceRaceHeader(null);
}

function getRaceDateString(r) {
  if (!r) return "";
  return (r.date || r.data || r.raceDate || r.garaDate || r.gara || "").toString().trim();
}

function renderPerformanceForRaceFilter(query) {
  const races = allRaces || [];
  if (!races.length) {
    alert("Nessuna gara registrata nel database.");
    updatePerformanceRaceHeader(null);
    return;
  }
  const q = (query || "").trim().toLowerCase();
  if (!q) return;

  const filtered = races.filter(r => {
    const d = getRaceDateString(r).toLowerCase();
    const c = (r.circuit || "").toString().toLowerCase();
    return d === q || d.includes(q) || c.includes(q);
  });

  if (!filtered.length) {
    alert("Nessuna gara trovata per: " + query);
    updatePerformanceRaceHeader(null);
    return;
  }

  performanceMode = "race";
  currentRaceSample = filtered[0] || null;
  updateResetPerformanceButton();

  if (performanceTitle && performanceSubtitle) {
    performanceTitle.textContent = "Gara specifica";
    performanceSubtitle.textContent = "";
  }

  const avgsArr = computeWeightedAveragesByKm(filtered);
  const entries = avgsArr.map(e => [e.name, e.avg]);
  renderPerformanceBars(entries);

  updatePerformanceRaceHeader(filtered[0]);
}

/* CALENDARIO GARE */
function openRaceCalendar() {
  const races = allRaces || [];
  if (!races.length) {
    alert("Nessuna gara registrata nel database.");
    return;
  }
  if (!raceCalendar) return;

  const datesMap = new Map();

  
function normalizeDate(str) {
    if (!str) return null;
    const s = str.trim();
    let y, m, d;

    // Caso con timestamp: usiamo direttamente l'oggetto Date in locale
    if (s.includes("T")) {
      const dt = new Date(s);
      if (isNaN(dt.getTime())) return null;
      y = dt.getFullYear();
      m = dt.getMonth() + 1;
      d = dt.getDate();
    }
    // Formato ISO solo data: 2025-11-30
    else if (/^\d{4}-\d{2}-\d{2}$/.test(s)) {
      const parts = s.split("-");
      y = parseInt(parts[0], 10);
      m = parseInt(parts[1], 10);
      d = parseInt(parts[2], 10);
    }
    // Formato europeo: 30/11/2025
    else if (s.includes("/")) {
      const parts = s.split("/");
      if (parts.length !== 3) return null;
      d = parseInt(parts[0], 10);
      m = parseInt(parts[1], 10);
      y = parseInt(parts[2], 10);
    } else {
      return null;
    }

    if (!y || !m || !d) return null;

    // Nessun offset: usiamo la data così com'è
    const fy = y;
    const fm = m;
    const fd = d;

    return {
      y: fy,
      m: fm,
      d: fd,
      ymd: String(fy).padStart(4, "0") + "-" +
           String(fm).padStart(2, "0") + "-" +
           String(fd).padStart(2, "0")
    };
  }

  races.forEach(r => {
    const raw = getRaceDateString(r);
    if (!raw) return;
    const norm = normalizeDate(raw);
    if (!norm) return;
    const key = norm.ymd;
    if (!datesMap.has(key)) {
      datesMap.set(key, { rawDates: new Set(), races: [] });
    }
    const entry = datesMap.get(key);
    entry.rawDates.add(raw);
    entry.races.push(r);
  });

  if (!datesMap.size) {
    alert("Nessuna data valida trovata nel database.");
    return;
  }

  const allKeys = Array.from(datesMap.keys());
  const parsed = allKeys.map(ymd => {
    const [y, m, d] = ymd.split("-");
    return {
      y: parseInt(y, 10) || new Date().getFullYear(),
      m: (parseInt(m, 10) || 1),
      d: (parseInt(d, 10) || 1),
      ymd
    };
  });

  let minYear = Math.min(...parsed.map(p => p.y));
  let maxYear = Math.max(...parsed.map(p => p.y));
  if (!Number.isFinite(minYear) || !Number.isFinite(maxYear)) {
    minYear = new Date().getFullYear();
    maxYear = minYear;
  }

  const last = parsed[parsed.length - 1];
  let currentYear = last.y;
  let currentMonth = last.m - 1;

  raceCalendar.innerHTML = "";

  const header = document.createElement("div");
  header.style.display = "flex";
  header.style.alignItems = "center";
  header.style.justifyContent = "space-between";
  header.style.marginBottom = "8px";

  const title = document.createElement("div");
  title.style.fontWeight = "700";
  title.style.fontSize = "14px";
  title.textContent = "Seleziona una gara";
  header.appendChild(title);

  const closeBtn = document.createElement("button");
  closeBtn.type = "button";
  closeBtn.textContent = "✕";
  closeBtn.style.border = "none";
  closeBtn.style.background = "transparent";
  closeBtn.style.cursor = "pointer";
  closeBtn.style.fontSize = "14px";
  closeBtn.style.fontWeight = "700";
  closeBtn.onclick = () => raceCalendar.style.display = "none";
  header.appendChild(closeBtn);

  raceCalendar.appendChild(header);

  const controlRow = document.createElement("div");
  controlRow.style.display = "flex";
  controlRow.style.alignItems = "center";
  controlRow.style.justifyContent = "center";
  controlRow.style.gap = "6px";
  controlRow.style.marginBottom = "8px";

  const prevBtn = document.createElement("button");
  prevBtn.type = "button";
  prevBtn.textContent = "◀";
  prevBtn.style.border = "none";
  prevBtn.style.borderRadius = "999px";
  prevBtn.style.padding = "4px 8px";
  prevBtn.style.cursor = "pointer";
  prevBtn.style.background = "#fed7aa";
  prevBtn.style.color = "#7c2d12";

  const nextBtn = document.createElement("button");
  nextBtn.type = "button";
  nextBtn.textContent = "▶";
  nextBtn.style.border = "none";
  nextBtn.style.borderRadius = "999px";
  nextBtn.style.padding = "4px 8px";
  nextBtn.style.cursor = "pointer";
  nextBtn.style.background = "#fed7aa";
  nextBtn.style.color = "#7c2d12";

  const monthLabel = document.createElement("div");
  monthLabel.style.fontWeight = "600";
  monthLabel.style.fontSize = "13px";

  controlRow.appendChild(prevBtn);
  controlRow.appendChild(monthLabel);
  controlRow.appendChild(nextBtn);

  raceCalendar.appendChild(controlRow);

  const weekRow = document.createElement("div");
  weekRow.style.display = "grid";
  weekRow.style.gridTemplateColumns = "repeat(7, 1fr)";
  weekRow.style.fontSize = "10px";
  weekRow.style.textAlign = "center";
  weekRow.style.marginBottom = "4px";
  weekRow.style.color = "#6b7280";

  const giorni = ["L","M","M","G","V","S","D"];
  giorni.forEach(g => {
    const cell = document.createElement("div");
    cell.textContent = g;
    weekRow.appendChild(cell);
  });

  raceCalendar.appendChild(weekRow);

  const grid = document.createElement("div");
  grid.style.display = "grid";
  grid.style.gridTemplateColumns = "repeat(7, 1fr)";
  grid.style.gap = "2px";
  raceCalendar.appendChild(grid);

  const mesiNomi = [
    "Gennaio","Febbraio","Marzo","Aprile","Maggio","Giugno",
    "Luglio","Agosto","Settembre","Ottobre","Novembre","Dicembre"
  ];

  function buildMonth(year, month) {
    grid.innerHTML = "";
    monthLabel.textContent = mesiNomi[month] + " " + year;

    const firstDay = new Date(year, month, 1);
    const firstWeekday = (firstDay.getDay() + 6) % 7;
    const daysInMonth = new Date(year, month + 1, 0).getDate();

    for (let i = 0; i < firstWeekday; i++) {
      const empty = document.createElement("div");
      empty.textContent = "";
      grid.appendChild(empty);
    }

    for (let day = 1; day <= daysInMonth; day++) {
      const cell = document.createElement("button");
      cell.type = "button";
      cell.textContent = String(day);
      cell.style.border = "none";
      cell.style.borderRadius = "8px";
      cell.style.padding = "4px 0";
      cell.style.fontSize = "11px";
      cell.style.cursor = "pointer";
      cell.style.minHeight = "28px";

      const mm = String(month + 1).padStart(2, "0");
      const dd = String(day).padStart(2, "0");
      const ymd = String(year).padStart(4, "0") + "-" + mm + "-" + dd;

      if (datesMap.has(ymd)) {
        const entry = datesMap.get(ymd);
        const count = entry.races.length;

        // Mark days that have races
        cell.classList.add("has-race");

        // Keep tooltip + bold; color is controlled via CSS (important) to beat glass overrides
        cell.style.fontWeight = "800";
        cell.title = formatItalianDate(ymd) + (count > 1 ? " (" + count + " gare)" : " (1 gara)");
      } else {
        cell.classList.remove("has-race");
        cell.style.background = "transparent";
        cell.style.color = "#6b7280";
        cell.style.fontWeight = "400";
      }

      cell.onclick = () => {
        if (!datesMap.has(ymd)) return;
        const entry = datesMap.get(ymd);
        const rawArr = Array.from(entry.rawDates);
        const query = rawArr[0] || ymd;
        renderPerformanceForRaceFilter(query);
        raceCalendar.style.display = "none";
      };

      grid.appendChild(cell);
    }
  }

  prevBtn.onclick = () => {
    currentMonth -= 1;
    if (currentMonth < 0) {
      currentMonth = 11;
      currentYear -= 1;
    }
    if (currentYear < minYear) {
      currentYear = minYear;
      currentMonth = 0;
    }
    buildMonth(currentYear, currentMonth);
  };

  nextBtn.onclick = () => {
    currentMonth += 1;
    if (currentMonth > 11) {
      currentMonth = 0;
      currentYear += 1;
    }
    if (currentYear > maxYear) {
      currentYear = maxYear;
      currentMonth = 11;
    }
    buildMonth(currentYear, currentMonth);
  };

  buildMonth(currentYear, currentMonth);
  raceCalendar.style.display = "block";
}

/* PERFORMANCE GRAPH SIMPLE */
function renderPerformanceGraph(races) {
  const graph = document.getElementById("performance-graph");
  if (!graph) return;
  graph.innerHTML = "";

  const avgsArr = computeWeightedAveragesByKm(races || []);
  if (!avgsArr.length) return;

  const maxVal = Math.max(...avgsArr.map(o => o.avg), 1);

  avgsArr.forEach(({ name, avg }) => {
    const bar = document.createElement("div");
    bar.style.height = (150 * avg / maxVal) + "px";
    bar.style.width = "20px";
    bar.style.background = "linear-gradient(to top, #CC0000, #F97316)";
    bar.style.borderRadius = "4px";
    bar.title = name + ": " + avg.toFixed(2);

    const label = document.createElement("div");
    label.style.textAlign = "center";
    label.style.fontSize = "10px";
    label.style.whiteSpace = "nowrap";
    label.style.overflow = "hidden";
    label.style.textOverflow = "ellipsis";
    label.style.marginTop = "4px";
    label.textContent = name;

    const container = document.createElement("div");
    container.style.display = "flex";
    container.style.flexDirection = "column";
    container.style.alignItems = "center";
    container.appendChild(bar);
    container.appendChild(label);
    graph.appendChild(container);
  });
}

/* LOAD PERFORMANCE */

/* POPUP LOADING PERFORMANCE */
function showLoadingPopup() {
  if (loadingPopupOverlay) {
    loadingPopupOverlay.style.display = "flex";
  }
}
function hideLoadingPopup() {
  if (loadingPopupOverlay) {
    loadingPopupOverlay.style.display = "none";
  }
}

async function loadPerformanceView() {
  const userId = getCurrentUserId();
  if (!userId) {
    showAuthOverlay("Effettua il login per vedere le performance.");
    return;
  }

  showView("performance");
  if (!performanceBars) return;

  // Mostra popup di loading
  showLoadingPopup();

  performanceBars.innerHTML = "";
  if (performanceEmpty) {
    performanceEmpty.textContent = "";
    performanceEmpty.style.display = "none";
  }

  try {
    const url = API_URL + "?action=getRaces&userId=" + encodeURIComponent(userId);
    const res = await fetchWithTimeout(url, { cache: "no-store" }, 8000);
    if (!res.ok) throw new Error("HTTP " + res.status);
    const txt = await res.text();
    const data = JSON.parse(txt);
    if (!data.ok) throw new Error(data.error || "Errore API getRaces");

    const racesRaw = data.races || [];

    const racesFlat = [];
    racesRaw.forEach(race => {
      const kmVal = Number(race.km) || 0;
      const elevVal = Number(race.elevation) || 0;
      (race.results || []).forEach(resBiker => {
        racesFlat.push({
          raceId: race.raceId,
          userId: race.userId,
          date: race.date,
          circuit: race.circuit,
          km: kmVal,
          elevation: elevVal,
          name: resBiker.name,
          score: Number(resBiker.score)
        });
      });
    });

    allRaces = racesFlat;
    renderPerformanceGraph(racesFlat);

    if (!racesFlat.length) {
      hideLoadingPopup();
      if (performanceEmpty) {
        performanceEmpty.textContent = "Nessuna gara registrata.";
        performanceEmpty.style.display = "block";
      }
      updatePerformanceRaceHeader(null);
      return;
    }

    renderPerformanceOverall();
    hideLoadingPopup();
  } catch (e) {
    console.error(e);
    hideLoadingPopup();
    if (performanceEmpty) {
      performanceEmpty.textContent = "Errore nel caricamento delle performance.";
      performanceEmpty.style.display = "block";
    }
    updatePerformanceRaceHeader(null);
  }
}


/* BIKERS PERFORMANCE VIEW */
function computeWeightedPerformanceByKm(racesFlat) {
  const map = new Map();
  (racesFlat || []).forEach(r => {
    const name = (r && r.name) ? String(r.name) : "";
    if (!name) return;
    const km = Number(r.km);
    const w = (Number.isFinite(km) && km > 0) ? km : 1;
    const score = Number(r.score);
    if (!Number.isFinite(score)) return;

    const prev = map.get(name) || { wSum: 0, sSum: 0 };
    prev.wSum += w;
    prev.sSum += score * w;
    map.set(name, prev);
  });

  const out = [];
  map.forEach((v, name) => {
    const avg = v.wSum > 0 ? (v.sSum / v.wSum) : 0;
    out.push({ name, avgScore: avg, totalWeight: v.wSum });
  });

  out.sort((a, b) => b.avgScore - a.avgScore);
  return out;
}

function safeFormatDate(d) {
  if (!d) return "";
  const s = String(d);
  // accetta YYYY-MM-DD e simili
  return s;
}


function getRacesForBiker(name) {
  return allRaces.filter(r => (r.name || "").toLowerCase() === (name || "").toLowerCase());
}

function formatRaceDate(d) {
  if (!d) return "";
  try {
    // d expected YYYY-MM-DD
    const parts = String(d).split("-");
    if (parts.length === 3) return parts[2] + "/" + parts[1] + "/" + parts[0];
    return String(d);
  } catch {
    return String(d || "");
  }
}

function showBpPopup(title, htmlStr) {
  // Reindirizza tutti i dettagli (icone) al popup dedicato "giallino"
  openIconPopup(title || "Dettaglio", htmlStr || "");
}

function hideBpPopup() {
  closeIconPopup();
}


function svgLineChart(points, width=360, height=160, padding=12) {
  // points: [{xLabel, y}]  (xLabel non mostrato: mostriamo solo indici 1..N sull’asse X)
  if (!Array.isArray(points) || points.length < 2) return ``;

  const ys = points.map(p => Number(p.y)).filter(Number.isFinite);
  if (ys.length < 2) return ``;

  let yMin = Math.min(...ys);
  let yMax = Math.max(...ys);
  if (yMax === yMin) yMax = yMin + 1;

  // piccolo margine verticale
  const span = (yMax - yMin) || 1;
  yMin = yMin - span * 0.08;
  yMax = yMax + span * 0.08;

  const xStep = (width - 2*padding) / (points.length - 1);

  const coords = points.map((p, i) => {
    const yVal = Number(p.y);
    const x = padding + i * xStep;
    const y = padding + (height - 2*padding) * (1 - (yVal - yMin) / (yMax - yMin));
    return {x, y, yVal};
  });

  const poly = coords.map(c => `${c.x.toFixed(1)},${c.y.toFixed(1)}`).join(" ");
  const last = coords[coords.length - 1];

  // ticks
  const yTicks = 5;
  const xCount = points.length;
  const xStepLabel = (xCount <= 8) ? 1 : Math.ceil(xCount / 6);

  const yGrid = Array.from({length:yTicks}, (_,t)=>{
    const frac = t/(yTicks-1);
    const yVal = yMax - frac*(yMax-yMin);
    const y = padding + (height - 2*padding) * frac;
    return {yVal, y};
  });

  const xGrid = [];
  for (let i=0;i<xCount;i+=xStepLabel) {
    xGrid.push({i, x: padding + i*xStep});
  }

  return `
    <svg class="bp-glass-svg" viewBox="${-46} ${-12} ${width+92} ${height+34}" width="100%" height="${height}" role="img" aria-label="Grafico andamento score">
      <defs>
        <linearGradient id="bpGrad" x1="0" x2="0" y1="0" y2="1">
          <stop offset="0%" stop-color="rgba(255,255,255,0.10)" stop-opacity="0.35"></stop>
          <stop offset="100%" stop-color="rgba(255,255,255,0.10)" stop-opacity="0"></stop>
        </linearGradient>
      </defs>

      <rect x="0" y="0" width="${width}" height="${height}" rx="14" stroke-width="1" ry="14" stroke-width="1" fill="rgba(255,255,255,0.08)" stroke="rgba(255,255,255,0.20)" stroke-width="1"></rect>

      <!-- grid horizontal + y labels -->
      ${yGrid.map(g => `
        <line x1="${padding}" y1="${g.y.toFixed(1)}" x2="${(width-padding)}" y2="${g.y.toFixed(1)}" stroke="#f1f5f9" stroke-width="1"></line>
        <text x="${(padding-18)}" y="${(g.y+2).toFixed(1)}" dy="0.35em" text-anchor="end" font-size="13" fill="#CC0000">${g.yVal.toFixed(1)}</text>
      `).join("")}

      <!-- grid vertical + x labels (1..N) -->
      ${xGrid.map(g => `
        <line x1="${g.x.toFixed(1)}" y1="${padding}" x2="${g.x.toFixed(1)}" y2="${(height-padding)}" stroke="#f1f5f9" stroke-width="1"></line>
        <text x="${g.x.toFixed(1)}" y="${(height-10)}" text-anchor="middle" font-size="12" fill="#CC0000">${g.i+1}</text>
      `).join("")}

      <!-- axes -->
      <line x1="${padding}" y1="${padding}" x2="${padding}" y2="${height-padding}" stroke="#e5e7eb"></line>
      <line x1="${padding}" y1="${height-padding}" x2="${width-padding}" y2="${height-padding}" stroke="#e5e7eb"></line>

      <!-- area -->
      <polygon points="${poly} ${width-padding},${height-padding} ${padding},${height-padding}" fill="rgba(255,255,255,0.06)"></polygon>

      <!-- line -->
      <polyline points="${poly}" fill="none" stroke="#CC0000" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"></polyline>

      <!-- points (senza numeri sopra) -->
      ${coords.map(c => `<circle cx="${c.x}" cy="${c.y}" r="4.2" fill="#111827" />`).join("")}
      <circle cx="${last.x}" cy="${last.y}" r="5.2" fill="#FDE000" stroke="#111827" stroke-width="2"></circle>
    </svg>
  `;
}


function computePlacementsForBiker(name) {
  const byRace = new Map();
  allRaces.forEach(r => {
    const key = r.raceId || (r.date + "@" + (r.circuit || ""));
    if (!byRace.has(key)) byRace.set(key, []);
    byRace.get(key).push(r);
  });

  let wins=0, seconds=0, thirds=0, top5=0, total=0;
  const positions = [];

  byRace.forEach(list => {
    // rank desc by score
    const ranked = list.slice().sort((a,b) => (Number(b.score)||0) - (Number(a.score)||0));
    const idx = ranked.findIndex(x => (x.name||"").toLowerCase() === (name||"").toLowerCase());
    if (idx < 0) return;
    const pos = idx + 1;
    total += 1;
    positions.push(pos);
    if (pos === 1) wins += 1;
    if (pos === 2) seconds += 1;
    if (pos === 3) thirds += 1;
    if (pos <= 5) top5 += 1;
  });

  return {wins, seconds, thirds, top5, total, positions};
}

let bpCurrentName = null;

function openBikerProfile(name) {
  bpCurrentName = name;

  if (bpList) bpList.style.display = "none";
  if (bpProfile) bpProfile.style.display = "block";
  const dyn = document.getElementById("bp-dynamic-title");
  if (dyn && name) dyn.textContent = name;

  // Set biker name ABOVE the icons (red + bold via CSS)
  if (bpProfileName) bpProfileName.textContent = name || "";

  // bind icon actions
  const buttons = bikersPerformanceView ? bikersPerformanceView.querySelectorAll(".bp-icon-btn") : [];
  buttons.forEach((btn) => {
    btn.onclick = () => {
      const action = btn.getAttribute("data-action");
      openBikerProfilePopup(action, bpCurrentName);
    };
  });
}


function closeBikerProfile() {
  bpCurrentName = null;
  if (bpProfile) bpProfile.style.display = "none";
  if (bpList) bpList.style.display = "flex";
}

function openBikerProfilePopup(action, name) {
  const races = getRacesForBiker(name).slice().sort((a,b) => String(a.date||"").localeCompare(String(b.date||"")));

  if (!races.length) {
    showBpPopup("Nessun dato", ``);
    return;
  }

  if (action === "trend") {
    const pts = races.map(r => ({ xLabel: formatRaceDate(r.date), y: Number(r.score) }));
    const chart = svgLineChart(pts);
    showBpPopup("Andamento score", `
      ${chart}
`);
    return;
  }

  


if (action === "avg") {
  // Storico consumi (Wh normalizzati) per gara — grafico + solo valore ultimo (Wh)
  const normConsumedByRace = races.map(r => {
    const s = Number(r.score);
    const v = (Number.isFinite(s) && s > 0) ? (1000 / s) : null;
    return Number.isFinite(v) ? v : null;
  });

  const pts = races
    .map((r, i) => ({
      xLabel: formatRaceDate(r.date),
      y: normConsumedByRace[i]
    }))
    .filter(p => Number.isFinite(p.y));

  if (!pts.length) {
    showBpPopup("Consumi (Wh)", ``);
    return;
  }

  const chart = svgLineChart(pts);
  const lastWh = pts[pts.length - 1].y;

  showBpPopup("Consumi (Wh)", `
    ${chart}
    <div style="text-align:center;margin-top:8px;font-weight:900;font-size:18px;color:#111827;">
      ${Math.round(lastWh)} Wh
    </div>
  `);
  return;
}

  
if (action === "best") {
  // Miglior gara = gara con score più alto
  const best = races.slice().sort((a,b) => (Number(b.score)||0) - (Number(a.score)||0))[0] || null;
  if (!best) {
    showBpPopup("Miglior gara", ``);
    return;
  }
  const place = (best.circuit || "").trim();
  const date = formatRaceDateForDisplay(best.date);
const km = Number(best.km);
  const elev = Number(best.elevation);

  showBpPopup("Miglior gara", `
    <div style="text-align:center;font-weight:900;font-size:18px;color:#111827;">
      ${place || "--"}
    </div>
    <div style="text-align:center;font-weight:900;font-size:16px;color:#111827;margin-top:6px;">
      ${date || "--"}
    </div>
    <div style="text-align:center;font-weight:900;font-size:16px;color:#111827;margin-top:6px;">
      ${Number.isFinite(km)?(km.toFixed(1)+" km"):"--"}
    </div>
    <div style="text-align:center;font-weight:900;font-size:16px;color:#111827;margin-top:6px;">
      ${Number.isFinite(elev)?(Math.round(elev)+" m"):"--"}
    </div>
  `);
  return;
}

  
if (action === "count") {
  const n = races.length;
  showBpPopup("Gare", `
    <div style="text-align:center;font-weight:900;font-size:42px;color:#111827;">
      ${n}
    </div>
  `);
  return;
}

  if (action === "placements") {
    const plc = computePlacementsForBiker(name);
    const podiums = plc.wins + plc.seconds + plc.thirds;

    


let bpBarMedalIdx = 0;
const bar = (label, val, max) => {
  const pct = max > 0 ? Math.round((val/max)*100) : 0;
  const medals = ["🥇","🥈","🥉"];
  const medal = medals[bpBarMedalIdx] || "";
  bpBarMedalIdx++;
  return `
    <div style="display:flex;align-items:center;gap:10px;margin-top:14px;">
      <div style="width:26px;text-align:center;font-size:22px;">${medal}</div>
      <div style="flex:1;height:24px;background:#e5e7eb;border-radius:999px;overflow:hidden;">
        <div style="height:100%;width:${pct}%;background:var(--coyote-red);display:flex;align-items:center;justify-content:flex-end;padding-right:10px;color:#fff;font-weight:900;text-shadow:0 1px 2px rgba(0,0,0,.5);">
          ${val}
        </div>
      </div>
    </div>
  `;
};




    const max = Math.max(plc.total, 1);

    showBpPopup("Piazzamenti", `

      ${bar("1° posto",plc.wins,max)}
      ${bar("2° posto",plc.seconds,max)}
      ${bar("3° posto",plc.thirds,max)}
      
    `);
    return;
  }

  showBpPopup("Dettaglio", ``);
}



// ===== BIKE PERFORMANCE: CONFRONTO MULTIPLO (selezione multipla) =====
let bpCompareMode = false;
let bpCompareSelected = []; // array of biker names (multi)

function bpEnsureCompareControls() {
  if (!bikersPerformanceView || !bpList) return;
  const existing = document.getElementById("bp-compare-controls");
  if (existing) {
    // keep controls always associated to the list container (but CSS may place them fixed)
    if (bpList.parentNode) bpList.parentNode.insertBefore(existing, bpList.nextSibling);

    // if we are in Bike performance view, always re-sync visibility & selection UI
    try { bpSyncCompareUI(); } catch(e) {}
    try { if (typeof bpSetCompareControlsVisibility === "function") bpSetCompareControlsVisibility(); } catch(e) {}
    return;
  }

  const controls = document.createElement("div");
  controls.id = "bp-compare-controls";
  controls.innerHTML = `
    <button id="bp-compare-toggle" class="bp-compare-btn" type="button" aria-label="Attiva confronto">Confronto</button>
    <button id="bp-compare-go" class="bp-compare-btn" type="button" aria-label="Confronta bikers selezionati">Confronta</button>
  `;

  // Insert BELOW the list (the CSS decides final placement; we keep DOM order stable)
  if (bpList && bpList.parentNode) {
    bpList.parentNode.insertBefore(controls, bpList.nextSibling);
  } else {
    bikersPerformanceView.appendChild(controls);
  }

  const toggle = document.getElementById("bp-compare-toggle");
  const go = document.getElementById("bp-compare-go");

  if (toggle) {
    toggle.onclick = () => {
      bpCompareMode = !bpCompareMode;
      if (!bpCompareMode) bpCompareSelected = [];
      bpSyncCompareUI();
  try { if (typeof bpSetCompareControlsVisibility === "function") bpSetCompareControlsVisibility(); } catch(e) {}

      // re-render list to clear selections + restore normal click behavior
      renderBikersPerformanceView();
    };
  }

  if (go) {
    go.onclick = () => {
      if (bpCompareSelected.length < 2) return;
      openBikersComparisonMulti(bpCompareSelected.slice());
    };
  }

  bpSyncCompareUI();
}

function bpSyncCompareUI() {
  // lock-in sound when selecting the 2nd biker in compare mode
  try{
    window.__bpPrevCompareLen = window.__bpPrevCompareLen ?? 0;
  }catch(e){}

  const toggle = document.getElementById("bp-compare-toggle");
  const go = document.getElementById("bp-compare-go");

  if (toggle) toggle.classList.toggle("active", bpCompareMode);

  if (go) {
    const enabled = (bpCompareSelected.length >= 2);
    go.classList.toggle("enabled", enabled);
  }

  
  try{
    const cur = (bpCompareSelected && bpCompareSelected.length) ? bpCompareSelected.length : 0;
    const prev = window.__bpPrevCompareLen || 0;
    if (cur >= 2 && prev < 2) playLockIn();
    window.__bpPrevCompareLen = cur;
  }catch(e){}
// update selected styles on list items
  const items = bpList ? bpList.querySelectorAll(".bp-item") : [];
  items.forEach(btn => {
    const name = btn.getAttribute("data-bp-name") || "";
    btn.classList.toggle("bp-selected", bpCompareSelected.includes(name));
  });
}

// ===== SAFE CONFRONTO MULTIPLO (Canvas) =====
function openBikersComparisonMulti(names) {
  // Safety: unique + preserve order
  const uniq = [];
  names.forEach(n => { if (n && !uniq.includes(n)) uniq.push(n); });
  if (uniq.length < 2) return;

  // Build shared timeline (union of dates) to align all lines
  const dset = new Set();
  uniq.forEach(n => {
    const races = getRacesForBiker(n);
    races.forEach(r => { if (r.date) dset.add(String(r.date)); });
  });
  const dates = Array.from(dset).sort(); // YYYY-MM-DD sort
  // X labels: 1..N (no dates shown)
  const xLabels = dates.map((_, i) => String(i + 1));

  const toMap = (races) => {
    const mp = new Map();
    races.forEach(r => {
      const k = String(r.date || "");
      const v = Number(r.score);
      if (k && Number.isFinite(v)) mp.set(k, v);
    });
    return mp;
  };

  const series = uniq.map(name => {
    const mp = toMap(getRacesForBiker(name));
    return {
      name,
      points: dates.map(d => ({ x: d, y: mp.has(d) ? mp.get(d) : null }))
    };
  });

  showBpPopup("Confronto", `
    <div style="font-weight:900;color:#111827;text-align:center;margin:2px 0 8px;">
      Performance per gara (Score) nel tempo
    </div>

    <canvas id="cmp-canvas" width="360" height="220"
      style="width:100%;background:#fff;border-radius:14px;border:1px solid #e5e7eb"></canvas>

    <div id="cmp-legend" style="display:flex;gap:14px;justify-content:center;margin-top:8px;flex-wrap:wrap;"></div>
  `);

  // Legend (color per biker)
  setTimeout(() => {
    const legend = document.getElementById("cmp-legend");
    if (!legend) return;
    const colors = bpGetComparePalette(uniq.length);
    legend.innerHTML = uniq.map((n, i) => `
      <div style="display:flex;align-items:center;gap:6px;font-weight:900;color:${colors[i]};">
        <span style="width:10px;height:10px;border-radius:999px;background:${colors[i]};display:inline-block;"></span>${n}
      </div>
    `).join("");
  }, 0);

  setTimeout(() => drawCompareChartMulti(xLabels, series), 0);
}

function bpGetComparePalette(n) {
  // High-contrast palette (repeats if needed)
  const pal = [
    "#cc0000", // red
    "#facc15", // yellow
    "#16a34a", // green
    "#2563eb", // blue
    "#a855f7", // purple
    "#f97316", // orange
    "#14b8a6", // teal
    "#e11d48", // rose
    "#0ea5e9", // sky
    "#84cc16"  // lime
  ];
  const out = [];
  for (let i = 0; i < n; i++) out.push(pal[i % pal.length]);
  return out;
}

function drawCompareChartMulti(xLabels, seriesArr) {
  const c = document.getElementById("cmp-canvas");
  if (!c) return;
  const ctx = c.getContext("2d");
  ctx.clearRect(0,0,c.width,c.height);

  const padL = 34, padR = 14, padT = 14, padB = 28;
  const w = c.width, h = c.height;

  // collect Y values
  const ys = [];
  seriesArr.forEach(s => s.points.forEach(p => { if (Number.isFinite(p.y)) ys.push(p.y); }));

  if (ys.length < 2 || xLabels.length < 2) {
    ctx.fillStyle = "#6b7280";
    ctx.font = "12px system-ui";
    ctx.textAlign = "center";
    ctx.fillText("Dati insufficienti per il confronto", w/2, h/2);
    return;
  }

  let yMin = Math.min(...ys);
  let yMax = Math.max(...ys);
  const margin = Math.max(0.5, (yMax - yMin) * 0.08);
  yMin -= margin;
  yMax += margin;

  const xCount = xLabels.length;
  const xScale = (i) => padL + (i/(xCount-1)) * (w - padL - padR);
  const yScale = (val) => padT + (1 - (val - yMin) / (yMax - yMin)) * (h - padT - padB);

  // ---- GRID + AXES (numbers only on axes) ----
  ctx.lineWidth = 1;
  ctx.strokeStyle = "#e5e7eb";

  // horizontal grid + y labels
  const yTicks = 5;
  ctx.fillStyle = "#cc0000";
  ctx.font = "11px system-ui";
  ctx.textAlign = "right";
  ctx.textBaseline = "middle";

  for (let t = 0; t < yTicks; t++) {
    const v = yMin + (t/(yTicks-1)) * (yMax - yMin);
    const yy = yScale(v);
    ctx.beginPath();
    ctx.moveTo(padL, yy);
    ctx.lineTo(w - padR, yy);
    ctx.stroke();
    ctx.fillText(v.toFixed(1), padL - 6, yy);
  }

  // vertical grid + x labels (1..N)
  ctx.textAlign = "center";
  ctx.textBaseline = "top";
  const xTicks = Math.min(6, xCount);
  for (let t = 0; t < xTicks; t++) {
    const i = Math.round((t/(xTicks-1)) * (xCount-1));
    const xx = xScale(i);
    ctx.beginPath();
    ctx.moveTo(xx, padT);
    ctx.lineTo(xx, h - padB);
    ctx.stroke();
    ctx.fillText(String(i + 1), xx, h - padB + 6);
  }

  // axes border
  ctx.strokeStyle = "#d1d5db";
  ctx.beginPath();
  ctx.rect(padL, padT, w - padL - padR, h - padT - padB);
  ctx.stroke();

  // ---- LINES ----
  const colors = bpGetComparePalette(seriesArr.length);

  seriesArr.forEach((s, si) => {
    ctx.strokeStyle = colors[si];
    ctx.lineWidth = 3;
    ctx.lineJoin = "round";
    ctx.lineCap = "round";

    let started = false;
    ctx.beginPath();
    s.points.forEach((p, i) => {
      if (!Number.isFinite(p.y)) { started = false; return; }
      const xx = xScale(i);
      const yy = yScale(p.y);
      if (!started) { ctx.moveTo(xx, yy); started = true; }
      else { ctx.lineTo(xx, yy); }
    });
    ctx.stroke();

    // points
    ctx.fillStyle = colors[si];
    s.points.forEach((p, i) => {
      if (!Number.isFinite(p.y)) return;
      const xx = xScale(i), yy = yScale(p.y);
      ctx.beginPath();
      ctx.arc(xx, yy, 4, 0, Math.PI*2);
      ctx.fill();
    });
  });
}
// ===== FINE CONFRONTO =====

function renderBikersPerformanceView() {
  if (!bpList) return;
  bpEnsureCompareControls();

  // Reset profile panel
  if (bpProfile) bpProfile.style.display = "none";
  if (bpList) bpList.style.display = "flex";

  bpList.innerHTML = "";

  const ranking = computeWeightedPerformanceByKm(allRaces);

  if (!ranking.length) {
    const empty = document.createElement("div");
    empty.className = "bp-empty";
    empty.textContent = "Nessuna gara registrata.";
    bpList.appendChild(empty);
    return;
  }

  ranking.forEach((r, idx) => {
    const btn = document.createElement("button");
    btn.type = "button";
    btn.className = "bp-item";
    btn.innerHTML = `
      <div style="display:flex;flex-direction:column;gap:2px;min-width:0;flex:1;">
        <div class="bp-name">${idx + 1}. ${r.name}</div>
        <div style="font-size:11px;color:#6b7280;">Media pesata</div>
      </div>
      <div class="bp-score">${Number.isFinite(r.avgScore) ? r.avgScore.toFixed(2) : "--"}</div>
    `;
    btn.setAttribute("data-bp-name", r.name);
    btn.onclick = () => {
      if (bpCompareMode) {
        const n = r.name;
        const i = bpCompareSelected.indexOf(n);
        if (i >= 0) {
          bpCompareSelected.splice(i, 1);
        } else {
          bpCompareSelected.push(n);
        }
        bpSyncCompareUI();
        return;
      }
      openBikerProfile(r.name);
    };
    bpList.appendChild(btn);
  });
}

async function openBikersPerformanceFromPerformance() {
  // Se non ho ancora dati gara, provo a caricare
  if (!allRaces || allRaces.length === 0) {
    await loadPerformanceView(); // carica allRaces e torna su performance
  }
  renderBikersPerformanceView();
  showView("bikersPerformance");
}

/* END BIKERS PERFORMANCE VIEW */

/* TEST VIEW */
function initTestView() {
  if (!testRankingList) return;
  testRankingList.innerHTML = "";

  const li = document.createElement("li");
  li.innerHTML = `
    <div class="result-left">
      <div class="battery-row">
        <div class="battery">
          <div class="battery-level" style="width:0%; background:#9ca3af;"></div>
          <span class="battery-percent-label">--%</span>
        </div>
      </div>
      
      </div>
    </div>
    <div class="result-right">
      <div class="right-topline">
        <span class="medal">🏁</span>
        <span class="result-score">0.0</span>
      </div>
    </div>
  `;
  testRankingList.appendChild(li);

  if (testBatteryInput) testBatteryInput.value = "";
  if (testWeightInput) testWeightInput.value = "";
  if (testPercentInput) testPercentInput.value = "";

  testTabs.forEach(tab => tab.classList.remove("active"));
  testTabContents.forEach(c => c.classList.remove("active"));
  const firstTab = document.querySelector('.test-tab[data-tab="wh"]');
  const firstContent = document.querySelector('.test-tab-content[data-tab="wh"]');
  if (firstTab) firstTab.classList.add("active");
  if (firstContent) firstContent.classList.add("active");
}

testTabs.forEach(tab => {
  tab.addEventListener("click", () => {
    const target = tab.getAttribute("data-tab");
    testTabs.forEach(t => t.classList.remove("active"));
    testTabContents.forEach(c => c.classList.remove("active"));
    tab.classList.add("active");
    const contentEl = document.querySelector('.test-tab-content[data-tab="' + target + '"]');
    if (contentEl) contentEl.classList.add("active");
  });
});

function calculateTest() {
  if (!testRankingList) return;

  const battery = parseFloat(testBatteryInput.value);
  const riderWeight = parseFloat(testWeightInput.value);
  const bikeWeight = parseFloat(testBikeWeightInput.value);
  let percent = parseFloat(testPercentInput.value);

  if (!Number.isFinite(battery) || battery <= 0 ||
      !Number.isFinite(riderWeight)  || riderWeight  <= 0 ||
      !Number.isFinite(bikeWeight)   || bikeWeight   <= 0 ||
      !Number.isFinite(percent)) {
    alert("Inserisci Wh, peso biker, peso bici e % residua validi per il biker di test.");
    return;
  }

  const totalWeight = riderWeight + bikeWeight;

  if (percent < 0) percent = 0;
  if (percent > 100) percent = 100;

  const calc = computeCoyoteScore(battery, totalWeight, percent);
  if (!calc) {
    alert("Errore nel calcolo (dati non validi).");
    return;
  }

  const consumedWh = calc.consumedWh;
  const efficiencyWhPerKg = calc.efficiencyWhPerKg;
  const score = calc.score;
  percent = calc.percent;

  // Costruiamo la card di test come una "finta" prima posizione
  testRankingList.innerHTML = "";
  const li = document.createElement("li");
  li.innerHTML = `
    <div class="result-left">
      <div class="result-topline"></div>
      <div class="battery-row">
        <div class="battery">
          <div class="battery-level"></div>
          <div class="battery-percent-label"></div>
        </div>
        <span class="scenario-badge" id="test-scenario-display"></span>
      </div>
    </div>
    <div class="result-right">
      <div class="right-topline">
        <span class="medal">🏁</span>
        <span class="result-score">--</span>
      </div>
    </div>
  `;
  testRankingList.appendChild(li);

  const levelElem = li.querySelector(".battery-level");
  const percentLabel = li.querySelector(".battery-percent-label");
  const scoreElem = li.querySelector(".result-score");
  const medalElem = li.querySelector(".medal");

  if (percentLabel) percentLabel.textContent = Math.round(percent) + "%";
  if (scoreElem) scoreElem.textContent = score.toFixed(2);
  if (medalElem) medalElem.textContent = "🏁";

  // Update external pills: batteria, peso ciclista, percentuale
  const outWh = document.getElementById("pill-out-wh");
  const outKg = document.getElementById("pill-out-kg");
const outBikeKg = document.getElementById("pill-out-bikekg");
  const outP = document.getElementById("pill-out-percent");
  if (outWh && Number.isFinite(battery)) outWh.textContent = battery.toFixed(0) + " Wh";
  if (outKg && Number.isFinite(riderWeight)) outKg.textContent = riderWeight.toFixed(1) + " kg";
outBikeKg.textContent = bikeWeight.toFixed(1) + " kg";
  if (outP && Number.isFinite(percent)) outP.textContent = Math.round(percent) + " %";

  if (levelElem) {
    levelElem.style.background = batteryColorForPercent(percent);
    requestAnimationFrame(() => {
      levelElem.style.width = (Math.round(percent / 4) * 4) + "%";
    });
  }

  const scenarioSpan = document.getElementById("test-scenario-display");
  if (scenarioSpan && Number.isFinite(consumedWh) && efficiencyWhPerKg > 0) {
    const eff = efficiencyWhPerKg.toFixed(1);
    scenarioSpan.textContent = eff + " Wh/kg";
  }
}

if (testCalcBtn) testCalcBtn.onclick = calculateTest;
if (testResetBtn) testResetBtn.onclick = () => initTestView();

/* PERFORMANCE BUTTONS */
if (performanceOverallBtn) performanceOverallBtn.onclick = () => {
  showLoadingPopup();
  setTimeout(() => {
    renderPerformanceOverall();
    hideLoadingPopup();
  }, 50);
};
if (performanceRaceBtn) performanceRaceBtn.onclick = () => openRaceCalendar();
if (performanceBikersBtn) performanceBikersBtn.onclick = () => openBikersPerformanceFromPerformance();
document.addEventListener("keydown", (e) => {
  if (e.key === "Escape") hideBpPopup();
});





/* SERVICE WORKER (update aggressivo + reload) */
if ("serviceWorker" in navigator) {
  window.addEventListener("load", async () => {
    try {
      const reg = await navigator.serviceWorker.register("service-worker.js?v=4.120.0");
      if (reg && reg.update) reg.update().catch(() => {});
      reg.addEventListener("updatefound", () => {
        const nw = reg.installing;
        if (!nw) return;
        nw.addEventListener("statechange", () => {
          if (nw.state === "installed" && navigator.serviceWorker.controller) {
            window.location.reload();
          }
        });
      });
      navigator.serviceWorker.addEventListener("controllerchange", () => {
        window.location.reload();
      });
    } catch (err) {
      console.log("Service Worker registration failed:", err);
    }
  });
}

/* RESET/CANCELLA PERFORMANCE DB */
async function handleResetPerformanceClick() {
  const userId = getCurrentUserId();
  if (!userId) {
    showAuthOverlay("Effettua il login per modificare il database performance.");
    return;
  }

  // Caso: cancellazione singola gara (modalità "race")
  if (performanceMode === "race" && currentRaceSample && currentRaceSample.raceId) {
    const conferma = confirm("Vuoi cancellare DEFINITIVAMENTE questa gara dal database PERFORMANCE?");
    if (!conferma) return;

    const okPwd = await requireAccountPasswordConfirm("Per cancellare questa gara, inserisci la password dell’account:");
    if (!okPwd) return;

    try {
      await fetch(API_URL, {
        method: "POST",
        mode: "no-cors",
        headers: {"Content-Type":"text/plain"},
        body: JSON.stringify({
          action: "deleteRace",
          userId,
          raceId: currentRaceSample.raceId,
          adminPassword: "Coyote"
        })
      });
      alert("Gara cancellata dal nuovo database (controlla il foglio Google).");
      await loadPerformanceView();
    } catch (e) {
      console.error(e);
      alert("Errore nella cancellazione della gara.");
    }
    return;
  }

  // Caso: reset totale performance per questo utente (modalità "overall")
  const confermaReset = confirm("Vuoi resettare il database PERFORMANCE per questo utente? (Cancella tutti i dati performance)");
  if (!confermaReset) return;

  const okPwd = await requireAccountPasswordConfirm("Per resettare tutte le gare, inserisci la password dell’account:");
  if (!okPwd) return;

  try {
    await fetch(API_URL, {
      method: "POST",
      mode: "no-cors",
      headers: {"Content-Type":"text/plain"},
      body: JSON.stringify({
        action: "resetPerformance",
        userId,
        adminPassword: "Coyote"
      })
    });
    alert("Nuovo database resettato per questo utente.");
    await loadPerformanceView();
  } catch (e) {
    console.error(e);
    alert("Errore nel reset del database performance.");
  }
}

/* Binding robusto (funziona anche se la view viene ricreata) */
document.addEventListener("click", (e) => {
  const btn = e.target && e.target.closest ? e.target.closest("#reset-performance-btn") : null;
  if (btn) handleResetPerformanceClick();
});
async function init() {
  updateAccountBadge();
  updateRaceDateDisplay();

  const userId = getCurrentUserId();

  if (!userId) {
    showAuthOverlay();
    showView("home");
  } else {
    // Mostra subito la Home (non bloccare il primo paint su iOS).
    showView("home");
    // Carica dati account in background (usa cache locale se presente).
    try { ensureAccountDataLoaded(); } catch (e) {}
  }

  clearInterval(loadingInterval);
  const loadingScreen = document.getElementById("loading-screen");
  if (loadingScreen) loadingScreen.style.display = "none";
  const container = document.querySelector(".container");
  if (container) container.style.opacity = "1";
}

init();

function openIconPopup(title, contentHtml) {
  document.getElementById("icon-popup-title").textContent = title;
  document.getElementById("icon-popup-content").innerHTML = contentHtml;
  document.getElementById("icon-popup-overlay").classList.remove("hidden");
}

function closeIconPopup() {
  document.getElementById("icon-popup-overlay").classList.add("hidden");
}


// Close icon popup when clicking outside the card
(function(){
  const overlayEl = document.getElementById("icon-popup-overlay");
  if (!overlayEl) return;
  overlayEl.addEventListener("click", (e) => {
    if (e.target === overlayEl) closeIconPopup();
  });
})();


// HOME – Logout button (apre popup account)
// (dedupe) homeLogoutBtn already declared above
// (dedupe) homeAccountPill already declared above
function doLogoutNow() {
  // prefer funzione già esistente
  if (typeof clearCurrentUser === "function") {
    clearCurrentUser();
    showAuthOverlay();
    return;
  }
  localStorage.removeItem(USER_ID_STORAGE_KEY);
  localStorage.removeItem(USERNAME_STORAGE_KEY);
  showAuthOverlay();
}

function openAccountPopup() {
  const ov = document.getElementById("account-overlay");
  const panel = document.getElementById("change-password-panel");
  const msg = document.getElementById("account-msg");
  if (!ov) return;

  // bind HOME buttons to open this popup (override eventuali handler precedenti)
  const homeLogoutBtnEl = document.getElementById("home-logout-btn");
  const homeAccountPillEl = document.getElementById("home-account-pill");
  if (homeLogoutBtnEl) homeLogoutBtnEl.onclick = openAccountPopup;
  if (homeAccountPillEl) homeAccountPillEl.onclick = openAccountPopup;
  ov.style.display = "flex";
  ov.setAttribute("aria-hidden", "false");
  if (panel) panel.style.display = "none";
  if (msg) msg.textContent = "";
  const oldI = document.getElementById("cp-old");
  const newI = document.getElementById("cp-new");
  const new2I = document.getElementById("cp-new2");
  if (oldI) oldI.value = "";
  if (newI) newI.value = "";
  if (new2I) new2I.value = "";
}

function closeAccountPopup() {
  const ov = document.getElementById("account-overlay");
  if (!ov) return;

  // bind HOME buttons to open this popup (override eventuali handler precedenti)
  const homeLogoutBtnEl = document.getElementById("home-logout-btn");
  const homeAccountPillEl = document.getElementById("home-account-pill");
  if (homeLogoutBtnEl) homeLogoutBtnEl.onclick = openAccountPopup;
  if (homeAccountPillEl) homeAccountPillEl.onclick = openAccountPopup;
  ov.style.display = "none";
  ov.setAttribute("aria-hidden", "true");
}


// Popup account handlers
(function initAccountPopup(){
  const ov = document.getElementById("account-overlay");
  if (!ov) return;

  // bind HOME buttons to open this popup (override eventuali handler precedenti)
  const homeLogoutBtnEl = document.getElementById("home-logout-btn");
  const homeAccountPillEl = document.getElementById("home-account-pill");
  if (homeLogoutBtnEl) homeLogoutBtnEl.onclick = openAccountPopup;
  if (homeAccountPillEl) homeAccountPillEl.onclick = openAccountPopup;

  const closeBtn = document.getElementById("account-close-btn");
  const logoutBtn = document.getElementById("account-logout-btn");
  const toggleBtn = document.getElementById("account-change-password-btn");
  const panel = document.getElementById("change-password-panel");
  const saveBtn = document.getElementById("account-save-password-btn");
  const msg = document.getElementById("account-msg");
  const deleteBtn = document.getElementById("account-future-btn");

  function setMsg(t, isError){
    if (!msg) return;
    msg.textContent = t || "";
    msg.style.color = isError ? "#b00020" : "#0b5";
    if (!t) msg.style.color = "";
  }

  if (closeBtn) closeBtn.onclick = closeAccountPopup;

  // click fuori chiude
  ov.addEventListener("click", (e) => {
    if (e.target === ov) closeAccountPopup();
  });

  // ESC chiude
  document.addEventListener("keydown", (e) => {
    if (e.key === "Escape" && ov.style.display === "flex") closeAccountPopup();
  });

  if (logoutBtn) logoutBtn.onclick = () => {
    closeAccountPopup();
    doLogoutNow();
  };

  if (toggleBtn) toggleBtn.onclick = () => {
    if (!panel) return;
    const willShow = panel.style.display === "none" || panel.style.display === "";
    panel.style.display = willShow ? "block" : "none";
    if (willShow) {
      const oldI = document.getElementById("cp-old");
      if (oldI) oldI.focus();
    }
  };

  async function handleSavePassword(){
    const userId = localStorage.getItem(USER_ID_STORAGE_KEY);
    if (!userId) { setMsg("Nessun utente attivo.", true); return; }

    const oldPw = (document.getElementById("cp-old") || {}).value || "";
    const newPw = (document.getElementById("cp-new") || {}).value || "";
    const newPw2 = (document.getElementById("cp-new2") || {}).value || "";

    if (newPw !== newPw2) { setMsg("Le nuove password non coincidono.", true); return; }

    setMsg("", false);

    try {
      const res = await fetch(API_URL, {
        method: "POST",
        headers: { "Content-Type": "text/plain" },
        body: JSON.stringify({
          action: "changePassword",
          userId,
          oldPassword: oldPw,
          newPassword: newPw
        })
      });

      const data = await res.json().catch(() => null);
      if (data && data.ok) {
        setMsg("Password aggiornata.", false);
        try{ playSuccess(); }catch(e){}
        setTimeout(() => closeAccountPopup(), 700);
        return;
      }

      const errMsg = (data && data.error) ? String(data.error) : "Cambio password non riuscito.";
      try{ playError(); }catch(e){}
      setMsg(errMsg, true);
} catch (e) {
      console.error(e);
      setMsg("Errore di rete.", true);
    }
  }


  async function handleDeleteAccount(){
    const userId = localStorage.getItem(USER_ID_STORAGE_KEY);
    const username = getCurrentUsername();
    if (!userId) { setMsg("Nessun utente attivo.", true); return; }

    const label = username ? ("@" + username) : userId;

    const ok = confirm("ATTENZIONE: vuoi eliminare definitivamente l'account " + label + "?\n\nVerranno cancellati anche bikers e gare.");
    if (!ok) return;

    const pwd = prompt("Inserisci la password dell’account per confermare l’eliminazione:");
    if (pwd === null) return;

    setMsg("", false);

    try {
      // Verifica password (login)
      const checkRes = await fetch(API_URL, {
        method: "POST",
        headers: { "Content-Type": "text/plain" },
        body: JSON.stringify({ action: "login", username, password: pwd })
      });
      const check = await checkRes.json().catch(() => null);
      if (!(check && check.ok)) {
        setMsg("Password errata.", true);
        return;
      }

      setMsg("", false);

      const res = await fetch(API_URL, {
        method: "POST",
        headers: { "Content-Type": "text/plain" },
        body: JSON.stringify({
          action: "deleteAccount",
          userId,
          password: pwd
        })
      });

      const data = await res.json().catch(() => null);
      if (data && data.ok) {
        setMsg("Account eliminato.", false);
        if (typeof clearCurrentUser === "function") clearCurrentUser();
        else {
          localStorage.removeItem(USER_ID_STORAGE_KEY);
          localStorage.removeItem(USERNAME_STORAGE_KEY);
        }
        setTimeout(() => {
          closeAccountPopup();
          showAuthOverlay();
          alert("Account eliminato.");
        }, 400);
        return;
      }

      const errMsg = (data && data.error) ? String(data.error) : "Eliminazione non riuscita.";
      try{ playError(); }catch(e){}
      setMsg(errMsg, true);
    } catch (e) {
      console.error(e);
      setMsg("Errore di rete.", true);
    }
  }


  if (saveBtn) saveBtn.onclick = handleSavePassword;
  if (deleteBtn) deleteBtn.onclick = handleDeleteAccount;
})();

// ===== SAFE CONFRONTO (Canvas) =====
function openBikersComparison(nameA, nameB) {
  const aRaces = getRacesForBiker(nameA);
  const bRaces = getRacesForBiker(nameB);

  // Build shared timeline (union of dates) to align the two lines
  const dset = new Set();
  aRaces.forEach(r => { if (r.date) dset.add(String(r.date)); });
  bRaces.forEach(r => { if (r.date) dset.add(String(r.date)); });
  const dates = Array.from(dset).sort(); // YYYY-MM-DD sort

  const toMap = (races) => {
    const mp = new Map();
    races.forEach(r => {
      const k = String(r.date || "");
      const v = Number(r.score);
      if (k && Number.isFinite(v)) mp.set(k, v);
    });
    return mp;
  };

  const mapA = toMap(aRaces);
  const mapB = toMap(bRaces);

  const seriesA = dates.map(d => ({ d, y: mapA.has(d) ? mapA.get(d) : null }));
  const seriesB = dates.map(d => ({ d, y: mapB.has(d) ? mapB.get(d) : null }));

  showBpPopup("Confronto", `
    <div style="font-weight:900;color:#111827;text-align:center;margin:2px 0 8px;">
      Performance per gara (Score) nel tempo
    </div>
    <canvas id="cmp-canvas" width="360" height="220"
      style="width:100%;background:#fff;border-radius:14px;border:1px solid #e5e7eb"></canvas>

    <div style="display:flex;gap:14px;justify-content:center;margin-top:8px;flex-wrap:wrap;">
      <div style="display:flex;align-items:center;gap:6px;font-weight:900;color:#cc0000;">
        <span style="width:10px;height:10px;border-radius:999px;background:#cc0000;display:inline-block;"></span>${nameA}
      </div>
      <div style="display:flex;align-items:center;gap:6px;font-weight:900;color:#facc15;">
        <span style="width:10px;height:10px;border-radius:999px;background:#facc15;display:inline-block;"></span>${nameB}
      </div>
    </div>
    
  `);

  setTimeout(() => drawCompareChart(dates, seriesA, seriesB), 0);
}

function drawCompareChart(dates, seriesA, seriesB) {
  const c = document.getElementById("cmp-canvas");
  if (!c) return;
  const ctx = c.getContext("2d");
  ctx.clearRect(0,0,c.width,c.height);

  const padL = 34, padR = 14, padT = 18, padB = 34;
  const w = c.width, h = c.height;

  const ys = [];
  seriesA.forEach(p => { if (Number.isFinite(p.y)) ys.push(p.y); });
  seriesB.forEach(p => { if (Number.isFinite(p.y)) ys.push(p.y); });

  if (ys.length < 2 || dates.length < 2) {
    ctx.fillStyle = "#6b7280";
    ctx.font = "12px system-ui";
    ctx.textAlign = "center";
    ctx.fillText("Dati insufficienti per il confronto", w/2, h/2);
    return;
  }

  let minY = Math.min(...ys);
  let maxY = Math.max(...ys);
  const span = (maxY - minY) || 1;
  // add a bit of vertical padding
  minY = minY - span * 0.08;
  maxY = maxY + span * 0.08;

  const mapX = (i) => padL + i * ((w - padL - padR) / (dates.length - 1));
  const mapY = (y) => padT + (h - padT - padB) * (1 - (y - minY) / (maxY - minY));

  // axes
  ctx.strokeStyle = "#e5e7eb";
  ctx.lineWidth = 1;
  ctx.beginPath();
  ctx.moveTo(padL, padT);
  ctx.lineTo(padL, h - padB);
  ctx.lineTo(w - padR, h - padB);
  ctx.stroke();
  
  // grid + ticks (only numbers on axes)
  const yTicks = 5;
  ctx.font = "11px system-ui";
  ctx.fillStyle = "#6b7280";
  ctx.textAlign = "right";
  for (let t = 0; t < yTicks; t++) {
    const frac = t / (yTicks - 1);
    const yVal = maxY - frac * (maxY - minY);
    const y = mapY(yVal);
    // horizontal grid
    ctx.strokeStyle = "#f1f5f9";
    ctx.lineWidth = 1;
    ctx.beginPath();
    ctx.moveTo(padL, y);
    ctx.lineTo(w - padR, y);
    ctx.stroke();
    // y label
    ctx.fillText(yVal.toFixed(1), padL - 6, y + 4);
  }

  // X axis: use race index 1..N (dates hidden)
  const xCount = dates.length;
  const xStepLabel = (xCount <= 8) ? 1 : Math.ceil(xCount / 6);
  ctx.textAlign = "center";
  for (let i = 0; i < xCount; i += xStepLabel) {
    const x = mapX(i);
    // vertical grid
    ctx.strokeStyle = "#f1f5f9";
    ctx.lineWidth = 1;
    ctx.beginPath();
    ctx.moveTo(x, padT);
    ctx.lineTo(x, h - padB);
    ctx.stroke();
    // x label
    ctx.fillStyle = "#6b7280";
    ctx.fillText(String(i + 1), x, h - 10);
  }
function drawLine(series, color) {
    ctx.strokeStyle = color;
    ctx.lineWidth = 3;
    ctx.beginPath();
    let started = false;

    series.forEach((p, i) => {
      if (!Number.isFinite(p.y)) { started = false; return; }
      const x = mapX(i);
      const y = mapY(p.y);
      if (!started) { ctx.moveTo(x, y); started = true; }
      else ctx.lineTo(x, y);
    });
    ctx.stroke();

    // points + numeric labels
    series.forEach((p, i) => {
      if (!Number.isFinite(p.y)) return;
      const x = mapX(i);
      const y = mapY(p.y);
      ctx.fillStyle = color;
      ctx.beginPath();
      ctx.arc(x, y, 4, 0, Math.PI*2);
      ctx.fill();
});
  }

  drawLine(seriesA, "#cc0000");
  drawLine(seriesB, "#facc15");
}
// ===== FINE SAFE CONFRONTO =====



// Compare controls visibility: show only in Bike performance view
function bpSetCompareControlsVisibility() {
  const controls = document.getElementById("bp-compare-controls");
  if (!controls) return;

  const inBikePerfView = !!(bikersPerformanceView && bikersPerformanceView.style.display !== "none");
  const listVisible = !!(bpList && bpList.style.display !== "none");
  const profileVisible = !!(bpProfile && bpProfile.style.display !== "none");

  // Show only when Bike performance view is active AND the list is visible (not inside a single profile)
  const shouldShow = inBikePerfView && listVisible && !profileVisible;

  controls.style.display = shouldShow ? "flex" : "none";
}
// call once after view switches
if (!window.__bpShowViewPatched) {
  window.__bpShowViewPatched = true;
  
}



// Strong guard: hide compare controls inside single biker profile
(function(){
  const _origOpenBikerProfile = openBikerProfile;
  openBikerProfile = function(name){
    const controls = document.getElementById("bp-compare-controls");
    if (controls) controls.style.display = "none";
    return _origOpenBikerProfile(name);
  };
})();


// Restore numeric values on placement tabs
(function(){
  function restorePlacementNumbers(){
    document.querySelectorAll(".bp-placement-row").forEach(row=>{
      if(row.querySelector(".bp-placement-value")) return;
      const v = row.getAttribute("data-value");
      if(v !== null){
        const s = document.createElement("span");
        s.className = "bp-placement-value";
        s.textContent = v;
        row.appendChild(s);
      }
    });
  }
  document.addEventListener("DOMContentLoaded", restorePlacementNumbers);
  setTimeout(restorePlacementNumbers, 300);
})();


// Show biker rank position under the red button (single biker screen)
(function(){
  if (typeof openBikerProfile !== "function") return;
  const _origOpen = openBikerProfile;
  openBikerProfile = function(name){
    const res = _origOpen(name);
    try{
      const el = document.getElementById("bp-rank-pos");
      if (!el) return res;
      // ranking used in Bike performance list
      const ranking = computeWeightedPerformanceByKm(allRaces) || [];
      const idx = ranking.findIndex(r => (r.name||"") === name);
      if (idx >= 0){
        el.textContent = `${idx+1}`;
      } else {
        el.textContent = "";
      }
    }catch(e){}
    return res;
  };
})();

</script>


<script>
/* Fallback binding for Home -> Bike performance (guarded)
   NOTE: the main handler is defined earlier. This fallback must NOT run when that exists,
   otherwise the view can be shown without rendering controls (e.g., compare buttons). */
(function () {
  const btn = document.getElementById("home-btn-bike-performance");
  if (!btn) return;

  // If the main handler exists, do nothing.
  if (typeof btn.onclick === "function") return;

  btn.addEventListener("click", async () => {
    // Minimal safe fallback: use official view switch + render
    try {
      if (typeof showBikersLoading === "function") showBikersLoading();
      if (typeof loadPerformanceView === "function") await loadPerformanceView();
      if (typeof renderBikersPerformanceView === "function") renderBikersPerformanceView();
      if (typeof showView === "function") showView("bikersPerformance");
      const bpList = document.getElementById("bp-list");
      const bpProfile = document.getElementById("bp-profile");
      if (bpList) bpList.style.display = "flex";
      if (bpProfile) bpProfile.style.display = "none";
      if (typeof hideBpPopup === "function") hideBpPopup();
    } finally {
      if (typeof hideBikersLoading === "function") hideBikersLoading();
    }
  });
})();

function openIconPopup(title, contentHtml) {
  document.getElementById("icon-popup-title").textContent = title;
  document.getElementById("icon-popup-content").innerHTML = contentHtml;
  document.getElementById("icon-popup-overlay").classList.remove("hidden");
}

function closeIconPopup() {
  document.getElementById("icon-popup-overlay").classList.add("hidden");
}


// Close icon popup when clicking outside the card
(function(){
  const overlayEl = document.getElementById("icon-popup-overlay");
  if (!overlayEl) return;
  overlayEl.addEventListener("click", (e) => {
    if (e.target === overlayEl) closeIconPopup();
  });
})();


// HOME – Logout button (apre popup account)
function doLogoutNow(){
  // prefer funzione già esistente
  if (typeof clearCurrentUser === "function") {
    clearCurrentUser();
    showAuthOverlay();
    return;
  }
  try {
    localStorage.removeItem(USER_ID_STORAGE_KEY);
    localStorage.removeItem(USERNAME_STORAGE_KEY);
  } catch(e){}
  showAuthOverlay();
}
// ===== SAFE CONFRONTO (Canvas) =====
function openBikersComparison(nameA, nameB) {
  const aRaces = getRacesForBiker(nameA);
  const bRaces = getRacesForBiker(nameB);

  const getSeries = (races) => races.map(r => ({ x: r.date, y: r.score })).filter(p => p.x && Number.isFinite(p.y));

  const seriesA = getSeries(aRaces);
  const seriesB = getSeries(bRaces);

  showBpPopup("Confronto", `
    <canvas id="cmp-canvas" width="360" height="200" style="width:100%;background:#fff;border-radius:14px;border:1px solid #e5e7eb"></canvas>
    <div style="display:flex;gap:10px;justify-content:center;margin-top:8px;">
      <div style="font-weight:900;color:#cc0000;">● ${nameA}</div>
      <div style="font-weight:900;color:#facc15;">● ${nameB}</div>
    </div>
  `);

  setTimeout(() => drawCompareChart(seriesA, seriesB), 0);
}

function drawCompareChart(a, b) {
  const c = document.getElementById("cmp-canvas");
  if (!c) return;
  const ctx = c.getContext("2d");
  ctx.clearRect(0,0,c.width,c.height);

  const pad = 20;
  const all = a.concat(b);
  if (all.length < 2) return;

  const ys = all.map(p => p.y);
  const minY = Math.min(...ys);
  const maxY = Math.max(...ys) + 1;

  const drawLine = (data, color) => {
    ctx.strokeStyle = color;
    ctx.lineWidth = 3;
    ctx.beginPath();
    data.forEach((p,i)=>{
      const x = pad + i*( (c.width-2*pad)/(data.length-1) );
      const y = pad + (c.height-2*pad)*(1-(p.y-minY)/(maxY-minY));
      if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
    });
    ctx.stroke();
  };

  drawLine(a, "#cc0000");
  drawLine(b, "#facc15");
}
// ===== FINE SAFE CONFRONTO =====


// Compare controls visibility: show only in Bike performance view
function bpSetCompareControlsVisibility() {
  const controls = document.getElementById("bp-compare-controls");
  if (!controls) return;

  const inBikePerfView = !!(bikersPerformanceView && bikersPerformanceView.style.display !== "none");
  const listVisible = !!(bpList && bpList.style.display !== "none");
  const profileVisible = !!(bpProfile && bpProfile.style.display !== "none");

  // Show only when Bike performance view is active AND the list is visible (not inside a single profile)
  const shouldShow = inBikePerfView && listVisible && !profileVisible;

  controls.style.display = shouldShow ? "flex" : "none";
}
// call once after view switches



// Strong guard: hide compare controls inside single biker profile
(function(){
  const _origOpenBikerProfile = openBikerProfile;
  openBikerProfile = function(name){
    const controls = document.getElementById("bp-compare-controls");
    if (controls) controls.style.display = "none";
    return _origOpenBikerProfile(name);
  };
})();


// Restore numeric values on placement tabs
(function(){
  function restorePlacementNumbers(){
    document.querySelectorAll(".bp-placement-row").forEach(row=>{
      if(row.querySelector(".bp-placement-value")) return;
      const v = row.getAttribute("data-value");
      if(v !== null){
        const s = document.createElement("span");
        s.className = "bp-placement-value";
        s.textContent = v;
        row.appendChild(s);
      }
    });
  }
  document.addEventListener("DOMContentLoaded", restorePlacementNumbers);
  setTimeout(restorePlacementNumbers, 300);
})();


// Show biker rank position under the red button (single biker screen)
(function(){
  if (typeof openBikerProfile !== "function") return;
  const _origOpen = openBikerProfile;
  openBikerProfile = function(name){
    const res = _origOpen(name);
    try{
      const el = document.getElementById("bp-rank-pos");
      if (!el) return res;
      // ranking used in Bike performance list
      const ranking = computeWeightedPerformanceByKm(allRaces) || [];
      const idx = ranking.findIndex(r => (r.name||"") === name);
      if (idx >= 0){
        el.textContent = `${idx+1}`;
      } else {
        el.textContent = "";
      }
    }catch(e){}
    return res;
  };
})();

</script>


<!-- Icon Popup Overlay -->
<div id="icon-popup-overlay" class="icon-popup-overlay hidden">
  <div class="icon-popup">
    <div class="icon-popup-header">
      <h3 id="icon-popup-title"></h3>
      <button class="icon-popup-close" onclick="closeIconPopup()">✕</button>
    </div>
    <div id="icon-popup-content" class="icon-popup-content"></div>
  </div>
</div>


<style id="build-4.116-pill-liquid-glass">
/* ===== BUILD 4.120 – UNIFICA TASTI A PILLOLA (Liquid Glass, tinta unita) =====
   Obiettivo: niente gradienti/shine interni. Un solo linguaggio: Liquid Glass.
*/
:root{
  --lg-pill-blur: 16px;
  --lg-pill-sat: 160%;
  --lg-pill-border: rgba(255,255,255,0.22);
  --lg-pill-shadow: 0 10px 24px rgba(0,0,0,0.34);
  --lg-pill-bg-rgb: 255,255,255;     /* default "vetro" */
  --lg-pill-bg-a: 0.14;
}

/* Target "pillole" principali (bottoni + pill class) */
button.btn,
.btn,
.home-btn,
#home-logout-btn,
#home-account-pill,
#account-pill, .account-pill,
.bp-return-btn,
.bp-compare-btn,
#bp-compare-toggle,
#bp-compare-go,
.test-data-pill,
.race-pill,
#performance-race-header .race-pill,
#race-calendar button,
.tsb-toggle-btn{
  /* Tinta unita: niente gradienti */
  background-image: none !important;
  -webkit-appearance: none;
  appearance: none;

  /* Liquid Glass */
  background-color: rgba(var(--lg-pill-bg-rgb), var(--lg-pill-bg-a)) !important;
  -webkit-backdrop-filter: blur(var(--lg-pill-blur)) saturate(var(--lg-pill-sat));
  backdrop-filter: blur(var(--lg-pill-blur)) saturate(var(--lg-pill-sat));

  border: 1px solid var(--lg-pill-border) !important;
  box-shadow: var(--lg-pill-shadow) !important;

  /* No "shine" interno */
  text-shadow: none !important;
}

/* Stati attivi coerenti */
button.btn:active,
.btn:active,
.home-btn:active,
#home-logout-btn:active,
#home-account-pill:active,
#account-pill:active, .account-pill:active,
.bp-return-btn:active,
.bp-compare-btn:active,
#bp-compare-toggle:active,
#bp-compare-go:active,
#race-calendar button:active,
.tsb-toggle-btn:active{
  transform: translateY(1px) scale(0.99);
  box-shadow: 0 6px 14px rgba(0,0,0,0.28) !important;
}

/* Tinte "brand" (rosso/giallo/nero) sempre in vetro, senza gradienti */
:root{
  --lg-red-rgb: 204,0,0;
  --lg-yellow-rgb: 253,224,0;
  --lg-dark-rgb: 17,24,39;
  --lg-slate-rgb: 148,163,184;
}

/* ROSSI */
#home-logout-btn,
#home-account-pill,
#account-pill, .account-pill,
.bp-return-btn,
#race-calendar button.has-race{ 
  --lg-pill-bg-rgb: var(--lg-red-rgb);
  --lg-pill-bg-a: 0.32;
  color: #fff !important;
}

/* GIALLI (azioni/confirm) */
#bp-compare-go,
#race-calendar button.selected{ 
  --lg-pill-bg-rgb: var(--lg-yellow-rgb);
  --lg-pill-bg-a: 0.30;
  color: #111827 !important;
}

/* "NEUTRI" (toggle / pillole dati) */
.tsb-toggle-btn,
.test-data-pill,
.race-pill,
#race-calendar button{ 
  --lg-pill-bg-rgb: var(--lg-slate-rgb);
  --lg-pill-bg-a: 0.20;
}

/* Compare toggle "dark" quando non attivo */
#bp-compare-toggle{ 
  --lg-pill-bg-rgb: var(--lg-dark-rgb);
  --lg-pill-bg-a: 0.28;
  color: #fff !important;
}

/* Compare toggle attivo: rosso vetro */
#bp-compare-toggle.active{ 
  --lg-pill-bg-rgb: var(--lg-red-rgb);
  --lg-pill-bg-a: 0.30;
  color: #fff !important;
}

/* Evita che vecchie regole forzino bianco/grigio pieno */
#test-view .test-data-pill,
#test-view .ranking-header .race-pill,
#performance-race-header .race-pill{
  background: rgba(var(--lg-pill-bg-rgb), var(--lg-pill-bg-a)) !important;
  border-color: var(--lg-pill-border) !important;
  box-shadow: var(--lg-pill-shadow) !important;
}

/* ===== BUILD 4.120 – FIX: biker initials + add button solid red ===== */
.biker-initial{
  background: #d40000 !important;
  color: #ffffff !important;
  border: none !important;
  box-shadow: 0 0 0 2px rgba(0,0,0,0.35), 0 10px 20px rgba(0,0,0,0.25) !important;
}
.btn-db-add{
  background: #d40000 !important;
  border: none !important;
  color: #ffffff !important;
}

</style>

<script id="build-inject">
(() => {
  const BUILD = "4.120";
  // Home label
  const hv = document.getElementById("home-version-label") || document.getElementById("app-version");
  if (hv) hv.textContent = BUILD;
  // Legacy nodes
  const av = document.getElementById("app-version");
  if (av) av.textContent = BUILD;
})();
</script>
</body>
</html>
